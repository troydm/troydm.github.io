<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Troydm's Blog]]></title>
  <link href="http://troydm.github.io/atom.xml" rel="self"/>
  <link href="http://troydm.github.io/"/>
  <updated>2017-02-27T23:01:38+04:00</updated>
  <id>http://troydm.github.io/</id>
  <author>
    <name><![CDATA[Dmitry Geurkov]]></name>
    <email><![CDATA[d.geurkov@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Manage Your dotFiles like a Boss]]></title>
    <link href="http://troydm.github.io/blog/2017/02/27/manage-your-dotfiles-like-a-boss/"/>
    <updated>2017-02-27T16:18:50+04:00</updated>
    <id>http://troydm.github.io/blog/2017/02/27/manage-your-dotfiles-like-a-boss</id>
    <content type="html"><![CDATA[<p>TL;DR Writing your own Ruby DSL language to sync and manage your public and private dotfiles</p>

<p>As number of computers I own increased over the years and I couldn&rsquo;t bring myself to get rid of some of the older ones so I thought that it was time to step down and think about management of dotfiles in more centralized, intuitive and automated way, because old ways of just <a href="https://git-scm.com/">git</a> cloning weren&rsquo;t enough anymore.
Now there are systems that are actually tailored over that particular task such as <a href="https://www.gnu.org/software/stow/">GNU Stow</a> and <a href="https://dotfiles.github.io/">some other tools</a> however being a fairly lazy person I thought that writing my own would be a lot more easier and quicker than learning some tool that already existed.
The benefits of writing your own tools are that you don&rsquo;t have to learn them, they will do exactly what you want them to do and you could potentially design them as simple and straightforward as possible from the very start, not mentioning about learning some new technologies while doing something new. The requirements for this particular system were for it to be easily portable over Unix/Linux/BSD/MacOS systems, hassle-free to kick start and straightforward simple to use. I&rsquo;ve decided to develop <a href="https://www.ruby-lang.org/">Ruby</a> based <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> targeting <strong>1.9.3</strong> version of <em>Ruby</em> language as most of the operating systems either provide that version or a newer version and because I&rsquo;ve already had experience developing <em>Ruby</em> based DSL to manage my ssh connections called <a href="https://github.com/troydm/sshc/">sshc</a> which proved to be very portable and easy to use.
Note that I&rsquo;ve also decided to not support Windows operating system as there isn&rsquo;t much benefit or need of doing that as I don&rsquo;t use it or know anyone who would want some dotfiles management system for it.
The result of this endeavor is in my git repo called <a href="https://github.com/troydm/dotcentral/">dotcentral</a> however for learning experience I&rsquo;m going to recreate it step by step for this blog post.
Also note that this repo contains my own dotfiles too alongside <em>Ruby</em> DSL configuration files used to automatically install them. So let&rsquo;s get started from scratch.</p>

<p><img src="https://i.imgur.com/CovRPWQ.png" alt="Akutabe" /></p>

<!-- more -->


<p>The system we are going to build is called <strong>central</strong> so let&rsquo;s create a file called <strong>central</strong> with following two lines and make it an executable using <strong>chmod +x ./central</strong>.
We don&rsquo;t have to specify an <strong>.rb</strong> extension for it as it&rsquo;s an <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a> executable file.
Also we require two standard <em>Ruby</em> modules <strong>erb</strong> and <strong>socket</strong> which we&rsquo;ll use later in our functions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="c1"># encoding: utf-8</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This executable will be used to run specialized Ruby DSL files called configurations each describing some steps central script should take in order to install or configure some tool or dotfile.
Configuration files are usually named as <strong>configuration.rb</strong> but could be named any way you desire.
Common configurations are kept in common directory and private configurations are kept in private one but I also have each environment-specific configurations in their respective hostname based directories with their own <strong>configuration.rb</strong> files. Some applications with more complex dotfile structures like <strong>vim</strong> need more extensive additional steps so I put their configuration in their own directories to keep entire configuration structure simple and intuitive to navigate and manage.
Central script executes top-level <strong>configuration.rb</strong> file which executes all the necessary sub-directory <strong>configuration.rb</strong> files but it can also be used with only specific <strong>configuration.rb</strong> files as an arguments to <em>central</em> script in which case only that particular <strong>configuration.rb</strong> files will be executed.
Here is an top-level tree view of my own dotcentral repository containing my own <strong>dotfiles</strong> and <strong>configuration.rb</strong> files.
Also note some <strong>dotfiles</strong> have an <strong>.erb</strong> extension which I&rsquo;ll explain a little bit later.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.
</span><span class='line'>├── central
</span><span class='line'>├── configuration.rb
</span><span class='line'>└── configurations
</span><span class='line'>    ├── common
</span><span class='line'>    │   ├── bashrc
</span><span class='line'>    │   ├── bashrc.erb
</span><span class='line'>    │   ├── bin
</span><span class='line'>    │   ├── configuration.rb
</span><span class='line'>    │   ├── dircolors
</span><span class='line'>    │   ├── fishrc
</span><span class='line'>    │   ├── fishrc.erb
</span><span class='line'>    │   ├── fonts
</span><span class='line'>    │   ├── gitconfig
</span><span class='line'>    │   ├── gitignore
</span><span class='line'>    │   ├── mc
</span><span class='line'>    │   ├── sshc
</span><span class='line'>    │   ├── tigrc
</span><span class='line'>    │   ├── tmux.conf
</span><span class='line'>    │   ├── urxvt
</span><span class='line'>    │   ├── vifm
</span><span class='line'>    │   ├── vim
</span><span class='line'>    │   ├── vimperator
</span><span class='line'>    │   └── Xresources
</span><span class='line'>    ├── private
</span><span class='line'>    │   ├── common
</span><span class='line'>    │   ├── configuration.rb
</span><span class='line'>    │   ├── server
</span><span class='line'>    │   ├── troymac.local
</span><span class='line'>    │   ├── troynas
</span><span class='line'>    │   └── troystick
</span><span class='line'>    ├── server
</span><span class='line'>    │   ├── bashrc.erb
</span><span class='line'>    │   ├── bin
</span><span class='line'>    │   ├── configuration.rb
</span><span class='line'>    │   └── tmux.conf.erb
</span><span class='line'>    ├── troymac.local
</span><span class='line'>    │   ├── bashrc
</span><span class='line'>    │   └── configuration.rb
</span><span class='line'>    ├── troynas
</span><span class='line'>    │   ├── bashrc
</span><span class='line'>    │   ├── bashrc.erb
</span><span class='line'>    │   ├── bin
</span><span class='line'>    │   ├── configuration.rb
</span><span class='line'>    │   ├── tmux.conf
</span><span class='line'>    │   └── tmux.conf.erb
</span><span class='line'>    └── troystick
</span><span class='line'>        ├── compton.conf
</span><span class='line'>        ├── configuration.rb
</span><span class='line'>        ├── i3
</span><span class='line'>        ├── i3status
</span><span class='line'>        └── redshift.conf</span></code></pre></td></tr></table></div></figure>


<p>As we need to be aware of our environment or more precisely a hostname where the script is running let&rsquo;s create a function called <strong>hostname</strong>.
This function will be used in our configuration files.
Also we might want to execute different scenarios based on which operating system we are running so let&rsquo;s add an <strong>os</strong> function to easily determine the operating system name.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># get hostname</span>
</span><span class='line'><span class="k">def</span> <span class="nf">hostname</span>
</span><span class='line'>  <span class="no">Socket</span><span class="o">.</span><span class="n">gethostname</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># get operating system</span>
</span><span class='line'><span class="k">def</span> <span class="nf">os</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">RUBY_PLATFORM</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;linux&#39;</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">RUBY_PLATFORM</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;darwin&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;osx&#39;</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">RUBY_PLATFORM</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;freebsd&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;freebsd&#39;</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">RUBY_PLATFORM</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;solaris&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;solaris&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we need a way to run our <strong>configuration.rb</strong> files so we need to be aware of our working directory and be able to get absolute file path and file folder name.
So let&rsquo;s define functions for this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">pwd</span>
</span><span class='line'>  <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">chdir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">file_exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="o">.</span><span class="n">readable?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">dir_exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">file_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to <strong>run</strong> our configuration file we need to temporally <strong>chdir</strong> into it&rsquo;s folder, load the <em>Ruby</em> file and then <strong>chdir</strong> back into previous working directory.
Also in some cases we might want to optionally run configuration files only if they exists so let&rsquo;s also define <strong>run_if_exists</strong> function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">()</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Running configuration: &quot;</span><span class="o">+</span><span class="n">file</span>
</span><span class='line'>  <span class="n">file_cwd</span> <span class="o">=</span> <span class="n">file_dir</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="n">chdir</span> <span class="n">file_cwd</span>
</span><span class='line'>  <span class="nb">load</span> <span class="n">file</span>
</span><span class='line'>  <span class="n">chdir</span> <span class="n">cwd</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">run_if_exists</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">file_exists?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>    <span class="n">run</span> <span class="n">file</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to run our configurations we are either going to execute the top-level one or the ones provided as arguments to <em>central</em> script.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="no">ARGV</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">configuration</span><span class="o">|</span> <span class="n">run</span> <span class="n">configuration</span> <span class="p">}</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">run</span> <span class="s1">&#39;configuration.rb&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also since we need not only our common configuration but also our private one which is kept in a separate <strong>git</strong> repository we might as well add a capability to git clone/pull any repository we want from a configuration file.
But before doing that let&rsquo;s define a special function called <strong>sudo</strong> which will run any shell command with sudo prefix if command fails to run due to <strong>permission denied</strong> error.
This works only if you have sudo configured without a password and your configuration needs to access some files/executables which need <em>root</em> user privileges but isn&rsquo;t absolutely necessary if you access only your own files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sudo</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">sudo</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">sudo</span>
</span><span class='line'>    <span class="n">sudo</span> <span class="o">=</span> <span class="s1">&#39;sudo &#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sudo</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="n">sudo</span><span class="o">+</span><span class="n">command</span>
</span><span class='line'>  <span class="n">out</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sb"> 2&gt;&amp;1`</span>
</span><span class='line'>  <span class="c1"># removing line feed</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># removing carriage return</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">ord</span> <span class="o">==</span> <span class="mi">13</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="s1">&#39;permission denied&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">sudo</span>
</span><span class='line'>      <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Couldn&#39;t execute </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2"> due to permission denied</span><span class="se">\n</span><span class="s2">run central with sudo privileges&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">out</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s add <strong>git</strong> function to clone any repository we might require and pull any repository already cloned to keep everything up-to date.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">git</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">dir_exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dir_exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/.git&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">()</span>
</span><span class='line'>    <span class="n">chdir</span> <span class="n">path</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;git pull&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">out</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span> <span class="s2">&quot;already up-to-date&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">out</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Git repository pulled: </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> → </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">chdir</span> <span class="n">cwd</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;git clone </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">out</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Git repository cloned: </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> → </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before using <strong>git</strong> we need to check if it&rsquo;s actually installed in the system.
We might as well add checks for some other tools like <strong>file</strong>, <strong>grep</strong>, <strong>curl</strong> and <strong>readlink</strong> as we&rsquo;ll need them later in order to manage our configurations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># check all required tools</span>
</span><span class='line'><span class="k">def</span> <span class="nf">checkTool</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">check</span><span class="p">)</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">check</span><span class="si">}</span><span class="s2"> 2&gt;&amp;1 1&gt;/dev/null&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;command not found&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> not found, please install it to use central&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="s1">&#39;file --version&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span><span class="s1">&#39;grep --version&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span><span class="s1">&#39;ln --version&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;readlink&#39;</span><span class="p">,</span><span class="s1">&#39;readlink --version&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="s1">&#39;git --version&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">checkTool</span><span class="p">(</span><span class="s1">&#39;curl&#39;</span><span class="p">,</span><span class="s1">&#39;curl --version&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now right about time for you to wonder how is this all used?
Following example is my top-level <strong>configuration.rb</strong> file.
First I git clone/pull my own private configuration repository.
Next I run it&rsquo;s <strong>configuration.rb</strong> file followed by running <strong>common</strong> <strong>configuration.rb</strong> file.
And finally I run <strong>hostname</strong> based configuration only if it exists for current host.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">git</span> <span class="s1">&#39;git@ubuntusrv:troydm/dotcentralprivate.git&#39;</span><span class="p">,</span> <span class="s1">&#39;configurations/private&#39;</span>
</span><span class='line'><span class="n">run</span> <span class="s1">&#39;configurations/private/configuration.rb&#39;</span>
</span><span class='line'><span class="n">run</span> <span class="s1">&#39;configurations/common/configuration.rb&#39;</span>
</span><span class='line'><span class="n">run_if_exists</span> <span class="s2">&quot;configurations/</span><span class="si">#{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">/configuration.rb&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s try adding a symlink capability to our DSL in order to install <a href="https://github.com/troydm/sshc">sshc</a> which I use everywhere.
So we need a function to manage symlinks and some minor functions to check if symlink exists and which path it points to.
So if file/dir exists in place where we want to create a symlink the system will stop with <strong>exit 1</strong> and <strong>stderr</strong> output will contain error description.
Otherwise we check the symlink path and if it&rsquo;s not valid one we delete it and create a symlink with specified new path.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">symlink?</span><span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">symlink</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">symlink_path</span><span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;readlink </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">abs</span><span class="p">(</span><span class="n">symlink</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">symlink</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="n">to</span><span class="p">)</span>
</span><span class='line'>  <span class="n">from</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
</span><span class='line'>  <span class="n">to</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">symlink?</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">symlink_path</span><span class="p">(</span><span class="n">from</span><span class="p">)</span> <span class="o">!=</span> <span class="n">to</span>
</span><span class='line'>      <span class="n">rm</span> <span class="n">from</span>
</span><span class='line'>      <span class="n">symlink</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">file_exists?</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;File </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="s2"> exists in place of symlink...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">dir_exists?</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Directory </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="s2"> exists in place of symlink...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;ln -s </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Created symlink: </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="s2"> → </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is how it&rsquo;s used in my common <strong>configuration.rb</strong> to install sshc and make a symlink to it&rsquo;s executable in <strong>bin</strong> folder which I&rsquo;ll add to environment <strong>PATH</strong> via bashrc later.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># install sshc</span>
</span><span class='line'><span class="n">git</span> <span class="s1">&#39;https://github.com/troydm/sshc.git&#39;</span><span class="p">,</span> <span class="s1">&#39;sshc&#39;</span>
</span><span class='line'><span class="n">symlink</span> <span class="s1">&#39;bin/sshc&#39;</span><span class="p">,</span> <span class="s1">&#39;sshc/sshc&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s add some more functions to our Ruby DSL to <strong>mkdir</strong> directories, <strong>rm</strong> files/directories, <strong>touch</strong> files and <strong>chmod</strong> files/directories.
You can easily add <strong>chown</strong> function too if you need it.
We&rsquo;ll need all these functions later in our configurations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">dir_exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Created directory: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">rm</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">recursive</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">recursive</span>
</span><span class='line'>    <span class="n">recursive</span> <span class="o">=</span> <span class="s1">&#39;-R &#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">recursive</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;rm -</span><span class="si">#{</span><span class="n">recursive</span><span class="si">}</span><span class="s2">f </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Removed file: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">file_exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;touch </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Touched file: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">permissions</span><span class="p">,</span><span class="n">recursive</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">recursive</span>
</span><span class='line'>    <span class="n">recursive</span> <span class="o">=</span> <span class="s1">&#39;-R &#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">recursive</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;chmod </span><span class="si">#{</span><span class="n">recursive</span><span class="si">}#{</span><span class="n">permissions</span><span class="si">}</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need <strong>curl</strong> function in order to download files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;curl -s </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="vg">$?</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Couldn&#39;t download file from </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="n">output</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Downloaded </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> → </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have <strong>curl</strong> and <strong>chmod</strong> we can easily install <a href="https://beyondgrep.com/">ack</a> via our configuration file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># install ack</span>
</span><span class='line'><span class="n">curl</span> <span class="s1">&#39;http://beyondgrep.com/ack-2.14-single-file&#39;</span><span class="p">,</span> <span class="s1">&#39;bin/ack&#39;</span>
</span><span class='line'><span class="n">chmod</span> <span class="s1">&#39;bin/ack&#39;</span><span class="p">,</span> <span class="s1">&#39;0755&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we&rsquo;ll need <strong>ls</strong> function in our <em>Ruby</em> DSL which will support multiple options via second <strong>Hash</strong> type argument such as filtering of file/directory names based on <strong>grep</strong> pattern and listing either only files or directories as well as including dotfiles if necessary.
Quite complicated function indeed, however this is necessary because of how we usually need to use it in our configurations depending on whenever we need to list only files or directories or some specific files or directories based on some predefined pattern.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:dotfiles</span><span class="o">]</span>
</span><span class='line'>    <span class="n">dotfiles</span> <span class="o">=</span> <span class="s1">&#39;-a &#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">dotfiles</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;ls -1 </span><span class="si">#{</span><span class="n">dotfiles</span><span class="si">}</span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:grep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:grep</span><span class="o">].</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot; | grep </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:grep</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="s1">&#39;no such file or directory&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Couldn&#39;t ls directory </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">ls</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">dir</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:dir</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dir</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:dir</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:file</span><span class="p">)</span>
</span><span class='line'>    <span class="n">file</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:file</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">dir</span>
</span><span class='line'>    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">keep_if</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">directory?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">file</span>
</span><span class='line'>    <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">keep_if</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">ls</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the help of <strong>ls</strong> now we can finally install Powerline fonts.
The code below clones git repository and installs all <strong>.ttf</strong> and <strong>.otf</strong> symlinks into either ~/.fonts or ~/Library/Fonts directory based on which operating system you are on.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># install Powerline fonts on OSX and Linux only</span>
</span><span class='line'><span class="k">if</span> <span class="n">os</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span>
</span><span class='line'>    <span class="n">install_fontsdir</span> <span class="o">=</span> <span class="s1">&#39;~/.fonts&#39;</span>
</span><span class='line'><span class="k">elsif</span> <span class="n">os</span> <span class="o">==</span> <span class="s1">&#39;osx&#39;</span>
</span><span class='line'>    <span class="n">install_fontsdir</span> <span class="o">=</span> <span class="s1">&#39;~/Library/Fonts&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">if</span> <span class="n">install_fontsdir</span>
</span><span class='line'>  <span class="n">git</span> <span class="s1">&#39;https://github.com/powerline/fonts.git&#39;</span><span class="p">,</span> <span class="s1">&#39;fonts&#39;</span>
</span><span class='line'>  <span class="n">mkdir</span> <span class="n">install_fontsdir</span>
</span><span class='line'>  <span class="n">ls</span><span class="p">(</span><span class="s1">&#39;fonts&#39;</span><span class="p">,{</span><span class="ss">:file</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">})</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">fontdir</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ls</span><span class="p">(</span><span class="s2">&quot;fonts/</span><span class="si">#{</span><span class="n">fontdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,{</span><span class="ss">:grep</span> <span class="o">=&gt;</span> <span class="s1">&#39;.[ot]tf&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">font</span><span class="o">|</span>
</span><span class='line'>          <span class="n">symlink</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">install_fontsdir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">font</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;fonts/</span><span class="si">#{</span><span class="n">fontdir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">font</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point we need a way to manage some differences that might arise from different operating systems and deployment path inside our dotfiles itself.
For this we need some kind of templating system which will allow us to include or dynamically generate files when processing configuration files.
Fortunately <em>Ruby</em> has <a href="http://www.stuartellis.name/articles/erb/">erb</a> templating system so we don&rsquo;t have to write our own.
This will allow us to generate dotfiles on the fly as well as include content of some files into another ones.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">erb</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">output_file</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="s1">&#39;.erb&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">output_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">4</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">output_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">file_exists?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">result</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="o">==</span> <span class="n">output</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Processed erb </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> → </span><span class="si">#{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Couldn&#39;t process erb file </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to include files we&rsquo;ll need a small function to be able to easily read them.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">file_exists?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Couldn&#39;t read file </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">...&quot;</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is for example how I use this function to centrally manage my tmux configuration in <strong>tmux.conf.erb</strong> file.
It includes common <strong>tmux.conf</strong> into my host-specific <strong>tmux.conf.erb</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">read</span> <span class="s1">&#39;../common/tmux.conf&#39;</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Left status bar</span>
</span><span class='line'><span class="n">set</span> <span class="o">-</span><span class="n">g</span> <span class="n">status</span><span class="o">-</span><span class="n">left</span> <span class="s2">&quot; &quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Right status bar</span>
</span><span class='line'><span class="n">set</span> <span class="o">-</span><span class="n">g</span> <span class="n">status</span><span class="o">-</span><span class="n">interval</span> <span class="mi">1</span>
</span><span class='line'><span class="n">set</span> <span class="o">-</span><span class="n">g</span> <span class="n">status</span><span class="o">-</span><span class="n">right</span><span class="o">-</span><span class="n">length</span> <span class="mi">200</span>
</span></code></pre></td></tr></table></div></figure>


<p>This <strong>tmux.conf.erb</strong> file is later processed from <strong>configuration.rb</strong> file resulting into <strong>tmux.conf</strong> file being generated.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">erb</span> <span class="s1">&#39;tmux.conf.erb&#39;</span>
</span><span class='line'><span class="n">symlink</span> <span class="s1">&#39;~/.tmux.conf&#39;</span><span class="p">,</span> <span class="s1">&#39;tmux.conf&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally to manage shell configuration I want to source my bashrc into ~/.bashrc file in an automated way.
To do this we&rsquo;ll create a function called <strong>source</strong>. It&rsquo;ll add source line to any shell configuration file if it isn&rsquo;t already added there.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>  <span class="n">source</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>  <span class="n">source_line</span> <span class="o">=</span> <span class="s2">&quot;source </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">out</span> <span class="o">=</span> <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;grep -Fx &#39;</span><span class="si">#{</span><span class="n">source_line</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;echo &#39;</span><span class="si">#{</span><span class="n">source_line</span><span class="si">}</span><span class="s2">&#39; &gt;&gt; </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Added source </span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="s2"> line to </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now finally I can use this function to source my configuration specific <strong>bashrc</strong> file which is generated from <strong>bashrc.erb</strong> into <strong>~/.bashrc</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">erb</span> <span class="s1">&#39;bashrc.erb&#39;</span>
</span><span class='line'><span class="n">source</span> <span class="s1">&#39;~/.bashrc&#39;</span><span class="p">,</span> <span class="s1">&#39;bashrc&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it folks this how I manage my dotfiles mess. I hope you learned something new today. Have a good coding time!</p>

<p><img src="https://i.imgur.com/45SwyJm.png" alt="Azazel-san" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Writing Parser Combinator Library in Clojure]]></title>
    <link href="http://troydm.github.io/blog/2016/04/11/writing-parser-combinator-library-in-clojure/"/>
    <updated>2016-04-11T23:23:41+04:00</updated>
    <id>http://troydm.github.io/blog/2016/04/11/writing-parser-combinator-library-in-clojure</id>
    <content type="html"><![CDATA[<p>TL;DR Writing parser combinator library in Clojure from scratch</p>

<p>Recently I&rsquo;ve had an fortunate opportunity to participate in a commercial project that was heavy on parsing and I&rsquo;ve decided to use <a href="http://clojure.org/">Clojure</a> as my main tool for doing it.
As you might all know <strong>Clojure</strong> is not new to the game and is quite mature functional programming language with a hidden power of <a href="https://en.wikipedia.org/wiki/Lisp_%28programming_language%29">Lisp</a>. One of the distinct features of <strong>Clojure</strong> which I personally adore is nrepl and <a href="https://en.wikipedia.org/wiki/Interactive_programming">Interactive Programming</a> incremental development style which it cultivates. This is by no means something new, <a href="https://en.wikipedia.org/wiki/Common_Lisp">Common Lisp</a> has it via <em>slime/swank</em>, some of <a href="https://en.wikipedia.org/wiki/Scheme_%28programming_language%29">Scheme</a> implementations have <em>geiser</em> support and almost all Smalltalk variants could be considered as full interactive programming environments, one notable example being <a href="http://pharo.org/">Pharo</a>.
There are some more specialized interactive programming environments like <a href="https://processing.org/">Processing</a> and <a href="https://supercollider.github.io/">SuperCollider</a> which deal with either sound or visual or even both but today we&rsquo;ll be talking about parsing and all things related instead.
Before I&rsquo;ll start explaining what we are actually trying to build I would like to introduce you to a really nice open source library that I&rsquo;ve successfully used in a commercial project I&rsquo;ve mentioned before, called <a href="https://github.com/blancas/kern">kern</a>. But as all things good there is always some value in trying to build your own even better, at least for me it was an insightful journey. So yeah as title says we&rsquo;ll be building parser combinator library in <strong>Clojure</strong> just to learn a thing or two but solely just for fun. The full source for impatient ones is in my <a href="https://github.com/troydm/ccp/">ccp</a> repo.
So let&rsquo;s get started then.</p>

<p><img src="http://i.imgur.com/JG55prH.png" alt="Violin Loli" /></p>

<!--more-->


<p>I&rsquo;m no good with long explanations and to keep things simple I&rsquo;ll start with two references that I&rsquo;ve heavily used while building <em>ccp</em>. One is being <em>kern</em> as you&rsquo;ve guessed it and the second one is <a href="https://wiki.haskell.org/Parsec">parsec</a>. Both are excellent parser combinator libraries and are good references for self-study. Before we&rsquo;ve delve into what is parser combinator I would like to talk about a simple concept of a <em>parser</em>. Now what is a <em>parser</em>? Something that parses a thing and returns result as you&rsquo;ve guessed it, right?! Wait, isn&rsquo;t that a function of a &ndash;> b. Remarkable similarity, indeed.
A function takes some arbitrary data <em>a</em>, parsers it and returns result <em>b</em>. Wait, what if it can&rsquo;t parse data and return result? Then we&rsquo;ll return an error instead of parsing result. In <em>Haskell</em> our type definition for parser would be something like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">data</span> <span class="kt">Parser</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kt">Parser</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Either</span> <span class="kt">String</span> <span class="n">b</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As some you of you may have noticed our <em>Parser</em> is actually a <em>ReaderT a Either String b</em> monad transformer in disguise. As we are parsing <em>a</em> we&rsquo;ve also need to constantly mutate it as it&rsquo;s being parsed so probably we are mistaken and we actually need an <em>StateT a Either String b</em> monad transformer instead, but wait,
aren&rsquo;t we going to build everything in <strong>Clojure</strong>? Yeah, right so we don&rsquo;t need any strict type definitions.
We&rsquo;ll just use simple function that takes data as input and returns parsing result and will mutate state of input data as we go. And for errors will have some special <em>deftype</em> <strong>ParserError</strong>. Any parser that can&rsquo;t parse data will return <strong>ParserError</strong> with detailed error message description.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">ParserError</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">state</span> <span class="nv">msg</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>What is this <em>ps</em> and <em>state</em>? Patience my friend I&rsquo;ll explain it later. First let&rsquo;s talk about data we are going to parse. What should it be? Well it can be literally anything but we need
some contract in order to parse it bit by bit right? So let&rsquo;s introduce a <em>protocol</em> called <strong>ParseStream</strong>. Any type that implements our <strong>ParseStream</strong> protocol is good enough to be an input data for our parser. We can go back and forth element by element traversing this data stream using <em>next-elem</em>, <em>prev-elem</em> and <em>current-elem</em> methods.
Our <strong>ParseStream</strong> implementors need to track state and mutate it as we go over the data with parsers. This is actually a data + state concept. As we are writing everything in Clojure, we&rsquo;ll just use <em>deftype</em> with mutable state variable and data. I know about dangers of using mutable variables but as we are only giving limited access to our type via strict protocol there is no way our parser can harm our inner <strong>ParseStream</strong> state in any way, so we are kinda safe. In order to be able to produce a <strong>ParseStream</strong> out of any data we&rsquo;ll introduce another protocol called <strong>ParseStreamFactory</strong>.
Any type/object that implements this protocol will be convertible into a valid <strong>ParseStream</strong>. As any <strong>ParseStream</strong> tracks state it can reset itself to initial position using <em>reset</em> method, and record and restore it&rsquo;s state using <em>get-state</em> and <em>restore-state</em> methods. We can also check if it&rsquo;s state is initial or ending using <em>start-state?</em> and <em>end-state?</em> methods.
Actually our <strong>ParseStream</strong> is just some good old <a href="https://en.wikipedia.org/wiki/Iterator">Iterator</a> pattern from Object-Orient world.
We are combining Functional and Object-Oriented programming using <strong>Clojure</strong> in order to produce the most elegant solution to the given problem at hand. This method of programming is quite powerful, best of both worlds indeed. Now you know what <em>ps</em> and <em>state</em> in <strong>ParserError</strong> is, it&rsquo;s <strong>ParseStream</strong> data and it&rsquo;s <em>state</em> when the <strong>ParserError</strong> occurred. Also we would like to have a human readable description of parser error so our <strong>ParseStream</strong> will have <em>describe-error</em> method too. We&rsquo;ll also define some helper methods to work with <strong>ParserError</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">ParseStreamFactory</span>
</span><span class='line'>  <span class="s">&quot;A parse stream factory protocol&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">ParseStreamCharSequenceFactory</span>
</span><span class='line'>  <span class="s">&quot;A parse stream char sequence factory protocol&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">char-sequence</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">ParseStream</span>
</span><span class='line'>  <span class="s">&quot;A parse stream protocol used by parser&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">reset</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">current-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">prev-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">next-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">get-state</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">restore-state</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">state-changed?</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">start-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">end-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">])</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">describe-error</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">pe</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">ParserError</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">state</span> <span class="nv">msg</span><span class="p">]</span>
</span><span class='line'>  <span class="nv">Object</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">toString</span> <span class="p">[</span><span class="nv">self</span><span class="p">]</span> <span class="p">(</span><span class="nf">describe-error</span> <span class="nv">ps</span> <span class="nv">self</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parser-error</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">msg</span><span class="p">]</span> <span class="p">(</span><span class="nf">ParserError.</span> <span class="nv">ps</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">msg</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parser-error-stream</span> <span class="p">[</span><span class="nv">pe</span><span class="p">]</span> <span class="p">(</span><span class="nf">.ps</span> <span class="nv">pe</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parser-error-state</span> <span class="p">[</span><span class="nv">pe</span><span class="p">]</span> <span class="p">(</span><span class="nf">.state</span> <span class="nv">pe</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parser-error-message</span> <span class="p">[</span><span class="nv">pe</span><span class="p">]</span> <span class="p">(</span><span class="nf">.msg</span> <span class="nv">pe</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parser-error?</span> <span class="p">[</span><span class="nv">pe</span><span class="p">]</span> <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">type</span> <span class="nv">pe</span><span class="p">)</span> <span class="nv">ParserError</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define String implementation of <strong>ParseStream</strong>. Our <strong>StringParseStream</strong> will go character by character incrementing/decrementing indexed position <em>p</em>.
The code is pretty straightforward. We just save state of parse stream into index position starting at <em>-1</em> using <em>unsynchronized-mutable</em> variable <em>p</em>.
We don&rsquo;t need any thread-safety as our parse stream is guaranteed to be used only by one thread. Also in order to describe error we need to correctly inform our parsing library user about exact location in String where that error occurred. For this we use private function <em>line-col</em> which counts lines and columns and returns exact line and column number of that index position.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">line-col</span>
</span><span class='line'> <span class="s">&quot;find out line/column at position p in String s&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">s</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">len</span> <span class="p">(</span><span class="nf">.length</span> <span class="nv">s</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">p</span> <span class="nv">p</span> <span class="nv">l</span> <span class="mi">1</span> <span class="nv">c</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt;= </span><span class="nv">p</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="nv">l</span> <span class="o">~</span><span class="nv">c</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">p</span> <span class="nv">len</span><span class="p">)</span>
</span><span class='line'>     <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="nv">l</span> <span class="o">~</span><span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="nv">c</span><span class="p">))</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">.charAt</span> <span class="nv">s</span> <span class="nv">p</span><span class="p">)</span> <span class="sc">\n</span><span class="nv">ewline</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">l</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">l</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">c</span> <span class="mi">1</span><span class="p">))))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">StringParseStream</span> <span class="p">[</span><span class="o">^</span><span class="ss">:unsynchronized-mutable</span> <span class="nv">p</span> <span class="nv">s</span><span class="p">]</span>
</span><span class='line'> <span class="nv">ParseStream</span>
</span><span class='line'> <span class="p">(</span><span class="nf">reset</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="mi">-1</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">current-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">end-state?</span> <span class="nv">ps</span><span class="p">))</span> <span class="nv">nil</span> <span class="p">(</span><span class="nf">.charAt</span> <span class="nv">s</span> <span class="nv">p</span><span class="p">)))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">prev-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">current-elem</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">next-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">end-state?</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">current-elem</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">get-state</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">restore-state</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">st</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt;= </span><span class="nv">st</span> <span class="p">(</span><span class="nf">.length</span> <span class="nv">s</span><span class="p">)))</span> <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="nv">st</span><span class="p">))</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">state-changed?</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">]</span> <span class="p">(</span><span class="nb">not= </span><span class="nv">st</span> <span class="nv">p</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">start-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nb">= </span><span class="mi">-1</span> <span class="nv">p</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">end-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nb">= </span><span class="nv">p</span> <span class="p">(</span><span class="nf">.length</span> <span class="nv">s</span><span class="p">)))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">describe-error</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">pe</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">l</span> <span class="nv">c</span><span class="p">]</span> <span class="p">(</span><span class="nf">line-col</span> <span class="nv">s</span> <span class="p">(</span><span class="nf">parser-error-state</span> <span class="nv">pe</span><span class="p">))]</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">str </span><span class="s">&quot;expecting &quot;</span> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="nv">pe</span><span class="p">)</span> <span class="s">&quot; on line &quot;</span> <span class="nv">l</span> <span class="s">&quot; col &quot;</span> <span class="nv">c</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s implement the same but for any arbitrary <strong>Clojure</strong> sequence. Note how <em>describe-error</em> method differs compared to <strong>StringParseStream</strong> implementation.
Rest of the code is almost exactly the same except that we are using sequence related functions instead of <em>String</em> related ones.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">SequenceParseStream</span> <span class="p">[</span><span class="o">^</span><span class="ss">:unsynchronized-mutable</span> <span class="nv">p</span> <span class="nv">s</span><span class="p">]</span>
</span><span class='line'> <span class="nv">ParseStream</span>
</span><span class='line'> <span class="p">(</span><span class="nf">reset</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="mi">-1</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">current-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">end-state?</span> <span class="nv">ps</span><span class="p">))</span> <span class="nv">nil</span> <span class="p">(</span><span class="nb">nth </span><span class="nv">s</span> <span class="nv">p</span><span class="p">)))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">prev-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">current-elem</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">next-elem</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">end-state?</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">current-elem</span> <span class="nv">ps</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">get-state</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">restore-state</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">st</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt;= </span><span class="nv">st</span> <span class="p">(</span><span class="nb">count </span><span class="nv">s</span><span class="p">)))</span> <span class="p">(</span><span class="nf">set!</span> <span class="nv">p</span> <span class="nv">st</span><span class="p">))</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">state-changed?</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">st</span><span class="p">]</span> <span class="p">(</span><span class="nb">not= </span><span class="nv">st</span> <span class="nv">p</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">start-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nb">= </span><span class="mi">-1</span> <span class="nv">p</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">end-state?</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nb">= </span><span class="nv">p</span> <span class="p">(</span><span class="nb">count </span><span class="nv">s</span><span class="p">)))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">describe-error</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">pe</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">p</span> <span class="p">(</span><span class="nf">parser-error-state</span> <span class="nv">pe</span><span class="p">)]</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">str </span><span class="s">&quot;expecting &quot;</span> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="nv">pe</span><span class="p">)</span> <span class="s">&quot; on index &quot;</span> <span class="nv">p</span> <span class="s">&quot; in sequence, but got: &quot;</span> <span class="p">(</span><span class="nb">nth </span><span class="nv">s</span> <span class="nv">p</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in order for most types to be convertible into <em>ParseStream</em> we need to extend them to implement <strong>ParseStreamFactory</strong> protocol.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">String</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">StringParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">java.util.List</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">SequenceParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">clojure.lang.PersistentVector</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">SequenceParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">clojure.lang.PersistentVector$TransientVector</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">SequenceParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">clojure.lang.PersistentList</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">SequenceParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-type</span> <span class="nv">clojure.lang.PersistentList$EmptyList</span>
</span><span class='line'>    <span class="nv">ParseStreamFactory</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parse-stream</span> <span class="p">[</span><span class="nv">d</span><span class="p">]</span> <span class="p">(</span><span class="nf">SequenceParseStream.</span> <span class="mi">-1</span> <span class="nv">d</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we&rsquo;ll start writing our sample parsers I would like to introduce an macro that will help us in minimizing our code needed for writing almost any parser.
This macro is called <em>parsed</em> and is simply a let + if combination that gives us ability to define a variable <em>e</em> initialized to some parsed value <em>p</em>, check if this value is
parser error or not and depending on that return either <em>t</em> or <em>f</em> expression.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">parsed</span> <span class="p">[</span><span class="nv">e</span> <span class="nv">p</span> <span class="nv">t</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">~</span><span class="nv">e</span> <span class="o">~</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'>       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="o">~</span><span class="nv">e</span><span class="p">)</span> <span class="o">~</span><span class="nv">f</span> <span class="o">~</span><span class="nv">t</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s define our first parser generating function called <em>satisfy</em>.
Given a predicate function <em>pd</em> and <em>m</em> message it will give back a parser that will get next element from <strong>ParseStream</strong>, check if it satisfies the predicate.
If it does it we&rsquo;ll return it, otherwise it will return <strong>ParserError</strong> with message <em>m</em>.
Note how we would like to support two kinds of predicate functions, with 1 argument and with
2 arguments second being actual <strong>ParseStream</strong> itself. To distiguish those two we&rsquo;ll use another private function called <em>n-args</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">n-args</span>
</span><span class='line'> <span class="s">&quot;return number of arguments function can take&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">f</span> <span class="nb">class </span><span class="nv">.getDeclaredMethods</span> <span class="nb">first </span><span class="nv">.getParameterTypes</span> <span class="nv">alength</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">satisfy</span>
</span><span class='line'> <span class="s">&quot;satisfy predicate pd, if not return failure with m&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">pd</span> <span class="nv">m</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">n-args</span> <span class="nv">pd</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">pd</span> <span class="nv">e</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>             <span class="nv">e</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="nv">m</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">pd</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>             <span class="nv">e</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="nv">m</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note how <em>satisfy</em> is both suitable for String streams as well as sequence streams. Before we&rsquo;ll define some simple String stream oriented parsers
let&rsquo;s define one more crucial function that is necessary to define our parsers. What this function does is that it takes a parser <em>p</em>,
saves <strong>ParseStream</strong> <em>ps</em>&rsquo;s state into <em>st</em> variable, applies <em>p</em> to <em>ps</em>, checks if result is <strong>ParserError</strong>, and if it is, it restores <em>ps</em>&rsquo;s state
to value it had before <em>p</em>&rsquo;s application. Now simply put this function allows us to convert any parser that might fail into a parser that doesn&rsquo;t affects
<strong>ParseStream</strong> in case of failure and restores it&rsquo;s state to the way it was before parser was applied to it.
We can also define <em>restore</em> parser transformer that will restore stream every time.
This parser transformers are actually called a parser combinator. So what is parser combinator? It&rsquo;s a function that takes as an input
one or many parser functions and returns a parser that is result of combining those parsers. By combining we actually mean that parser combinator introduces an behaviour
over already defined parser behaviour. This allows us to stack/combine parsers like a lego pieces and it&rsquo;s actually a very very powerful concept.
In essence this concept is actually the real corner stone of functional programming and it&rsquo;s conceptually heart of power.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">rewind</span>
</span><span class='line'> <span class="s">&quot;try parsing p and restore stream state on failure&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">restore-state</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">e</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">restore</span>
</span><span class='line'> <span class="s">&quot;try parsing p and restore stream state afterwards&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">restore-state</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)</span> <span class="nv">e</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we aren&rsquo;t limited to parser(s) as input for a parser combinator as we can have any kind of value that drives resulting behaviour of our parser.
In that essence the function <em>satisfy</em> that we&rsquo;ve defined before is also an parser combinator. Okey zen reached, let&rsquo;s move on already!
Now that we know what parser combinators actually are let&rsquo;s define some simple parser combinator called <em>chr</em> that can give us parser for any specific character.
We also define <em>satisfy-char</em> parser combinator that is actually used to be sure that value we are trying to parse is of character type.
It&rsquo;s not strictly necessary for <em>chr</em> but we&rsquo;ll define it anyway.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">satisfy-char</span>
</span><span class='line'>  <span class="s">&quot;satisfy predicate pd for character, if not return failure with m&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">pd</span> <span class="nv">m</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">satisfy</span> <span class="o">#</span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">char?</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">pd</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">m</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">chr</span>
</span><span class='line'>  <span class="s">&quot;expect character c&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">c</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="nv">%</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nb">pr-str </span><span class="nv">c</span><span class="p">)</span> <span class="s">&quot; character&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now using those parser combinators we can define some commonly used parsers</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">digit</span>
</span><span class='line'>  <span class="s">&quot;expect digit character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nf">Character/isDigit</span> <span class="nv">%</span><span class="p">)</span> <span class="s">&quot;digit&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">ws</span>
</span><span class='line'>  <span class="s">&quot;expect whitespace character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nf">Character/isWhitespace</span> <span class="nv">%</span><span class="p">)</span> <span class="s">&quot;whitespace&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">alpha</span>
</span><span class='line'>  <span class="s">&quot;expect alphanum character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">Character/isLetter</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">Character/isDigit</span> <span class="nv">%</span><span class="p">))</span> <span class="s">&quot;alphanum&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">letter</span>
</span><span class='line'>  <span class="s">&quot;expect letter character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nf">Character/isLetter</span> <span class="nv">%</span><span class="p">)</span> <span class="s">&quot;letter&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">upper</span>
</span><span class='line'>  <span class="s">&quot;expect uppercase character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nf">Character/isUpperCase</span> <span class="nv">%</span><span class="p">)</span> <span class="s">&quot;uppercase&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">lower</span>
</span><span class='line'>  <span class="s">&quot;expect lowercase character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy-char</span> <span class="o">#</span><span class="p">(</span><span class="nf">Character/isLowerCase</span> <span class="nv">%</span><span class="p">)</span> <span class="s">&quot;lowercase&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">any-char</span>
</span><span class='line'>  <span class="s">&quot;expect any character&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy</span> <span class="nv">char?</span> <span class="s">&quot;any character&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try using parsers and parser combinators that we&rsquo;ve defined so far.
For this we&rsquo;ll use <em>parse</em> function that is actually a helper to convert
input data to <strong>ParseStream</strong> if it isn&rsquo;t already a <strong>ParseStream</strong> and apply <em>p</em> to it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">parse</span>
</span><span class='line'> <span class="s">&quot;parse d data using p and return result, resets parse stream&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span> <span class="nv">d</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">p</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">satisfies?</span> <span class="nv">ParseStream</span> <span class="nv">d</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">reset</span> <span class="nv">d</span><span class="p">)</span> <span class="nv">d</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">parse-stream</span> <span class="nv">d</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now some simple tests</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">chr</span> <span class="sc">\a</span><span class="p">)</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\a</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">chr</span> <span class="sc">\b</span><span class="p">)</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\b</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="nv">ws</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="nv">ws</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="o">#</span><span class="nv">object</span><span class="p">[</span><span class="nv">ccp.core.ParserError</span> <span class="mi">0</span><span class="nv">x95c543a</span> <span class="s">&quot;expecting whitespace on line 1 col 1&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes we need our parser to return a value different from the one that has been parsed.
Let&rsquo;s define two parser combinators one called <em>return</em> which substitutes a return value with provided one and another
one called <em>null</em> which just returns nil instead of parse result</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">return</span>
</span><span class='line'>  <span class="s">&quot;try parsing p and on success return r otherwise return parser error&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">p</span> <span class="nv">r</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">r</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">null</span>
</span><span class='line'>  <span class="s">&quot;try parsing p and on success return nil&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">return</span> <span class="nv">p</span> <span class="nv">nil</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What if we want to match beginning or end of <strong>ParseStream</strong>. We can do that since our <strong>ParseStream</strong> protocol has
two methods called <em>start-state?</em> and <em>end-state?</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">bos</span>
</span><span class='line'>  <span class="s">&quot;expect beginning of stream&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">nil</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;beginning of stream&quot;</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">eos</span>
</span><span class='line'>  <span class="s">&quot;expect end of stream&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span> <span class="nv">ps</span><span class="p">]</span> <span class="nv">end-state?</span> <span class="nv">ps</span><span class="p">)</span> <span class="s">&quot;end of stream&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>But what if we want to just generally parse any arbitary data, for example while parsing a <strong>SequenceParseStream</strong>.
We can do that too. We can even parse data with some particular elem using <em>=</em> and return it as parse result or
some optionally specified failure message with name of the element we needed our parser to be equal to.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">any-elem</span>
</span><span class='line'>  <span class="s">&quot;expect any element&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">elem</span>
</span><span class='line'>  <span class="s">&quot;expect element e named with name, name is used for parse error&quot;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">e</span> <span class="o">&amp;</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">name</span><span class="p">]}]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="nf">satisfy</span> <span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="nv">e</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">name</span><span class="p">)</span> <span class="p">(</span><span class="nb">str </span><span class="nv">e</span><span class="p">)</span> <span class="nv">name</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can even parse beginning and end of line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">bol</span>
</span><span class='line'> <span class="s">&quot;expect beginning of line, returns nil on success&quot;</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">start-state?</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>   <span class="nv">nil</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">c</span> <span class="p">(</span><span class="nf">current-elem</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">= </span><span class="nv">c</span> <span class="sc">\n</span><span class="nv">ewline</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="nv">c</span> <span class="sc">\r</span><span class="nv">eturn</span><span class="p">))</span>
</span><span class='line'>     <span class="nv">nil</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;beginning of line&quot;</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">eol</span>
</span><span class='line'> <span class="s">&quot;expect end of line, supports windows, unix and mac newline types&quot;</span>
</span><span class='line'> <span class="p">(</span><span class="nf">rewind</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">end-state?</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="nv">e</span> <span class="sc">\n</span><span class="nv">ewline</span><span class="p">))</span>
</span><span class='line'>     <span class="sc">\n</span><span class="nv">ewline</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">e</span> <span class="sc">\r</span><span class="nv">eturn</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">e</span> <span class="sc">\n</span><span class="nv">ewline</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">restore-state</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)</span> <span class="sc">\n</span><span class="nv">ewline</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;end of line character&quot;</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wait, this all starts remind us about regular expressions, right?! Well ofcourse we can even make a parser that will be able to match some regular expression.
But we have two limitations here, in order for our regular expression parser to be able to work with standard Java regular expression methods  it needs to be String or any char element based <strong>ParseStream</strong> and it needs to implement <strong>CharSequence</strong> interface.
So let&rsquo;s define <strong>ParseStreamCharSequenceFactory</strong> protocol and implement <strong>StringParseStreamCharSequence</strong> <em>deftype</em> to extend <strong>StringParseStream</strong> to be able to convert it to <strong>CharSequence</strong> at any time when needed. This functionality will be used for our <em>match</em> parser combinator that will have regular expression as it&rsquo;s input and will return parser that can match that regular expression.
Lots of code, I know. This is probably the most complicated parser combinator in entire <em>ccp</em> library. I won&rsquo;t start explaining every bit of it and leave that
to you guys as a self study.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">ParseStreamCharSequenceFactory</span>
</span><span class='line'>  <span class="s">&quot;A parse stream char sequence factory protocol&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">char-sequence</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">StringParseStreamCharSequence</span> <span class="p">[</span><span class="nv">ps</span> <span class="nv">p</span> <span class="nv">l</span><span class="p">]</span>
</span><span class='line'> <span class="nv">CharSequence</span>
</span><span class='line'> <span class="p">(</span><span class="nf">charAt</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">i</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="nv">i</span><span class="p">)]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">i</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt;= </span><span class="nv">i</span> <span class="p">(</span><span class="nf">.length</span> <span class="p">(</span><span class="nf">.s</span> <span class="nv">ps</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IndexOutOfBoundsException.</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.charAt</span> <span class="p">(</span><span class="nf">.s</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">i</span><span class="p">))))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">length</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span> <span class="nv">l</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="nf">subSequence</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">s</span> <span class="nv">e</span><span class="p">]</span> <span class="p">(</span><span class="nf">StringParseStreamCharSequence.</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="nv">s</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">e</span> <span class="nv">s</span><span class="p">)))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">toString</span> <span class="p">[</span><span class="nv">_</span><span class="p">]</span> <span class="p">(</span><span class="nf">.substring</span> <span class="p">(</span><span class="nf">.s</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">p</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="nv">l</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">StringParseStream</span> <span class="p">[</span><span class="o">^</span><span class="ss">:unsynchronized-mutable</span> <span class="nv">p</span> <span class="nv">s</span><span class="p">]</span>
</span><span class='line'> <span class="nv">....</span>
</span><span class='line'> <span class="nv">ParseStreamCharSequenceFactory</span>
</span><span class='line'> <span class="p">(</span><span class="nf">char-sequence</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">StringParseStreamCharSequence.</span> <span class="nv">ps</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">.length</span> <span class="p">(</span><span class="nf">.s</span> <span class="nv">ps</span><span class="p">))</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">match</span>
</span><span class='line'> <span class="s">&quot;match regex re, on success returns result of the match&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">re</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">re</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">string? </span><span class="nv">re</span><span class="p">)</span> <span class="p">(</span><span class="nb">re-pattern </span><span class="nv">re</span><span class="p">)</span> <span class="nv">re</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">d</span> <span class="p">(</span><span class="nb">re-matches </span><span class="nv">re</span> <span class="p">(</span><span class="nf">char-sequence</span> <span class="nv">ps</span><span class="p">))]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="nv">d</span>
</span><span class='line'>             <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">.length</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">vector? </span><span class="nv">d</span><span class="p">)</span> <span class="p">(</span><span class="nb">first </span><span class="nv">d</span><span class="p">)</span> <span class="nv">d</span><span class="p">))</span> <span class="mi">1</span><span class="p">)]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">i</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">- </span><span class="nv">i</span> <span class="mi">1</span><span class="p">)))</span> <span class="nv">d</span><span class="p">))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="nv">re</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s define another parser combinator. This one we&rsquo;ll call <em>collect</em> and it&rsquo;ll just collect exactly
<em>n</em> number of elements from parse stream and will return vector containing those elements.
Note how we are using <a href="http://clojure.org/reference/transients">transient</a> vector as accumulator in our loop/recur.
Using transient vector is more effective performance-wise as we don&rsquo;t need full power of persistent data structure and instead just want to accumulate result.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">collect</span>
</span><span class='line'> <span class="s">&quot;collect exactly n elems and return vector containing those elements&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">&lt; </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;n can&#39;t be negative&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">[])</span>
</span><span class='line'>  <span class="ss">:else</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">nc</span> <span class="nv">n</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">n</span> <span class="nv">n</span> <span class="nv">acc</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[])]</span>
</span><span class='line'>             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">e</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="nv">n</span> <span class="s">&quot; element&quot;</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span> <span class="s">&quot;s&quot;</span> <span class="nv">nil</span><span class="p">)))</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">persistent!</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">))</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">))))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can do the same but instead of collecting result just <em>consume</em> it and return nil.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">consume</span>
</span><span class='line'> <span class="s">&quot;consume exactly n elems and return nil&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">&lt; </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;n can&#39;t be negative&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="nv">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:else</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">nc</span> <span class="nv">n</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">n</span> <span class="nv">n</span><span class="p">]</span>
</span><span class='line'>             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">e</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="nv">n</span> <span class="s">&quot; element&quot;</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span> <span class="s">&quot;s&quot;</span> <span class="nv">nil</span><span class="p">)))</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>               <span class="nv">nil</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can even parse exactly some <em>string</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">string</span>
</span><span class='line'> <span class="s">&quot;parse string s&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">s</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">s</span><span class="p">)</span> <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;parsing string can&#39;t be empty&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">rewind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">p</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">.charAt</span> <span class="nv">s</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">.length</span> <span class="nv">s</span><span class="p">))</span>
</span><span class='line'>              <span class="nv">s</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">p</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;&#39;&quot;</span> <span class="p">(</span><span class="nf">.charAt</span> <span class="nv">s</span> <span class="nv">p</span><span class="p">)</span> <span class="s">&quot;&#39; from &#39;&quot;</span> <span class="nv">s</span> <span class="s">&quot;&#39; string&quot;</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What if we want to parse one or more parsers and return value only of the last one?
Well we can define a parser combinator that will allow us to do that.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&gt;&gt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentually and return result of the last one&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">loop </span><span class="p">[[</span><span class="nv">h</span> <span class="o">&amp;</span> <span class="nv">t</span><span class="p">]</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">h</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">t</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">recur</span> <span class="nv">t</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">e</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And exactly same but return first parser result instead.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;&lt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentually and return result of the first one&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">parsed</span> <span class="nv">first-elem</span> <span class="p">((</span><span class="nb">first </span><span class="nv">p</span><span class="p">)</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="k">loop </span><span class="p">[[</span><span class="nv">h</span> <span class="o">&amp;</span> <span class="nv">t</span><span class="p">]</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">p</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">h</span><span class="p">)</span>
</span><span class='line'>     <span class="nv">first-elem</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">h</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">recur</span> <span class="nv">t</span><span class="p">)</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>   <span class="nv">first-elem</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define some basic yet very powerful monadic bind <em>>>=</em> parser combinator.
Note how we apply function to result of the parse result of our parser. We can even have two kinds of
functions, one with parse stream as second result and one without it. We could have defined our <em>&lt;&lt;</em> and <em>>></em>
parser combinators using <em>>>=</em> parser combinator but our previously define loop/recur version will work faster and can grow
infinitely without consuming the stack.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&gt;&gt;=</span>
</span><span class='line'> <span class="s">&quot;execute parser and return result of applying f to parsed result and optionally a parse stream&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">n-args</span> <span class="nv">f</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">e</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">e</span><span class="p">)</span> <span class="nv">e</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can be used to define a <em>letp</em> macro which is actually a parser combinator too in some sense, well not exactly but close.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">letp</span>
</span><span class='line'> <span class="s">&quot;binds parser results to variables sequentually, same as let but uses parsers as values&quot;</span>
</span><span class='line'> <span class="p">[[</span><span class="o">&amp;</span> <span class="nv">parsers</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nv">body</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">zero? </span><span class="p">(</span><span class="nb">count </span><span class="nv">parsers</span><span class="p">))</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">zero? </span><span class="p">(</span><span class="nf">mod</span> <span class="p">(</span><span class="nb">count </span><span class="nv">parsers</span><span class="p">)</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;invalid number of parsers&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">e</span> <span class="nv">p</span> <span class="o">&amp;</span> <span class="nv">r</span><span class="p">]</span> <span class="nv">parsers</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">r</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="o">~</span><span class="nv">p</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">~</span><span class="nv">e</span> <span class="nv">ps#</span><span class="p">]</span> <span class="o">~@</span><span class="nv">body</span><span class="p">))</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="o">~</span><span class="nv">p</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">~</span><span class="nv">e</span> <span class="nv">ps#</span><span class="p">]</span> <span class="p">((</span><span class="nf">letp</span> <span class="o">~</span><span class="nv">r</span> <span class="o">~@</span><span class="nv">body</span><span class="p">)</span> <span class="nv">ps#</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can be used to manipulate parser results in any way and return result any way we want to.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">letp</span> <span class="p">[</span><span class="nv">a</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\a</span><span class="p">)</span> <span class="nv">b</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\b</span><span class="p">)]</span> <span class="p">(</span><span class="nb">str </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="s">&quot;ab&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">letp</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">any-char</span> <span class="nv">b</span> <span class="nv">any-char</span><span class="p">]</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">b</span><span class="p">])</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">letp</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">digit</span> <span class="nv">b</span> <span class="nv">digit</span><span class="p">]</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">read-string</span> <span class="p">(</span><span class="nb">str </span><span class="nv">a</span><span class="p">))</span> <span class="p">(</span><span class="nf">read-string</span> <span class="p">(</span><span class="nb">str </span><span class="nv">b</span><span class="p">))))</span> <span class="s">&quot;13&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about some sequential parser combinator that collects result into a vector.
This one is kinda similar to <em>collect</em> but applies parsers instead of counting number of elements.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;*&gt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentually and return vector of results, fails if one of them fails&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;no parsers specified&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">loop </span><span class="p">[[</span><span class="nv">h</span> <span class="o">&amp;</span> <span class="nv">t</span><span class="p">]</span> <span class="nv">p</span> <span class="nv">acc</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[])]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">h</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">persistent!</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">recur</span> <span class="nv">t</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>     <span class="nv">e</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use <em>&lt;*></em> to define <em>&lt;str*></em> and <em>&lt;keyword*></em> parser combinators.
Those just apply <em>str</em> and <em>keyword</em> functions to parser results.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;str&gt;</span>
</span><span class='line'> <span class="s">&quot;parse p and apply str to it&#39;s result&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">e</span><span class="p">)</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;str*&gt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentially and return string of results, fails if one of them fails&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">&lt;str&gt;</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">&lt;*&gt;</span> <span class="nv">p</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;keyword&gt;</span>
</span><span class='line'> <span class="s">&quot;parse p and apply keyword to it&#39;s result&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">keyword</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">string? </span><span class="nv">e</span><span class="p">)</span>
</span><span class='line'>     <span class="nv">e</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">coll?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">apply str </span><span class="nv">e</span><span class="p">)</span>
</span><span class='line'>     <span class="ss">:else</span> <span class="p">(</span><span class="nb">str </span><span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>   <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;keyword*&gt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentually and return keyword of results, fails if one of them fails&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">&lt;keyword&gt;</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">&lt;str*&gt;</span> <span class="nv">p</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">any-char</span> <span class="nv">any-char</span><span class="p">)</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">&lt;str*&gt;</span> <span class="nv">any-char</span> <span class="nv">any-char</span><span class="p">)</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="s">&quot;ab&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">&lt;keyword*&gt;</span> <span class="nv">any-char</span> <span class="nv">any-char</span><span class="p">)</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="ss">:ab</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define yet another crucial alternatives <em>&lt;|></em> parser combinator.
This takes any number of parsers as input, and when parsing, tries each one of them and stops when
either all of them fail or one of them consumes input while failing.
The code is quite complicated as we need to deal with generating error message as well as checking
state of parse stream each time we are trying to parse some data.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">&lt;</span><span class="err">|</span><span class="nv">&gt;</span>
</span><span class='line'> <span class="s">&quot;execute parsers sequentually and return first successful result, fails if one of them fails while consuming input or all of them fail&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">p</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">throw</span> <span class="p">(</span><span class="nf">IllegalArgumentException.</span> <span class="s">&quot;no parsers specified&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">loop </span><span class="p">[[</span><span class="nv">h</span> <span class="o">&amp;</span> <span class="nv">t</span><span class="p">]</span> <span class="nv">p</span> <span class="nv">ms</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[])]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">h</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">state-changed?</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">e</span>
</span><span class='line'>       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">t</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">ms</span> <span class="p">(</span><span class="nf">persistent!</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">ms</span> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>         <span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>         <span class="nv">_</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>         <span class="nv">pe</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nf">str/join</span> <span class="s">&quot; or &quot;</span> <span class="nv">ms</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">_</span> <span class="p">(</span><span class="nf">restore-state</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)]</span>
</span><span class='line'>         <span class="nv">pe</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="nv">t</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">ms</span> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="nv">e</span><span class="p">)))))</span>
</span><span class='line'>      <span class="nv">e</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Speaking of parser failures what if we want to get a failure message out of parser without actually applying parser to a parse stream.
Well we have some edge cases but still we can do that with a really simple trick by making a parser combinator that can make any parser <em>fail</em>.
We&rsquo;ll just define some empty string stream and will use it to apply parser to it and return it&rsquo;s error message as if it was applied to parse
stream itself. We can then have <em>fail-message</em> function that will return the failure message itself.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">empty-stream</span> <span class="p">(</span><span class="nf">parse-stream</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fail</span>
</span><span class='line'> <span class="s">&quot;fail p, parser p must not accept nil otherwise failure message won&#39;t be correct&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">restore</span> <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">= </span><span class="nv">p</span> <span class="nv">bos</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;beginning of stream&quot;</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">= </span><span class="nv">p</span> <span class="nv">eos</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;end of stream&quot;</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">= </span><span class="nv">p</span> <span class="nv">any-elem</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="s">&quot;any element&quot;</span><span class="p">))</span>
</span><span class='line'>           <span class="ss">:else</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">next-elem</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">empty-stream</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="nv">e</span><span class="p">))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="nv">e</span><span class="p">))))</span>
</span><span class='line'>          <span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fail-message</span>
</span><span class='line'> <span class="s">&quot;makes p fail and returns failure message, note: not a parser function&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">parser-error-message</span> <span class="p">((</span><span class="nf">fail</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">empty-stream</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have <em>fail-message</em> function we can define <em>no</em> parser combinator that will make
any parser fail in case it succeeds and will succeed in case of failure.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">no</span>
</span><span class='line'> <span class="s">&quot;if p fails succeds with nil, otherwise fails&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">parser-error</span> <span class="nv">ps</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;not &quot;</span> <span class="p">(</span><span class="nf">fail-message</span> <span class="nv">p</span><span class="p">)))</span> <span class="nv">nil</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes we want some optional value so why note define an <em>option</em> parser combinator too.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">option</span>
</span><span class='line'> <span class="s">&quot;try p, if it fails without consuming any input return r, otherwise return value returned by p&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span> <span class="nv">r</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">st</span> <span class="p">(</span><span class="nf">get-state</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">state-changed?</span> <span class="nv">ps</span> <span class="nv">st</span><span class="p">)</span> <span class="nv">e</span> <span class="nv">r</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">e</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What if we want to repetitively parse some value one or more times and return vector of results.
We can do that with <em>many</em> and <em>many1</em> parser combinators.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">many</span>
</span><span class='line'> <span class="s">&quot;try p, 0 or more times and return result&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="nv">acc</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[])]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">persistent!</span> <span class="nv">acc</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">many1</span>
</span><span class='line'> <span class="s">&quot;try p, 1 or more times and return result&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">e</span>
</span><span class='line'>    <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">acc</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[</span><span class="nv">e</span><span class="p">])</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">parser-error?</span> <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">persistent!</span> <span class="nv">acc</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">e</span><span class="p">)</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our next parser combinator is quite complex so I&rsquo;ll try to explain it in more detail.
Sometimes when parsing programming languages or any symbolic expressions we need our operators to have
different precedence based on some predefined rules that we have. For example in math expression like 1+2*3 will
be interpreted as (+ 1 (* 2 3)) since * operator has higher precedence compared to + operator.
In order parse this kind of expressions we&rsquo;ll define two special parser combinators called  <em>op</em> and <em>op-expr</em> that need to be used with each other.
<em>op</em> parser combinator converts any parser that can parse some operator into a parser that returns parsed operator and it&rsquo;s precedence value.
This value is then used by <em>op-expr</em> in order return expression in exact precedence order as define by op parsers. The code is kinda complex and I&rsquo;ll live it
as exercise for you to study and understand.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">op</span>
</span><span class='line'> <span class="s">&quot;return operator parser p with precedence o&quot;</span>
</span><span class='line'> <span class="p">[</span><span class="nv">p</span> <span class="nv">o</span><span class="p">]</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="nv">o</span> <span class="o">~</span><span class="nv">e</span><span class="p">)</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">op-expr</span>
</span><span class='line'> <span class="s">&quot;parse parser p expression and then optionally parse any of operator parser from ops sequence followed by another p expression and return expressions ordered by operator precedence with f applied to each expression&quot;</span>
</span><span class='line'> <span class="p">([</span><span class="nv">p</span> <span class="nv">ops</span><span class="p">]</span> <span class="p">(</span><span class="nf">op-expr</span> <span class="nv">p</span> <span class="nv">ops</span> <span class="nv">identity</span><span class="p">))</span>
</span><span class='line'> <span class="p">([</span><span class="nv">p</span> <span class="nv">ops</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">ops</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">&lt;</span><span class="err">|</span><span class="nb">&gt; </span><span class="nv">ops</span><span class="p">)]</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">letfn</span> <span class="p">[(</span><span class="nf">op&gt;=</span> <span class="p">[</span><span class="nv">o1</span> <span class="nv">o2</span><span class="p">]</span> <span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">first </span><span class="nv">o1</span><span class="p">)</span> <span class="p">(</span><span class="nb">first </span><span class="nv">o2</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">exps</span> <span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">acc</span> <span class="p">(</span><span class="nf">transient</span> <span class="p">[</span><span class="nv">e</span><span class="p">])]</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">parsed</span> <span class="nv">o</span> <span class="p">(</span><span class="nf">ops</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">parsed</span> <span class="nv">e</span> <span class="p">(</span><span class="nf">p</span> <span class="nv">ps</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">conj!</span> <span class="p">(</span><span class="nf">conj!</span> <span class="nv">acc</span> <span class="nv">o</span><span class="p">)</span> <span class="nv">e</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">persistent!</span> <span class="nv">acc</span><span class="p">)))</span>
</span><span class='line'>      <span class="nv">e</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">reduce-exps</span> <span class="p">[</span><span class="nv">es</span><span class="p">]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">es</span> <span class="nv">es</span> <span class="nv">acc</span> <span class="p">[]]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">count </span><span class="nv">es</span><span class="p">)</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">a</span> <span class="nv">o1</span> <span class="nv">b</span> <span class="nv">o2</span> <span class="nv">c</span> <span class="o">&amp;</span> <span class="nv">d</span><span class="p">]</span> <span class="nv">es</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">op&gt;=</span> <span class="nv">o1</span> <span class="nv">o2</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">into </span><span class="p">[(</span><span class="nf">f</span> <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">second </span><span class="nv">o1</span><span class="p">)</span> <span class="o">~</span><span class="nv">a</span> <span class="o">~</span><span class="nv">b</span><span class="p">))</span> <span class="nv">o2</span> <span class="nv">c</span><span class="p">]</span> <span class="nv">d</span><span class="p">)</span> <span class="nv">acc</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">into </span><span class="p">[</span><span class="nv">b</span> <span class="nv">o2</span> <span class="nv">c</span><span class="p">]</span> <span class="nv">d</span><span class="p">)</span> <span class="p">(</span><span class="nb">into </span><span class="nv">acc</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">o1</span><span class="p">]))))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nb">count </span><span class="nv">es</span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">a</span> <span class="nv">o</span> <span class="nv">b</span><span class="p">]</span> <span class="nv">es</span><span class="p">]</span> <span class="p">(</span><span class="nb">into </span><span class="nv">acc</span> <span class="p">[(</span><span class="nf">f</span> <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">second </span><span class="nv">o</span><span class="p">)</span> <span class="o">~</span><span class="nv">a</span> <span class="o">~</span><span class="nv">b</span><span class="p">))]))</span>
</span><span class='line'>       <span class="ss">:else</span> <span class="p">(</span><span class="nb">into </span><span class="nv">acc</span> <span class="nv">es</span><span class="p">))))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">reduce-while</span> <span class="p">[</span><span class="nv">es</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">es</span> <span class="p">(</span><span class="nf">reduce-exps</span> <span class="nv">es</span><span class="p">)]</span>
</span><span class='line'>          <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">count </span><span class="nv">es</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nf">reduce-exps</span> <span class="nv">es</span><span class="p">))</span>
</span><span class='line'>           <span class="nv">es</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ps</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">parsed</span> <span class="nv">es</span> <span class="p">(</span><span class="nf">exps</span> <span class="nv">ps</span><span class="p">)</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">reduce-while</span> <span class="nv">es</span><span class="p">))</span> <span class="nv">es</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">op-expr</span> <span class="nv">any-char</span> <span class="p">[(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\+</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\*</span><span class="p">)</span> <span class="mi">2</span><span class="p">)])</span> <span class="s">&quot;a+b+c&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">(</span><span class="sc">\+</span> <span class="p">(</span><span class="sc">\+</span> <span class="sc">\a</span> <span class="sc">\b</span><span class="p">)</span> <span class="sc">\c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">op-expr</span> <span class="nv">any-char</span> <span class="p">[(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\+</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\*</span><span class="p">)</span> <span class="mi">2</span><span class="p">)])</span> <span class="s">&quot;a+b*c&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">(</span><span class="sc">\+</span> <span class="sc">\a</span> <span class="p">(</span><span class="sc">\*</span> <span class="sc">\b</span> <span class="sc">\c</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">op-expr</span> <span class="nv">any-char</span> <span class="p">[(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\+</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">op</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\*</span><span class="p">)</span> <span class="mi">2</span><span class="p">)])</span> <span class="s">&quot;a+d*c+e&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">(</span><span class="sc">\+</span> <span class="sc">\a</span> <span class="p">(</span><span class="sc">\+</span> <span class="p">(</span><span class="sc">\*</span> <span class="sc">\d</span> <span class="sc">\c</span><span class="p">)</span> <span class="sc">\e</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>I can go on with defining this parsers but this will make me only tired and this post only longer and hard to read so instead I&rsquo;ll just stop and
show you guys something really awesome. This is <em>exp</em> parser combinator that can generate parsers from a simple Parser Expression Language inspired
by <a href="https://en.wikipedia.org/wiki/Parsing_expression_grammar">Parsing Expression Grammar</a> and Regular Expressions. I won&rsquo;t describe it as it&rsquo;s
still work-in-progress and might change in the future. Instead I&rsquo;ll show you some examples of using it.
Those interested in source code  should look in git repo exp.clj file also note that what you might see there is quite ugly and complex but I hope to improve
it in the future.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\c</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;&#39;abc&#39;&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="s">&quot;abc&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;a?&quot;</span><span class="p">)</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="nv">nil</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;a*&quot;</span><span class="p">)</span> <span class="s">&quot;aaa&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\a</span> <span class="sc">\a</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;a{2,3}&quot;</span><span class="p">)</span> <span class="s">&quot;aaaa&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\a</span> <span class="sc">\a</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;a?b&quot;</span><span class="p">)</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="nv">nil</span> <span class="sc">\b</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;~a?b&quot;</span><span class="p">)</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\b</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;~a?bc&quot;</span><span class="p">)</span> <span class="s">&quot;bc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\b</span> <span class="sc">\c</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;/[abc]*/&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="s">&quot;abc&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;(abc)&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\c</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;(abc)&lt;0&gt;&quot;</span><span class="p">)</span> <span class="s">&quot;abcabc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\c</span><span class="p">]</span> <span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\c</span><span class="p">]]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;\&quot;(abc)&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="s">&quot;abc&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;:(abc)&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="ss">:abc</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;[ab]*&quot;</span><span class="p">)</span> <span class="s">&quot;abbaaba&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\b</span> <span class="sc">\a</span> <span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\a</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;___&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="nv">nil</span> <span class="nv">nil</span> <span class="nv">nil</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;__\\_&quot;</span><span class="p">)</span> <span class="s">&quot;ab_&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="nv">nil</span> <span class="nv">nil</span> <span class="sc">\_</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;\\s&quot;</span><span class="p">)</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;\\w&quot;</span><span class="p">)</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\a</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;\\d&quot;</span><span class="p">)</span> <span class="s">&quot;9&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="sc">\9</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;(a(bc))&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="p">[</span><span class="sc">\b</span> <span class="sc">\c</span><span class="p">]]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;:#(a(bc))&quot;</span><span class="p">)</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="ss">:abc</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;\\w\\a[a\\_]&quot;</span><span class="p">)</span> <span class="s">&quot;ab_&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span> <span class="sc">\_</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;([ab]{2})&lt;a&gt;&quot;</span> <span class="p">{</span><span class="ss">:a</span> <span class="p">(</span><span class="nf">chr</span> <span class="sc">\a</span><span class="p">)})</span> <span class="s">&quot;abab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[[</span><span class="sc">\a</span> <span class="sc">\b</span><span class="p">]</span> <span class="sc">\a</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">parse </span><span class="p">(</span><span class="nf">exp</span> <span class="s">&quot;([ab]{2})&lt;a&gt;&quot;</span> <span class="p">{</span><span class="ss">:a</span> <span class="s">&quot;ab&quot;</span><span class="p">})</span> <span class="s">&quot;baab&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">-&gt; </span><span class="p">[[</span><span class="sc">\b</span> <span class="sc">\a</span><span class="p">]</span> <span class="p">[</span><span class="sc">\a</span> <span class="sc">\b</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it folks, we&rsquo;ve defined a clean, simple and yet beautiful parser combinator library that is easy to grasp. Happy parsing!</p>

<p><img src="http://i.imgur.com/fgIohxm.png" alt="Piano &amp; Violin" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Of All The Garbage in The World]]></title>
    <link href="http://troydm.github.io/blog/2015/09/06/of-all-the-garbage-in-the-world/"/>
    <updated>2015-09-06T00:01:19+04:00</updated>
    <id>http://troydm.github.io/blog/2015/09/06/of-all-the-garbage-in-the-world</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing tri-color (actually 4-color) incremental generational garbage collector in C</em></p>

<p><a href="http://troydm.github.io/blog/2015/08/03/lifting-shadows-off-a-memory-allocation/">Previously</a> we&rsquo;ve talked about manual memory allocation and unraveled some shadows around it.
Now let&rsquo;s talk about automatic memory allocation, more specifically about <a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29">Garbage Collection</a>.
Most if not all modern Programming Languages contain a mechanism that handles allocation of memory automatically at precisely the moment application needs it and deallocation of that
memory at the moment it&rsquo;s not needed anymore. However determining when memory region (or object) is safe to deallocate is not an easy feat as we need to somehow determine if the region is needed or not.
And here is where <em>Garbage Collection</em> comes into a play. Simply speaking <em>Garbage Collection</em> is an algorithm that checks entire memory of an application for regions that aren&rsquo;t referenced anywhere inside application by other memory regions and deallocates these regions because they aren&rsquo;t needed anymore.</p>

<p><img src="http://i.imgur.com/v5Czgfd.png" alt="Space Dandy" /></p>

<!--more-->


<p><em>Garbage Collection</em> was invented by <a href="https://en.wikipedia.org/wiki/John_McCarthy_%28computer_scientist%29">John McCarthy</a> back in 1959 for <a href="https://en.wikipedia.org/wiki/Lisp_%28programming_language%29">Lisp</a> and is still one of the hottest evolving topics in Computer Science nowadays, especially with <a href="https://en.wikipedia.org/wiki/Java_%28software_platform%29">Java</a>&rsquo;s GC becoming more famous with tons of blows and whistles which can be tuned to practically any application memory usage scenario. There are also alternative models to automatic memory handling such as <a href="https://en.wikipedia.org/wiki/NewLISP">newLisp</a>&rsquo;s ORO, <a href="https://en.wikipedia.org/wiki/Rust_%28programming_language%29">Rust</a>&rsquo;s ownership based life cycle management and <a href="https://en.wikipedia.org/wiki/Objective-C">Objective-C</a>&rsquo;s ARC but we won&rsquo;t be talking about those. The cost of checking entire memory region is not a cheap one so people realized ways to make it more reasonable and thus nowadays we have various types of <em>Garbage Collection</em> algorithms. There are tracing garbage collectors and reference counting ones, copying (moving) and non-copying (non-moving) ones, incremental and non-incremental, generational, concurrent, parallel and real-time ones. To learn more about all those types of <em>Garbage Collectors</em> I suggest you try reading <a href="http://www.amazon.com/Garbage-Collection-Handbook-Management-Algorithms/dp/1420082795/">The Garbage Collection Handbook</a> which is a fundamental must read handbook for all those interested in the topic. But for rest of you lazy bunch let&rsquo;s start collecting all the garbage in the world by writing one garbage collector ourselves.</p>

<p>Let&rsquo;s write a single threaded tracing tri-color (actually 4-color, I&rsquo;ll explain later why) non-copying incremental n-generational (n-generational meaning that we can configure any number of generations dynamically on startup, but our implementation will have limitation of maximum 64 generations) <em>Garbage Collector</em> in <em>C</em>. We won&rsquo;t tackle multithreading, concurrency and parallel garbage collection for sake of simplicity as those are more complex to implement but maybe I&rsquo;ll do another blog post about them later this year. Our simple garbage collector will be single threaded only, meaning it will correctly work only in applications that don&rsquo;t use multiple threads or somehow allocate memory in parallel. This kind of <em>Garbage Collector</em> is sufficient for languages that aren&rsquo;t natively multithreaded, such as <a href="https://en.wikipedia.org/wiki/Node.js">Node.js</a> and <a href="https://en.wikipedia.org/wiki/Pharo">Pharo</a>, so if you are planning to write such language yourself this might be a useful exercise for you. For those of you impatient ones there is a <a href="https://github.com/troydm/simplegc/">simplegc</a> repo with all the source code to study. So let&rsquo;s get started.</p>

<p>We need a way to represent our memory regions so we&rsquo;ll go for the most obvious object oriented representation, meaning we&rsquo;ll just write a garbage collector for object-oriented programming language of ours.
Each object will be part of doubly linked list so we could trace it and hence it will contain a pointer to a pointer of a previous object pointing to it called <strong>gc_prev</strong> and a pointer to the next object called <strong>gc_next</strong>.
Each object will have a pointer to a <strong>class</strong> description which we&rsquo;ll talk about later.
Each object will also have 32-bit unsigned integer called <strong>gc_mark</strong> which will serve three purposes: to mark object&rsquo;s color, gc generation and count root references (I&rsquo;ll explain those later). Each object might also reference other objects for example we might have fields inside object which could contain other objects so hence we need <strong>refs_count</strong> variable to count number of fields object has.
Since each object will be of a class we also need to represent the class itself. It will contain function pointers that will be used during garbage collection. One of them is the most obvious function pointer which is a <strong>gc_finalize</strong> function. This function will be called precisely before the moment of freeing memory region which is not used anymore or simply speaking just before the object will be deleted by the <em>Garbage Collector</em>. <strong>gc_mark_black</strong> function pointer will point to a function used to mark object from <em>grey</em> to <em>black</em> and mark all objects it&rsquo;s referring (or contains) as <em>grey</em> for further processing. <strong>gc_contains</strong> will be a function used to check if an object is referenced (or contained) by another object.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">gc_object_class_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// gc object</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">gc_object_t</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">gc_object_t</span><span class="o">**</span> <span class="n">gc_prev</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">gc_object_t</span><span class="o">*</span> <span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">gc_mark</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">gc_object_class_t</span><span class="o">*</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint16_t</span> <span class="n">refs_count</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">gc_object</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// gc object class</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">gc_object_class_t</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">gc_mark_black</span><span class="p">)(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">);</span> <span class="c1">// this marks  object from grey to black</span>
</span><span class='line'>    <span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">gc_contains</span><span class="p">)(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">ref</span><span class="p">);</span> <span class="c1">// this checks if object contains reference object</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">gc_finalize</span><span class="p">)(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">);</span> <span class="c1">// this is called before object is deallocated</span>
</span><span class='line'><span class="p">}</span> <span class="n">gc_object_class</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s talk about <strong>gc_mark</strong>. As I&rsquo;ve said earlier it&rsquo;ll serve three purposes for our object: root reference count, object&rsquo;s color marking, and gc generation.
We&rsquo;ll use first 24 bits for root reference counting, next 2 bits will be used for color (as we&rsquo;ll have 4 possible colors we need 2 bits since 2<sup>2</sup> is 4) and remaining 6 bits will be used for gc generation (meaning we can&rsquo;t have more than 64 generations since 2<sup>6</sup> is 64, but that is enough for any use case).</p>

<p><canvas id="gc_mark" width="400" height="75"></canvas></p>

<script>
function drawRect(ctx,text,x,y,w,h){
    ctx.fillRect(x,y,w,h);
    ctx.moveTo(x,y);
    ctx.lineTo(x,y+h);
    ctx.stroke();
    ctx.moveTo(x,y);
    ctx.lineTo(x+w,y);
    ctx.stroke();
    ctx.moveTo(x+w,y);
    ctx.lineTo(x+w,y+h);
    ctx.stroke();
    ctx.moveTo(x,y+h);
    ctx.lineTo(x+w,y+h);
    ctx.stroke();
    var fs = ctx.fillStyle;
    ctx.fillStyle = "#000000";
    var tl = 16*text.length;
    ctx.fillText(text,x+(w/2)-(tl/4)+5,y+(h/2)+4);
    ctx.fillStyle = fs;
}
var c = document.getElementById("gc_mark");
var ctx = c.getContext("2d");
ctx.font="normal 12pt Sans";
ctx.fillStyle = "#000000";
ctx.fillText("gc_mark (32-bit unsigned integer)",5,15);
ctx.fillStyle = "#F8D7BB";
ctx.strokeStyle = "#000000";
drawRect(ctx,"24 bits",0,20,300,35);
drawRect(ctx," 2 bits",300,20,50,35);
drawRect(ctx," 6 bits",350,20,50,35);
ctx.fillStyle = "#000000";
ctx.fillText("root reference count",95,70);
ctx.fillText("color",310,70);
ctx.fillText("gen",365,70);
</script>


<p>Let&rsquo;s define some useful macros to work with <strong>gc_mark</strong>. Most of them are related to bitwise magic so I won&rsquo;t explain them in details but instead leave that as self-study for you.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// gc mark</span>
</span><span class='line'><span class="cp">#define gc_set_mark(o,r,gi) o-&gt;gc_mark = (r &lt;&lt; 8) | gi</span>
</span><span class='line'><span class="c1">// generation part</span>
</span><span class='line'><span class="cp">#define gc_gen_part(o) (o-&gt;gc_mark &amp; 0xFF)</span>
</span><span class='line'><span class="cp">#define gc_gen_num(o) (o-&gt;gc_mark &amp; 0x3F)</span>
</span><span class='line'><span class="cp">#define gc_gen_set(o,g) gc_set_mark(o,gc_root_ref_count(o), gc_color_bit(o) | (g &amp; 0x3F))</span>
</span><span class='line'><span class="c1">// color bits</span>
</span><span class='line'><span class="cp">#define gc_color_bit(o) (o-&gt;gc_mark &amp; 0xC0)</span>
</span><span class='line'><span class="cp">#define gc_color(o) (gc_gen_part(o) &gt;&gt; 6)</span>
</span><span class='line'><span class="cp">#define gc_color_is_white(o) (gc_color_bit(o) == 0x00)</span>
</span><span class='line'><span class="cp">#define gc_color_is_grey(o) (gc_color_bit(o) == 0x40)</span>
</span><span class='line'><span class="cp">#define gc_color_is_black(o) (gc_color_bit(o) == 0x80)</span>
</span><span class='line'><span class="cp">#define gc_color_is_silver(o) (gc_color_bit(o) == 0xC0)</span>
</span><span class='line'><span class="cp">#define gc_color_is_silver_or_white(o) (gc_color_is_silver(o) || gc_color_is_white(o))</span>
</span><span class='line'><span class="cp">#define gc_mark_white(o) o-&gt;gc_mark &amp;= 0xFFFFFF3F</span>
</span><span class='line'><span class="cp">#define gc_mark_grey(o) gc_mark_white(o); o-&gt;gc_mark |= 0x40</span>
</span><span class='line'><span class="cp">#define gc_mark_black(o) gc_mark_white(o); o-&gt;gc_mark |= 0x80</span>
</span><span class='line'><span class="cp">#define gc_mark_silver(o) o-&gt;gc_mark |= 0xC0</span>
</span><span class='line'><span class="c1">// root reference count</span>
</span><span class='line'><span class="cp">#define gc_root_ref_count(o) (o-&gt;gc_mark &gt;&gt; 8)</span>
</span><span class='line'><span class="cp">#define gc_inc_root_ref_count(o) gc_set_mark(o,(gc_root_ref_count(o)+1),gc_gen_part(o))</span>
</span><span class='line'><span class="cp">#define gc_dec_root_ref_count(o) gc_set_mark(o,(gc_root_ref_count(o)-1),gc_gen_part(o))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s describe configuration for our garbage collector. First thing first we need to limit duration
of our garbage collection cycle since we don&rsquo;t want it to be too long and are writing an incremental garbage
collector after all. For this we&rsquo;ll have <strong>max_pause</strong> configuration property which will define maximum amount of
nanoseconds gc cycle can run. Also since we need to somehow check if our cycle is exceeding it&rsquo;s pause limit or not
we just can&rsquo;t do it after every object we check during gc cycle, thus we need <strong>pause_threshold</strong> which is number of
objects checked after which gc pause check occurs. Next we define number of generations our garbage collector will have
using <strong>gens_count</strong> and provide generation configurations array using <strong>gens</strong>.
Each generation configuration will have <strong>refresh_interval</strong> which is number of nanoseconds passed after last full gc cycle
after which entire generation of objects should be rechecked. Now we need to clarify what is full gc cycle.
Full gc cycle is garbage collection cycle that is not interrupted after hitting max pause threshold.
Last thing our generation configuration has is <strong>promotion_interval</strong> which is number of nanoseconds passed after last full gc cycle
after which our objects in generation are promoted to higher generation. This configuration property is not relevant for the last generation since there is no next generation to promote to.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// gc config</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">max_pause</span><span class="p">;</span> <span class="c1">// gc max pause in nanoseconds</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">pause_threshold</span><span class="p">;</span> <span class="c1">// number of objects checked after which gc pause check should occur</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="n">gens_count</span><span class="p">;</span> <span class="c1">// number of generations</span>
</span><span class='line'>    <span class="n">gc_gen_config</span><span class="o">*</span> <span class="n">gens</span><span class="p">;</span> <span class="c1">// generation configs array</span>
</span><span class='line'><span class="p">}</span> <span class="n">gc_config</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// generation config</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">refresh_interval</span><span class="p">;</span> <span class="c1">// generation refresh interval in nanoseconds</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">promotion_interval</span><span class="p">;</span> <span class="c1">// generation promotion interval in nanoseconds</span>
</span><span class='line'><span class="p">}</span> <span class="n">gc_gen_config</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s talk about why we need 4 colors for describing the state of the object in relevance to current garbage collection cycle.
In traditional tri-color garbage collector objects can be <em>white</em>, <em>grey</em> and <em>black</em>. Newly created objects are marked as <em>white</em>.
After object is identified to have a root reference it&rsquo;s color is changed from <em>white</em> to <em>grey</em>. Next all <em>grey</em> objects are checked for
references of other objects that they contain. For each contained reference if reference is <em>white</em> it&rsquo;s marked as <em>grey</em> for future checking after which the container object is marked as <em>black</em>. All remaining <em>grey</em> objects are subsequently checked for references of objects they contain. After this checks we have only <em>black</em> and <em>white</em> objects. Objects marked as <em>black</em> are reachable from the root and hence don&rsquo;t need to be garbage collected. Remaining white objects on the other hand are considered garbage and freed in the end. You can read about this in more detail <a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Tri-color_marking">here</a>.</p>

<p>Traditional tri-color algorithm doesn&rsquo;t has a notion of generation in mind because checking objects only in some specific limited generation won&rsquo;t be correct for determining if objects are garbage or not as some of those objects might have references from other generations. Let&rsquo;s consider that you have a generation of objects and you suddenly want to recheck them all. What you will probably do is mark all objects as <em>white</em> again and then mark objects that have root references as <em>grey</em> and go from there. However the problem with this approach is that in the end we might have white objects that don&rsquo;t have direct references in generation they are part of but have indirect reference from root objects in another generation. This is why we need 4 colors. We will treat those objects as <em>silver</em> and won&rsquo;t consider them as <em>white</em> yet. For each such object we&rsquo;ll check all <em>black</em> objects in all generations for possible references. If such reference will be found we&rsquo;ll mark that object as <em>grey</em> and will promote it to the generation that has reference to it. This might introduce some generation bouncing but since all live objects in all generations are subsequently promoted after some period of time to last generation this won&rsquo;t be a problem.</p>

<p>Since we need to be incremental during our garbage collection cycle for all white objects that are considered garbage we&rsquo;ll have a separate color that we&rsquo;ll call <em>transparent</em>, but we won&rsquo;t need additional bit in <strong>gc_mark</strong> to identify objects with such color. This kind objects won&rsquo;t be marked directly but instead will be part of <strong>transparent</strong> list that will be used during last step in our incremental garbage collection cycle to call <strong>gc_finalize</strong> function for each object in that list and <strong>free</strong> it from memory. This is needed because <strong>gc_finalize</strong> and <strong>free</strong> calls can be time costly operations hence we need to delay them until our gc cycle is fully over so they could be executed in the remaining cycle time. This way we can have a nearly timely precise incremental garbage collector that won&rsquo;t ever exceed our predefined <strong>max_pause</strong> time.</p>

<p>Since we are going to count time using nanoseconds we need a way to measure nanoseconds passed between execution of arbitrary code.
For this we&rsquo;ll use Linux <em>syscall</em> <strong>clock_gettime</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// get current time in nano seconds</span>
</span><span class='line'><span class="kt">uint64_t</span> <span class="nf">get_nanotime</span><span class="p">(){</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line'>    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span><span class="o">*</span><span class="mi">1000000000</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">t</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define some global constants and variables for our garbage collector. Note how we are going to have
single double linked lists for each gc color except <em>black</em>.
Each generation will have it&rsquo;s own <em>black</em> objects list and hence we&rsquo;ll need an array of doubly linked objects lists.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define WHITE 0</span>
</span><span class='line'><span class="cp">#define GREY  1</span>
</span><span class='line'><span class="cp">#define BLACK 2</span>
</span><span class='line'><span class="cp">#define SILVER 3</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// gc configuration</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_config</span> <span class="n">conf</span><span class="p">;</span>
</span><span class='line'><span class="c1">// gc list variables</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">transparent</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">white</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">silver</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">grey</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">gc_object</span><span class="o">**</span> <span class="n">black</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally we can start writing some functions. Let&rsquo;s start with Garbage Collector initialization function first.
This will be called on startup and only once. It checks if generation count is correct and next thing is it just copies over configuration object including
the contained generation configurations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// initialize garbage collector</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">gc_init</span><span class="p">(</span><span class="n">gc_config</span><span class="o">*</span> <span class="n">config</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// number of generations can&#39;t be more than 64 or equal to 0</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">gens_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gens_count</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">){</span>
</span><span class='line'>        <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// copy config</span>
</span><span class='line'>    <span class="n">conf</span> <span class="o">=</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">gens</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_gen_config</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gc_gen_config</span><span class="p">)</span> <span class="o">*</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="p">);</span>
</span><span class='line'>    <span class="n">black</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">**</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// foreach generation config</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// copy config and initialize generation</span>
</span><span class='line'>        <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh_time</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">();</span>
</span><span class='line'>        <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promotion_time</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh_time</span><span class="p">;</span>
</span><span class='line'>        <span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also need a function to destroy our garbage collector when it&rsquo;s not needed anymore.
This needs to free up all doubly linked lists as those can be considered part of garbage collector.
Note how we call <strong>gc_finalize</strong> function before freeing up object.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// completely free entire list finalizing all objects inside</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_free_list</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">list</span><span class="p">){</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">list</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'>        <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_finalize</span><span class="p">)(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// deinitialize garbage collector</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">gc_destroy</span><span class="p">(){</span>
</span><span class='line'>    <span class="c1">// free all objects from all lists</span>
</span><span class='line'>    <span class="n">gc_free_list</span><span class="p">(</span><span class="n">transparent</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_free_list</span><span class="p">(</span><span class="n">white</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_free_list</span><span class="p">(</span><span class="n">silver</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_free_list</span><span class="p">(</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>        <span class="n">gc_free_list</span><span class="p">(</span><span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="c1">// remove black list and generation configs</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">black</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define some helper functions for working with doubly linked lists.
We&rsquo;ll use those to add, remove, and move objects from one list to another.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// add object to list</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_list_add</span><span class="p">(</span><span class="n">gc_object</span><span class="o">**</span> <span class="n">list</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">){</span>
</span><span class='line'>    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
</span><span class='line'>        <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="o">-&gt;</span><span class="n">gc_prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">);</span>
</span><span class='line'>    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_prev</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'>    <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// remove object from current list</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_list_remove</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">){</span>
</span><span class='line'>    <span class="o">*</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_prev</span><span class="p">)</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
</span><span class='line'>        <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="o">-&gt;</span><span class="n">gc_prev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_prev</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// move object to list</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_list_move</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">**</span> <span class="n">list</span><span class="p">){</span>
</span><span class='line'>    <span class="n">gc_list_remove</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_list_add</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// move all objects from list to list</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gc_list_move_all</span><span class="p">(</span><span class="n">gc_object</span><span class="o">**</span> <span class="n">from</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">**</span> <span class="n">to</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">to</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
</span><span class='line'>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>        <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">to</span><span class="p">;</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">to</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gc_prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="o">*</span><span class="n">to</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gc_prev</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
</span><span class='line'>    <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in order to determine if object is reachable or not we&rsquo;ll just use root reference counting instead of going over the stack and marking objects each time.
This might be considered more expensive as each time we set a reference to some object on the stack we need to increment it&rsquo;s root reference count.
And every time we pop a stack frame or modify a reference on the stack we need to decrement root reference count. Doing this many times is expensive indeed however from my point of view this approach is more faster in long term compared to scanning the stack each time during garbage collection. But if you really want it our simple garbage collector can be easily modified to use the scanning approach if needed.</p>

<p>As you can see from code when we increment root reference count we also check if object is white and mark it as grey for future check by Garbage Collector.
We could omit this step, however in doing so we would require to go through entire white objects set and check their root reference count each time during Garbage Collector cycle. As you can see there are no additional steps during decrement of root reference count, and that is because we don&rsquo;t need to do anything since when root reference count becomes 0 our object will still be refreshed during generation refresh phase and during it the root reference count will be checked anyway.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// add gc root</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">gc_add_root</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// increase root ref count</span>
</span><span class='line'>    <span class="n">gc_inc_root_ref_count</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// mark object as grey if it&#39;s white or silver</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">gc_color_is_silver_or_white</span><span class="p">(</span><span class="n">obj</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gc_mark_grey</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// remove gc root</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">gc_remove_root</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// decrease root ref count</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">gc_root_ref_count</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">gc_dec_root_ref_count</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next thing we need to do is to actually allocate the object itself and initialize it&rsquo;s <strong>gc_mark</strong>.
We also need to add it to white objects list as all new objects should be added to white list.
Without it we won&rsquo;t be able to track allocated objects. Look at how we also initialize references to <em>null</em>
based on how much references an object could contain. This is specified using <strong>refs_count</strong> argument to the function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// allocate gc_object</span>
</span><span class='line'><span class="n">gc_object</span><span class="o">*</span> <span class="nf">gc_alloc</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">refs_count</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// allocate new white object in generation 0 with 0 root ref count</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gc_object</span><span class="p">)</span> <span class="o">+</span> <span class="n">refs_count</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// initialize references</span>
</span><span class='line'>    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">refs_count</span> <span class="o">=</span> <span class="n">refs_count</span><span class="p">;</span> <span class="c1">// number of references this object might contain</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">**</span> <span class="n">refs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">**</span><span class="p">)(</span><span class="n">obj</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// start of refs array</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">refs_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>        <span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// set gc mark</span>
</span><span class='line'>    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// initial gc_mark value (0 generation white color)</span>
</span><span class='line'>    <span class="c1">// add object to white list</span>
</span><span class='line'>    <span class="n">gc_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">white</span><span class="p">,</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since our object could contain references we need a way to be able to modify those references.
Since we are introducing mutation we need to be able to revert the color of black object back to grey in order
to be able to recheck it during gc cycle. This operation is not expensive and is executed only once during mutation
between gc cycles if mutation of the object occurs thus we don&rsquo;t get any performance penalties by doing so each time on
reference modification.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// set object reference to another object</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">gc_set_ref</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">ref_index</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">ref</span><span class="p">){</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">**</span> <span class="n">refs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">**</span><span class="p">)(</span><span class="n">obj</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// start of refs array</span>
</span><span class='line'>    <span class="n">refs</span><span class="p">[</span><span class="n">ref_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// if object is black because it mutated we need to mark it grey again</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">gc_color_is_black</span><span class="p">(</span><span class="n">obj</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gc_mark_grey</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s start writing <strong>gc</strong> function. First we need to initialize cycle counters which we&rsquo;ll be used during our gc cycle. I&rsquo;ve added
this variables to <strong>gc_config</strong> <em>struct</em> just for the sake of simplicity.
First thing we are going to do during our gc cycle is to free all transparent objects that might have been left over from the previous gc cycle. Before freeing each object we call <strong>gc_finalize</strong> function from it&rsquo;s <em>class</em>. Note however that since we are writing an incremental garbage collector we need to be able to end the cycle prematurely if it takes too much time. To do so we&rsquo;ll be using <strong>gc_cycle_check</strong> <em>macro</em>. In order for <em>gc_cycle_check</em> to determine if the check for threshold should occur or not we increment <strong>cycle_threshold</strong> counter.
During <strong>gc_cycle_check</strong> we just check if <strong>cycle_threshold</strong> is bigger than configured <strong>pause_threshold</strong> and if it is we just check the amount of passed time in nano seconds since the start of the gc cycle. If the time passed exceeds <strong>max_pause</strong> configuration value we just call <strong>gc_cycle_end</strong> function and end cycle prematurely.
We&rsquo;ll rely on <strong>gc_cycle_check</strong> <em>macro</em> heavily through our entire gc cycle.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define gc_cycle_check \</span>
</span><span class='line'><span class="cp">if(conf.cycle_threshold &gt;= conf.pause_threshold){ \</span>
</span><span class='line'><span class="cp">    if((get_nanotime() - conf.cycle_time) &gt;= conf.max_pause){ \</span>
</span><span class='line'><span class="cp">        return gc_cycle_end(); \</span>
</span><span class='line'><span class="cp">    } \</span>
</span><span class='line'><span class="cp">    conf.cycle_objects += conf.cycle_threshold; \</span>
</span><span class='line'><span class="cp">    conf.cycle_threshold = 0; \</span>
</span><span class='line'><span class="cp">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// end gc cycle</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">gc_cycle_end</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_objects</span> <span class="o">+=</span> <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span><span class="p">;</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_duration</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">()</span> <span class="o">-</span> <span class="n">conf</span><span class="p">.</span><span class="n">cycle_time</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">conf</span><span class="p">.</span><span class="n">cycle_duration</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// start gc cycle</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_time</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">();</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_objects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_collected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_full</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// transparent cleanup phase before cycle</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">transparent</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>    <span class="p">(</span><span class="n">transparent</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_finalize</span><span class="p">)(</span><span class="n">transparent</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">transparent</span><span class="p">;</span>
</span><span class='line'>    <span class="n">transparent</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_collected</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// check pause threshold</span>
</span><span class='line'>    <span class="n">gc_cycle_check</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After cleaning up transparent list next thing what we are going to do is promote generations that need promotion and refresh those that need refreshment.
Now this might sound something complex but it&rsquo;s pretty much straight forward. We just track time of last promotion and refreshment for each generation in <strong>promotion_time</strong> and
<strong>refresh_time</strong> variables and compare them with configuration intervals called <strong>promotiona_interval</strong> and <strong>refresh_interval</strong> configured individually for each generation.
Note how we skip promotion of the last generation as there is no generation to promote to. During promotion what we are doing is just incrementing generation setting and moving
object from one generation black list to another. Note that while doing that we also check gc pause threshold using <strong>gc_cylce_check</strong> <em>macro</em>. During refresh we are checking root
reference count and based on that move objects either to <em>grey</em> list or <em>silver</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// promotion phase</span>
</span><span class='line'><span class="kt">uint64_t</span> <span class="n">time_now</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">();</span>
</span><span class='line'><span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycle_refreshed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycle_promoted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// promote generation</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_now</span> <span class="o">-</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promotion_time</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promotion_interval</span><span class="p">){</span>
</span><span class='line'>            <span class="k">do</span><span class="p">{</span>
</span><span class='line'>                <span class="n">gc_gen_set</span><span class="p">(</span><span class="n">obj</span><span class="p">,(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>                <span class="c1">// move to next generation</span>
</span><span class='line'>                <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycle_promoted</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="c1">// check pause threshold</span>
</span><span class='line'>                <span class="n">gc_cycle_check</span>
</span><span class='line'>                <span class="n">obj</span> <span class="o">=</span> <span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">null</span><span class="p">);</span>
</span><span class='line'>            <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promotion_time</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// refresh generation</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">time_now</span> <span class="o">-</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh_time</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh_interval</span><span class="p">){</span>
</span><span class='line'>            <span class="k">while</span><span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>                <span class="c1">// if has root references</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">gc_root_ref_count</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                    <span class="c1">// mark as grey</span>
</span><span class='line'>                    <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">gc_mark_grey</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                    <span class="c1">// mark as silver</span>
</span><span class='line'>                    <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="n">silver</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">gc_mark_silver</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cycle_refreshed</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="c1">// check pause threshold</span>
</span><span class='line'>                <span class="n">gc_cycle_check</span>
</span><span class='line'>                <span class="n">obj</span> <span class="o">=</span> <span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">conf</span><span class="p">.</span><span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refresh_time</span> <span class="o">=</span> <span class="n">get_nanotime</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next phase after promotion/refreshment is marking phase.
During this phase we go over all <em>grey</em> objects and mark them as <em>black</em> using class assigned <strong>gc_mark_black</strong> function pointer.
Now in our <em>gc_object</em>&rsquo;s class we assigned it to <strong>gc_object_mark_black</strong> function which is straightforward as we just iterate over
references object contains, mark them as <em>grey</em> if they are <em>white</em> or <em>silver</em> and after that mark object as <em>black</em>.
Note how we are using <strong>gc_cycle_check_no_return</strong> <em>macro</em> which is almost the same as <strong>gc_cycle_check</strong> <em>macro</em> except that it doesn&rsquo;t
 ends the cycle by calling <strong>gc_cycle_end</strong> as we are doing the same check in caller code using <strong>gc_cycle_check</strong> <em>macro</em>.
This is needed to end cycle prematurely from callee <em>gc_mark_black</em> function.
This might sound as overly complex but this way we can extend our garbage collector to support objects with any kind of reference layout which might come handy for future.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// mark phase</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">grey</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>    <span class="p">(</span><span class="n">grey</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_mark_black</span><span class="p">)(</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// check pause threshold</span>
</span><span class='line'>    <span class="n">gc_cycle_check</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define gc_cycle_check_no_return \</span>
</span><span class='line'><span class="cp">if(conf.cycle_threshold &gt;= conf.pause_threshold){ \</span>
</span><span class='line'><span class="cp">    if((get_nanotime() - conf.cycle_time) &gt;= conf.max_pause){ \</span>
</span><span class='line'><span class="cp">        return; \</span>
</span><span class='line'><span class="cp">    } \</span>
</span><span class='line'><span class="cp">    conf.cycle_objects += conf.cycle_threshold; \</span>
</span><span class='line'><span class="cp">    conf.cycle_threshold = 0; \</span>
</span><span class='line'><span class="cp">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// gc object mark black</span>
</span><span class='line'><span class="kt">void</span> <span class="n">gc_object_mark_black</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">**</span> <span class="n">refs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">**</span><span class="p">)(</span><span class="n">obj</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// start of refs array</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// for each ref</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">refs_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">gc_color_is_silver_or_white</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">])){</span>
</span><span class='line'>            <span class="c1">// mark object as grey</span>
</span><span class='line'>            <span class="n">gc_list_move</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">&amp;</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>            <span class="n">gc_mark_grey</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>            <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="c1">// check pause threshold</span>
</span><span class='line'>            <span class="n">gc_cycle_check_no_return</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// mark object as black</span>
</span><span class='line'>    <span class="n">gc_list_move</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">black</span><span class="p">[</span><span class="n">gc_gen_num</span><span class="p">(</span><span class="n">obj</span><span class="p">)]));</span>
</span><span class='line'>    <span class="n">gc_mark_black</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next comes the tricky part. Now we are left with <em>silver</em> objects that aren&rsquo;t entirely white or grey yet.
What we are going to do is to go through all generations starting with older ones and check if objects in that generation might contain
our <em>silver</em> object. This might sound trivial but it&rsquo;s more tricky. We are going to check our <em>silver</em> objects using <strong>gc_contains</strong> function pointer in the <em>class</em>
which in our case will point to <strong>gc_object_contains</strong> function. This is all for the same sake of extensibility of our garbage collector.
Now if the object is not found in all black objects of all generations we can safely mark it as <em>white</em>. On the other hand if it&rsquo;s found  we need to
first correct it&rsquo;s generation, mark it as <em>grey</em> and recheck all left over <em>grey</em> objects all over again in order to safely trace references that this object might contain which on the other hand might be some <em>silver</em> objects too. This way we decrease the amount of <em>silver</em> objects that we need to check to essential minimum as the operation itself is very expensive.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// mark silver phase</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">silver</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>    <span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="n">to_gen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">gens_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
</span><span class='line'>        <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">black</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_contains</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span><span class="n">silver</span><span class="p">)){</span>
</span><span class='line'>                <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>                <span class="n">to_gen</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">gc_cycle_check</span>
</span><span class='line'>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">found</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="o">--</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">found</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// correct generation and mark as grey</span>
</span><span class='line'>        <span class="n">gc_gen_set</span><span class="p">(</span><span class="n">silver</span><span class="p">,</span><span class="n">to_gen</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gc_mark_grey</span><span class="p">(</span><span class="n">silver</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gc_list_move</span><span class="p">(</span><span class="n">silver</span><span class="p">,</span><span class="o">&amp;</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>        <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// run mark grey phase</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">grey</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>            <span class="p">(</span><span class="n">grey</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_mark_black</span><span class="p">)(</span><span class="n">grey</span><span class="p">);</span>
</span><span class='line'>            <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="c1">// check pause threshold</span>
</span><span class='line'>            <span class="n">gc_cycle_check</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="c1">// mark as white</span>
</span><span class='line'>        <span class="n">gc_mark_white</span><span class="p">(</span><span class="n">silver</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gc_list_move</span><span class="p">(</span><span class="n">silver</span><span class="p">,</span><span class="o">&amp;</span><span class="n">white</span><span class="p">);</span>
</span><span class='line'>        <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// check pause threshold</span>
</span><span class='line'>    <span class="n">gc_cycle_check</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// this checks if object contains reference object</span>
</span><span class='line'><span class="n">bool</span> <span class="n">gc_object_contains</span><span class="p">(</span><span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">gc_object</span><span class="o">*</span> <span class="n">ref</span><span class="p">){</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">**</span> <span class="n">refs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gc_object</span><span class="o">**</span><span class="p">)(</span><span class="n">obj</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// start of refs array</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">refs_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally we need to sweep all <em>white</em> objects, by moving them to <em>transparent</em> list.
Next we just cleanup the <em>transparent</em> list again while also checking for the pause threshold using <strong>gc_cycle_check</strong> <em>macro</em> again.
And finally we mark cycle as full and end it using <strong>gc_cycle_end</strong> function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// sweep phase</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">white</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// make object transparent</span>
</span><span class='line'>    <span class="n">gc_list_move_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">white</span><span class="p">,</span><span class="o">&amp;</span><span class="n">transparent</span><span class="p">);</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">50</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// check pause threshold</span>
</span><span class='line'>    <span class="n">gc_cycle_check</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// transparent cleanup phase after cycle</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">transparent</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>    <span class="p">(</span><span class="n">transparent</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">gc_finalize</span><span class="p">)(</span><span class="n">transparent</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gc_object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">transparent</span><span class="p">;</span>
</span><span class='line'>    <span class="n">transparent</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gc_next</span><span class="p">;</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_threshold</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
</span><span class='line'>    <span class="n">conf</span><span class="p">.</span><span class="n">cycle_collected</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// check pause threshold</span>
</span><span class='line'>    <span class="n">gc_cycle_check</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// set cycle full</span>
</span><span class='line'><span class="n">conf</span><span class="p">.</span><span class="n">cycle_full</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nf">gc_cycle_end</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a garbage collector we need a way to test it to be sure it&rsquo;s working correctly.
To do that we&rsquo;ll create a micro DSL test language that will look like this. This language is inspired by a similar
language that I&rsquo;ve created to test memory allocator in previous article. This language is fairly compact.
Note that putting an object into the slot doesn&rsquo;t means it automatically has a root reference. Objects that don&rsquo;t have root reference or
are referenced by root objects might get deleted after gc but our test compiler will check that kind of objects during compilation so we won&rsquo;t have any <em>Segmentation Fault</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># one line comment starts with # character
</span><span class='line'>0=12   # allocate an object that can contain 12 references and set it to slot 0
</span><span class='line'>+0     # increment root reference count of the object that is in slot 0 
</span><span class='line'>-0     # decrement root reference count of the object that is in slot 0
</span><span class='line'>0[0]=1 # set first reference of object in slot 0 to be object in slot 1
</span><span class='line'>gc     # call garbage collector
</span><span class='line'>0=2 gc # multiple statements are separated by white space or new line</span></code></pre></td></tr></table></div></figure>


<p>In order to actually write tests for that I&rsquo;ve created <em>gctestgen.rb</em> <em>Ruby</em> script that can generate random test files of any size.
This test have iterations. In each iteration first we allocate objects, then we decrement root reference counts of some random objects from previous iteration.
After that we initialize references in objects randomly and run garbage collection. This way we simulate behaviour of an application allocating objects and running garbage collection.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># -n number of iterations</span>
</span><span class='line'><span class="c"># -c objects per iteration</span>
</span><span class='line'><span class="c"># -f maximum number of references object can have</span>
</span><span class='line'><span class="c"># -r percentage of root objects</span>
</span><span class='line'><span class="c"># -s percentage of survivors</span>
</span><span class='line'><span class="c"># -d percentage of root objects to decrement on next iteration</span>
</span><span class='line'><span class="nv">$ </span>./gctestgen.rb -n 60 -c 1000 -f 32 -s 20 -r 10 -d 5 &gt; test.t
</span></code></pre></td></tr></table></div></figure>


<p>Now in order to compile our test I wrote a mini meta-compiler <strong>gctest.rb</strong> in <em>Ruby</em> that generates <em>.c</em> file for testing and links it against our garbage collector and creates executable binary <strong>gctest</strong>.
While compiling it also simulates garbage collection (simple full garbage collection each time) and counts expected number of objects to survive entire test.
After that it runs that executable and compares it&rsquo;s output to expected count to proof correctness of the garbage collector. The source code is in repository so you could all study it.
The following initial configuration is provided for testing which is just 3 generations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// initialize gc object class</span>
</span><span class='line'><span class="n">cls</span><span class="p">.</span><span class="n">gc_mark_black</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc_object_mark_black</span><span class="p">;</span>
</span><span class='line'><span class="n">cls</span><span class="p">.</span><span class="n">gc_contains</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc_object_contains</span><span class="p">;</span>
</span><span class='line'><span class="n">cls</span><span class="p">.</span><span class="n">gc_finalize</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">garbage_collected_finalize</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// initialize gc configuration</span>
</span><span class='line'><span class="n">gc_config</span> <span class="n">config</span><span class="p">;</span>
</span><span class='line'><span class="n">gc_gen_config</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">refresh_interval</span> <span class="o">=</span> <span class="mi">500000ull</span><span class="p">;</span> <span class="c1">// 0.5 millis</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">promotion_interval</span> <span class="o">=</span> <span class="mi">1000000ull</span><span class="p">;</span> <span class="c1">// 1 millis</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">refresh_interval</span> <span class="o">=</span> <span class="mi">2000000ull</span><span class="p">;</span> <span class="c1">// 2 millis</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">promotion_interval</span> <span class="o">=</span> <span class="mi">6000000ull</span><span class="p">;</span> <span class="c1">// 6 millis</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">refresh_interval</span> <span class="o">=</span> <span class="mi">250000000ull</span><span class="p">;</span> <span class="c1">// 15 millis</span>
</span><span class='line'><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">promotion_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// not needed for last generation</span>
</span><span class='line'><span class="n">config</span><span class="p">.</span><span class="n">gens_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="n">config</span><span class="p">.</span><span class="n">gens</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'><span class="n">config</span><span class="p">.</span><span class="n">pause_threshold</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// 100 objects</span>
</span><span class='line'><span class="n">config</span><span class="p">.</span><span class="n">max_pause</span> <span class="o">=</span> <span class="mi">200000000</span><span class="p">;</span> <span class="c1">// 200 milliseconds</span>
</span><span class='line'><span class="n">gc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./gctest.rb ./test.t
</span><span class='line'>total object allocations: 60000
</span><span class='line'>expected number of objects to survive gc: 4606
</span><span class='line'>running gc <span class="nb">test</span>: ./test.t
</span><span class='line'>gc collected 850 objects took 1.02 millis <span class="o">[</span> 0/0 0/0 0/0 <span class="o">]</span>
</span><span class='line'>gc collected 850 objects took 0.07 millis <span class="o">[</span> 142/0 142/0 0/0 <span class="o">]</span>
</span><span class='line'>gc collected 850 objects took 0.07 millis <span class="o">[</span> 148/0 0/0 0/0 <span class="o">]</span>
</span><span class='line'>...........................................................
</span><span class='line'>gc collected 856 objects took 2.93 millis <span class="o">[</span> 147/0 0/301 0/0 <span class="o">]</span>
</span><span class='line'>gc collected 850 objects took 0.09 millis <span class="o">[</span> 150/0 359/0 0/0 <span class="o">]</span>
</span><span class='line'><span class="nb">test </span>ended, took 246.68 millis
</span><span class='line'>gc collected 0 objects took 200.00 millis <span class="o">[</span> 153/0 155/0 0/8561 <span class="o">]</span>
</span><span class='line'>gc collected 0 objects took 200.00 millis <span class="o">[</span> 0/0 0/0 0/0 <span class="o">]</span>
</span><span class='line'>gc collected 0 objects took 200.00 millis <span class="o">[</span> 0/0 0/0 0/0 <span class="o">]</span>
</span><span class='line'>gc collected 3955 objects took 111.26 millis <span class="o">[</span> 0/0 0/0 0/0 <span class="o">]</span>
</span><span class='line'>checked objects that survived: 4606
</span><span class='line'>garbage collected 55394
</span><span class='line'>actual survivors 4606
</span><span class='line'>expected survivors match with actual survivors
</span><span class='line'>total gc calls: 60
</span><span class='line'>total <span class="nb">time </span>spent in gc: 53.74 millis
</span></code></pre></td></tr></table></div></figure>


<p>As you can see test took 250ms to allocate 60000 objects. Garbage collector was called 60 times and overall took 53.74ms after which only 4606 objects survived.
We wrote a <em>Garbage Collector</em>, finally. That&rsquo;s it folks, have a nice garbage collector hacking time!!!
<img src="http://i.imgur.com/OIcxN1t.png" alt="Space Dandy &amp; Loli" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lifting Shadows off a Memory Allocation]]></title>
    <link href="http://troydm.github.io/blog/2015/08/03/lifting-shadows-off-a-memory-allocation/"/>
    <updated>2015-08-03T18:32:35+04:00</updated>
    <id>http://troydm.github.io/blog/2015/08/03/lifting-shadows-off-a-memory-allocation</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing power-of-2 malloc memory allocator in C</em></p>

<p>Any sufficiently advanced technology is indistinguishable from magic or so they say. Today we are going to lift some shadows from
the very basic thing that is dynamic memory management in an application process. This knowledge is essential for anyone who wants to write his/her own <em>Programming Language</em> so gaining this knowledge is not an optional thing since it opens a whole new lever of understanding how dynamic memory is managed by application and is split between different applications. To do that we need to have some basic understanding of how the actual physical thing is used by operating system. For those who don&rsquo;t know anything about <em>Virtual Memory</em> or what <em>Memory Pages</em> are and which algorithms modern operating systems are using to manage those I suggest reading <a href="http://www.amazon.com/Operating-System-Concepts-Abraham-Silberschatz/dp/1118063333/">Operating Systems Concepts</a> and for those who want to know all the guts of how <em>Linux</em> does this under the hood there is <a href="http://www.amazon.com/Understanding-Linux-Kernel-Third-Daniel/dp/0596005652/">Understanding Linux Kernel</a>.
<img src="http://i.imgur.com/VphDXNR.png" alt="Police Loli" /></p>

<!--more-->


<p>For the lazy rest to put it simply physical memory is split into fixed size blocks which are called <em>Memory Pages</em> and depending on the computer architecture and operating system can be 2kb 4kb 16kb 32kb or even 4mb in size. Anytime we request memory from operating system using some <em>syscall</em> it&rsquo;s best to have the size divisible by the actual operating operating system&rsquo;s <em>Memory Page</em> size. If used simply this tends to waste a lot of memory so hence we need a way to be more efficient with our requests and also we need to think of a way to recycle the memory requested before which isn&rsquo;t already needed by the application. All this opens a new area for exploration which is called Memory Allocation Algorithms and is quite a hot topic because not only we need to manage the recycling complexity but also concurrency and parallelism of the actual algorithms to be more efficient with modern multi-processor computers.
Some notable examples of algorithm that do that and are used in real world are <a href="http://g.oswego.edu/dl/html/malloc.html">Doug Lea&rsquo;s malloc</a>, <a href="http://tlsf.baisoku.org/">TLSF</a> and <a href="http://www.canonware.com/jemalloc/">jemalloc</a>, also there are much more out there. In order to explore some basic ideas about memory allocators we&rsquo;ll write the simplest algorithm commonly called power of 2. The essential idea behind it is to split blocks of memory into sizes divisible by 2 such as 32, 64, 128 and etc. By doing so we could reuse already used blocks by breaking them into more smaller onces. For example 128 block can be broken into 2 blocks of 64 and each of them can also further be broken to 32 sized blocks.</p>

<p><canvas id="memoryBlock" width="400" height="75"></canvas></p>

<script>
var c = document.getElementById("memoryBlock");
var ctx = c.getContext("2d");
ctx.font="normal 12pt Sans";
ctx.fillStyle = "#F8D7BB";
ctx.strokeStyle = "#000000";
ctx.fillRect(0,0,400,75);
ctx.moveTo(0,0);
ctx.lineTo(400,0);
ctx.stroke();
ctx.moveTo(0,0);
ctx.lineTo(0,75);
ctx.stroke();
ctx.moveTo(0,75);
ctx.lineTo(400,75);
ctx.stroke();
ctx.moveTo(400,0);
ctx.lineTo(400,75);
ctx.stroke();
ctx.moveTo(0,25);
ctx.lineTo(400,25);
ctx.stroke();
ctx.moveTo(200,25);
ctx.lineTo(200,75);
ctx.stroke();
ctx.moveTo(100,50);
ctx.lineTo(100,75);
ctx.stroke();
ctx.moveTo(0,50);
ctx.lineTo(200,50);
ctx.stroke();
ctx.moveTo(300,50);
ctx.lineTo(300,75);
ctx.stroke();
ctx.moveTo(200,50);
ctx.lineTo(400,50);
ctx.stroke();
ctx.moveTo(200,50);
ctx.lineTo(400,50);
ctx.stroke();
ctx.fillStyle = "#000000";
ctx.fillText("128",185,18);
ctx.fillText("64",92,43);
ctx.fillText("64",292,43);
ctx.fillText("32",46,67);
ctx.fillText("32",148,67);
ctx.fillText("32",246,67);
ctx.fillText("32",338,67);
</script>


<p>In general this tends to waste a lot of memory and introduces memory fragmentation. In worst case scenario half of all requested memory is wasted but usually in real world cases the actual number is near 25%. The memory wasting cost has computing performance gain as the algorithm itself is not hard to implement and works faster than more complex but conservative ones. Hence we are going to write a simple memory allocator also commonly called <em>malloc</em> since this is the library function name used by standard <em>C</em> library for allocating dynamic memory of variable size for the application process. We are going to implement our version of that function and related functions. Our target platform will be <em>Linux</em> and <em>gcc</em> compiler since we aren&rsquo;t going to bother with portability as this will take much more time and effort. Final version of source code can be browsed in <a href="https://github.com/troydm/mymalloc">mymalloc</a> repo but I strongly encourage you to write the whole thing from scratch yourself just to better understand the actual processes under the hood.</p>

<p>First let&rsquo;s start with function definitions that we need to reimplement. Create a file called <strong>mymalloc.h</strong>. We&rsquo;ll also define some functions for debug/stats purposes as those will be helpful during development process. Note: all this functions are defined by glibc in linux so gcc will complain about them being redefined during compilation but you can ignore those messages.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">calloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nmemb</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">realloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ns</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="c1">// for debug use only</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">print_block_info</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">print_freelist</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create a file called <strong>mymalloc.c</strong> and define the actual functions. We&rsquo;ll start with some initial values which are provided by operating system. The defined values are self explaining however I need to clarify the choice with 32 bytes for minimum block size. Since we&rsquo;ll manage memory blocks as doubly linked list nodes, each memory block needs to have space for at least two pointers and one size value which can&rsquo;t be more than the pointer size so that&rsquo;s 3 pointers for each node. Maximum size for 3 pointers for 64-bit operating system is 8 bytes so it&rsquo;s overall 24 bytes however block size needs to be power of 2 value and nearest size is 2<sup>5</sup> hence 32.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// for code clarity for pointers we use null instead of 0
</span><span class='line'>#define null 0
</span><span class='line'>
</span><span class='line'>// initial values
</span><span class='line'>#define PAGE_SIZE (sysconf(_SC_PAGESIZE))
</span><span class='line'>#define MIN_BLOCK_SIZE 32 // bytes</span></code></pre></td></tr></table></div></figure>


<p>We need a place to save free memory blocks and a way to manage them so let&rsquo;s first describe what memory block is and define initial doubly linked list for it that will contain <em>start</em> and <em>end</em> nodes pointing at each other. Those nodes won&rsquo;t be used and are there just so that our code won&rsquo;t contain conditional <em>if</em> statements when handling nodes.</p>

<p><canvas id="freelist" width="600" height="75"></canvas></p>

<script>
function drawRect(ctx,text,x,y,w,h){
    ctx.fillRect(x,y,w,h);
    ctx.moveTo(x,y);
    ctx.lineTo(x,y+h);
    ctx.stroke();
    ctx.moveTo(x,y);
    ctx.lineTo(x+w,y);
    ctx.stroke();
    ctx.moveTo(x+w,y);
    ctx.lineTo(x+w,y+h);
    ctx.stroke();
    ctx.moveTo(x,y+h);
    ctx.lineTo(x+w,y+h);
    ctx.stroke();
    var fs = ctx.fillStyle;
    ctx.fillStyle = "#000000";
    var tl = 16*text.length;
    ctx.fillText(text,x+(w/2)-(tl/4),y+(h/2)+4);
    ctx.fillStyle = fs;
}

function drawArrow(ctx,x1,y1,x2,y2){
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();

    ctx.moveTo(x1,y1);
    ctx.lineTo(x1+3,y1-4);
    ctx.stroke();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x1+3,y1+4);
    ctx.stroke();

    ctx.moveTo(x2,y2);
    ctx.lineTo(x2-3,y2-4);
    ctx.stroke();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2-3,y2+4);
    ctx.stroke();
}

var c = document.getElementById("freelist");
var ctx = c.getContext("2d");
ctx.font="normal 12pt Sans";
ctx.fillStyle = "#F8D7BB";
ctx.strokeStyle = "#000000";

drawRect(ctx,"start",0,20,100,50);
drawRect(ctx,"memory block",150,20,200,50);
drawRect(ctx,"end",400,20,100,50);
drawArrow(ctx,80,45,165,45);
drawArrow(ctx,340,45,415,45);

ctx.fillStyle = "#000000";
ctx.fillText("Freelist",2,13);
</script>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// memory block structure</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">memory_block_t</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">memory_block_t</span><span class="o">*</span> <span class="n">prev</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">memory_block_t</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">memory_block</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// free memory block list</span>
</span><span class='line'><span class="k">static</span> <span class="n">memory_block</span> <span class="n">freelist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">freelist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">},</span>  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">freelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">null</span><span class="p">}</span> <span class="p">};</span>
</span><span class='line'><span class="cp">#define freelist_start (freelist[0].next)</span>
</span><span class='line'><span class="cp">#define freelist_begin (&amp;(freelist[0]))</span>
</span><span class='line'><span class="cp">#define freelist_end (&amp;(freelist[1]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that when memory block will be used by an application it needs to have only size value reserved because we don&rsquo;t need doubly linked pointers as it&rsquo;s not in a free block list. Thus we need a method to reserve memory block&rsquo;s size field when we return it to the application. In order to ease interaction with memory block structure and it&rsquo;s pointers let&rsquo;s define some useful macros that will help us elevate the task of specifying casts manually. Pointer arithmetic can be sometimes daunting and puzzling in <em>C</em> but if used correctly it&rsquo;s very powerful feature and macro system helps us do exactly that. We also need an easy way to link two memory blocks with each other and even sometimes replace those links so we&rsquo;ll define some macros for that kind of operations too.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// useful macros
</span><span class='line'>#define byte_ptr(p) ((uint8_t*)p)
</span><span class='line'>#define shift_ptr(p,s) (byte_ptr(p)+s)
</span><span class='line'>#define shift_block_ptr(b,s) ((memory_block*)(shift_ptr(b,s)))
</span><span class='line'>#define block_data(b) (shift_ptr(b,sizeof(size_t)))
</span><span class='line'>#define data_block(p) (shift_block_ptr(p,-sizeof(size_t)))
</span><span class='line'>#define block_end(b) (shift_block_ptr(b,b->size))
</span><span class='line'>
</span><span class='line'>#define block_link(lb,rb) \
</span><span class='line'>    rb->prev = lb; \
</span><span class='line'>    lb->next = rb;
</span><span class='line'>
</span><span class='line'>#define block_link_left(lb,b) \
</span><span class='line'>    block_link(b->prev,lb) \
</span><span class='line'>    block_link(lb,b)
</span><span class='line'>
</span><span class='line'>#define block_link_right(b,rb) \
</span><span class='line'>    block_link(rb,b->next) \
</span><span class='line'>    block_link(b,rb)
</span><span class='line'>
</span><span class='line'>#define block_unlink(b) \
</span><span class='line'>    block_link(b->prev,b->next)
</span><span class='line'>
</span><span class='line'>#define block_unlink_right(b) \
</span><span class='line'>    block_unlink(b->next);
</span><span class='line'>
</span><span class='line'>#define block_replace(b,nb) \
</span><span class='line'>    block_link(b->prev,nb) \
</span><span class='line'>    block_link(nb,b->next)</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s start with <em>malloc</em> function, first of all let&rsquo;s correct initial size and add to it <em>sizeof(size_t)</em> since each allocated by an application block will preserve it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// check for 0 size</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// add size of size_t as we need to save size of memory block</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// find suitable memory size</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">find_optimal_memory_size</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next as you can see we need to find an optimal size for requested size <em>s</em>. We&rsquo;ll use a famous trick with bitwise shifting value to right in order to get optimal size for our memory block starting with <em>MIN_BLOCK_SIZE</em>. So the sizes in <em>while</em> loop will go from 32, 64, 128, 256 and further.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// find optimal memory block size for size s</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">find_optimal_memory_size</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">suitable_size</span> <span class="o">=</span> <span class="n">MIN_BLOCK_SIZE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">suitable_size</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>        <span class="n">suitable_size</span> <span class="o">=</span> <span class="n">suitable_size</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">suitable_size</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we need to handle large memory blocks. We&rsquo;ll be allocating those using <em>mmap</em> <em>syscall</em> which gives us an arbitary memory block for requested size usually rounded to page size. In worst case we are loosing <em>PAGE_SIZE</em>-1 bytes, however for large memory blocks which we are going to handle separately we can ignore it because block might be resized using <em>mremap</em> <em>syscall</em> in the future reclaiming page which wasn&rsquo;t used entirely before.
Note: we&rsquo;ve also added definition of MMAP_SIZE to our initial value definitions and set it equal to 1 MB.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="c1">// if size is greater than or equals MMAP_SIZE we are going to use mmap</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">ns</span> <span class="o">&gt;=</span> <span class="n">MMAP_SIZE</span><span class="p">){</span>
</span><span class='line'>        <span class="kt">void</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_block</span><span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">;</span>
</span><span class='line'>        <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>        <span class="n">lock</span>
</span><span class='line'>        <span class="n">mmap_size</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>        <span class="n">unlock</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">block_data</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you&rsquo;ve already noticed we&rsquo;ve used strange <em>lock</em> and <em>unlock</em> macros there. That&rsquo;s because we&rsquo;ll also be counting overall <em>mmap</em> blocks in <em>mmap_size</em> variable purely for statistical purposes. However since <em>malloc</em> function can be called from different threads simultaneously we need a way to synchronize modifications to this variable. And not only this variable can be modified simultaneously. Unfortunately as we are striving for most efficiency we can&rsquo;t use immutable data structures for <em>freelist</em> and we need a way to concurrently modify it so that in the end all modifications would be consistent. Let&rsquo;s use atomic <a href="https://en.wikipedia.org/wiki/Spinlock">spinlock</a> for all our concurrency needs. For a description of what atomic spinlock is try reading <a href="https://idea.popcount.org/2012-09-12-reinventing-spinlocks/">Marek&rsquo;s Reinventing Spinlocks</a> as the code below was shamelessly copied from there. Also instead of simple freelist we could use lock-free doubly linked list data structure but since we are focusing our efforts on memory allocation I won&rsquo;t describe it in here.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// locking</span>
</span><span class='line'><span class="k">volatile</span> <span class="n">bool</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">spinlock</span><span class="p">(){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__sync_bool_compare_and_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)){</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">__sync_bool_compare_and_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locked</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">else</span><span class="p">{</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">){</span>
</span><span class='line'>                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">sched_yield</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span><span class="k">else</span>
</span><span class='line'>                    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define lock spinlock();</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define unlock \</span>
</span><span class='line'><span class="cp">    __asm__ __volatile__ (&quot;&quot; ::: &quot;memory&quot;); \</span>
</span><span class='line'><span class="cp">    locked = 0;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s continue our effort with <em>malloc</em> function. Now we need to handle blocks with size less than <em>MMAP_SIZE</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">lock</span>
</span><span class='line'>    <span class="c1">// find free memory block</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">block</span> <span class="o">=</span> <span class="n">find_suitable_block</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">block</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="n">unlock</span>
</span><span class='line'>        <span class="c1">// shift pointer into data block pointer</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">block_data</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to find suitable block from memory list we&rsquo;ll just look through it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// find suitable memory block for size s</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">memory_block</span><span class="o">*</span> <span class="nf">find_suitable_block</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">ns</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_start</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">freelist_end</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">){</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">split_memory_block</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now what if block is sufficient for our needs. We need to split it or return it whole if it&rsquo;s needed entirely. The half left will be added back to <em>freelist</em> if <em>remainder</em> is more than or equals <em>MIN_BLOCK_SIZE</em> since there is no way we could add a block with less size.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// split memory block into 2 pieces one of size s and the other is remainder e.g. memory_block_size-s</span>
</span><span class='line'><span class="c1">// if remainder is less than MIN_BLOCK_SIZE we just take whole block</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">memory_block</span><span class="o">*</span> <span class="nf">split_memory_block</span><span class="p">(</span><span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">remainder</span> <span class="o">&gt;=</span> <span class="n">MIN_BLOCK_SIZE</span><span class="p">){</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="n">nb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
</span><span class='line'>        <span class="n">block_replace</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">nb</span><span class="p">);</span>
</span><span class='line'>        <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="n">block_unlink</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But wait, what if there are no free memory blocks? Let&rsquo;s allocate some memory from heap using <em>sbrk</em> <em>syscall</em>. Now the difference with <em>sbrk</em> versus <em>mmap</em> is that <em>sbrk</em> allocates continuous virtual memory or simply speaking grows heap outward (note: stack grows inward and heap outward so when those two meet each other ka-boom!). For those of you who don&rsquo;t know what heap is try reading <a href="http://www.geeksforgeeks.org/memory-layout-of-c-program/">this</a>. Unfortunately <em>sbrk</em> is slower than <em>mmap</em> performance-wise, but we need a specific property of memory allocated using <em>sbrk</em> so we&rsquo;ll be using it exclusively for that. Each newly allocated block has higher memory address than previous one and both of them are adjacent. We&rsquo;ll use this property to always have a sorted freelist in order to connect adjacent memory blocks more easily and quicker. This is our way to fight memory fragmentation. Also in order to minimize number of <em>sbrk</em> calls we&rsquo;ll allocate memory by larger chunks specified in <em>ALLOC_SIZE</em> instead of just number of pages we need.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="c1">// no free memory blocks found</span>
</span><span class='line'>    <span class="c1">// we need to allocate new one that would be suitable for our needs using sbrk</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">pages_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">ns</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pages_size</span> <span class="o">&lt;</span> <span class="n">ALLOC_SIZE</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pages_size</span> <span class="o">=</span> <span class="n">ALLOC_SIZE</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// allocate memory with sbrk</span>
</span><span class='line'>    <span class="kt">void</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="n">pages_size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>        <span class="n">unlock</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next after allocating new block using <em>sbrk</em> we just split it and add back to <em>freelist</em>. We are also counting the overall heap size allocated by <em>sbrk</em> calls just for stats. Also we save <em>heap_start</em> and <em>heap_end</em> in order to distinguish memory blocks allocated using <em>sbrk</em> from <em>mmap</em> blocks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_block</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>    <span class="n">heap_size</span> <span class="o">+=</span> <span class="n">pages_size</span><span class="p">;</span>
</span><span class='line'>    <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
</span><span class='line'>    <span class="n">heap_end</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">pages_size</span><span class="p">);</span>
</span><span class='line'>    <span class="n">heap_start</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">heap_end</span><span class="p">,</span><span class="o">-</span><span class="n">heap_size</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ns</span> <span class="o">=</span> <span class="n">pages_size</span> <span class="o">-</span> <span class="n">ns</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">ns</span> <span class="o">&gt;=</span> <span class="n">MIN_BLOCK_SIZE</span><span class="p">){</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>        <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
</span><span class='line'>        <span class="n">add_block</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">unlock</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">block_data</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the only thing left is to add the free block to the <em>freelist</em>. This might sound trivial but we need to handle a little bit more complexity than there might seem. First of all we need to insert blocks in sorted order. Next after inserting free block we need to merge it with adjacent blocks near on the left and right from it, if those blocks are continuously allocated in virtual memory space.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// add block to free list</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">add_block</span><span class="p">(</span><span class="n">memory_block</span><span class="o">*</span> <span class="n">block</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">freelist_start</span> <span class="o">!=</span> <span class="n">freelist_end</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// find superseding memory block</span>
</span><span class='line'>        <span class="c1">// and insert current one before it</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_start</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>            <span class="c1">// superseding memory block will have higher memory address</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">block</span><span class="p">){</span>
</span><span class='line'>                <span class="n">block_link_left</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// check if we hit end</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">freelist_end</span><span class="p">){</span>
</span><span class='line'>                <span class="n">block_link_right</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">block</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// merge adjacent blocks</span>
</span><span class='line'>        <span class="n">bool</span> <span class="n">merged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">merged</span><span class="p">){</span>
</span><span class='line'>            <span class="c1">// merge right adjacent block</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">block_end</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">){</span>
</span><span class='line'>                <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>                <span class="n">block_unlink_right</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// merge left adjacent block</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">block_end</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span> <span class="o">==</span> <span class="n">block</span><span class="p">){</span>
</span><span class='line'>                <span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
</span><span class='line'>                <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>                <span class="n">block_unlink_right</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">merged</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="c1">// add first memory block</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_begin</span><span class="p">;</span>
</span><span class='line'>        <span class="n">block_link_right</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it with <em>malloc</em> now let&rsquo;s write <em>free</em>. As you can see below we check if memory block is allocated using <em>mmap</em> and <em>munmap</em> it. Otherwise we add it back to <em>freelist</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// mmap</span>
</span><span class='line'><span class="cp">#define is_mmap_block(b) (!(heap_start &lt;= b &amp;&amp; b &lt; heap_end))</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// check for null pointer</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// shift pointer back into memory block pointer</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lock</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">is_mmap_block</span><span class="p">(</span><span class="n">b</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">mmap_size</span> <span class="o">-=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>        <span class="n">unlock</span>
</span><span class='line'>        <span class="n">munmap</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// add removed block into freelist</span>
</span><span class='line'>    <span class="n">add_block</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally we are checking the end of heap and give back free memory to operating system using <em>sbrk</em> with negative size if the size is at least <em>GIVE_BACK_SIZE</em> which we&rsquo;ve also added to initial values.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="c1">// give last memory block that isn&#39;t needed back to the operating system</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_end</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">block_end</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">heap_end</span><span class="p">){</span>
</span><span class='line'>        <span class="kt">intptr_t</span> <span class="n">inc</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">inc</span> <span class="o">&gt;=</span> <span class="n">GIVE_BACK_SIZE</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">heap_start</span><span class="p">){</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="n">GIVE_BACK_SIZE</span><span class="p">){</span>
</span><span class='line'>                    <span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span> <span class="o">-</span> <span class="n">GIVE_BACK_SIZE</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">sbrk</span><span class="p">(</span><span class="o">-</span><span class="n">inc</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">GIVE_BACK_SIZE</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                <span class="n">block_unlink</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>                <span class="n">sbrk</span><span class="p">(</span><span class="o">-</span><span class="n">inc</span><span class="p">);</span>
</span><span class='line'>                <span class="n">heap_size</span> <span class="o">-=</span> <span class="n">inc</span><span class="p">;</span>
</span><span class='line'>                <span class="n">heap_end</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">heap_end</span><span class="p">,</span><span class="o">-</span><span class="n">inc</span><span class="p">);</span>
</span><span class='line'>                <span class="n">heap_start</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">heap_end</span><span class="p">,</span><span class="o">-</span><span class="n">heap_size</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">unlock</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next after <em>free</em> let&rsquo;s implement <em>realloc</em>. As you can see it mostly repeats malloc, however we are using <em>mremap</em> for <em>mmap</em> blocks since those are already allocated and we need to resize them.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">realloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// shift pointer back into memory block pointer</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// find out which new optimal size we need</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">s</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">find_optimal_memory_size</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// if memory is mmap we need to use mremap</span>
</span><span class='line'>    <span class="n">lock</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">is_mmap_block</span><span class="p">(</span><span class="n">b</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">mmap_size</span> <span class="o">-=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>        <span class="n">mmap_size</span> <span class="o">+=</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>        <span class="n">unlock</span>
</span><span class='line'>        <span class="kt">void</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mremap</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">ss</span><span class="p">,</span><span class="n">MREMAP_MAYMOVE</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_block</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">block_data</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we check if block already contains the necessary size or the size can be obtained by connecting adjacent blocks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">ns</span> <span class="o">&lt;</span> <span class="n">MMAP_SIZE</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// check if size is already sufficient</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">){</span>
</span><span class='line'>            <span class="n">unlock</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef MERGE_ADJ_ON_REALLOC</span>
</span><span class='line'>        <span class="c1">// try merging with adjacent blocks</span>
</span><span class='line'>        <span class="n">memory_block</span><span class="o">*</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">merge_with_adjacent_block</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">nb</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>            <span class="n">unlock</span>
</span><span class='line'>            <span class="c1">// shift pointer into data block pointer</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">block_data</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">unlock</span>
</span></code></pre></td></tr></table></div></figure>


<p>Merging with adjacent block is quite complex operation thus we make it configurable so that if necessary we can always disable it. We handle both left and right adjacent cases. Left one is more complex and right one is simpler. Also we need to split block before connecting it with our initial one if the size has <em>remainder</em>, hence the complexity.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// merge with adjacent block so that overall new size would be s</span>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">memory_block</span><span class="o">*</span> <span class="nf">merge_with_adjacent_block</span><span class="p">(</span><span class="n">memory_block</span><span class="o">*</span> <span class="n">block</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">freelist_start</span> <span class="o">==</span> <span class="n">freelist_end</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_start</span><span class="p">;</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">be</span> <span class="o">=</span> <span class="n">block_end</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// left adjacent</span>
</span><span class='line'>        <span class="c1">// code is slightly more complex as we need to copy data over</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">block_end</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">block</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">((</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>                <span class="kt">size_t</span> <span class="n">remainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>                <span class="c1">// we need to backup block pointers as they might be overwritten by memcpy</span>
</span><span class='line'>                <span class="n">memory_block</span><span class="o">*</span> <span class="n">temp_prev</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
</span><span class='line'>                <span class="n">memory_block</span><span class="o">*</span> <span class="n">temp_next</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>                <span class="n">memcpy</span><span class="p">(</span><span class="n">block_data</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">block_data</span><span class="p">(</span><span class="n">block</span><span class="p">),</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">remainder</span> <span class="o">&gt;=</span> <span class="n">MIN_BLOCK_SIZE</span><span class="p">){</span>
</span><span class='line'>                    <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">memory_block</span><span class="o">*</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">nb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">block_link</span><span class="p">(</span><span class="n">temp_prev</span><span class="p">,</span><span class="n">nb</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">block_link</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">temp_next</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                    <span class="c1">// unfortunetly here we can&#39;t use b-&gt;prev as </span>
</span><span class='line'>                    <span class="c1">// it might have been overwritten by memcpy</span>
</span><span class='line'>                    <span class="c1">// so we need to remove remaining block entirely using temporary pointers</span>
</span><span class='line'>                    <span class="n">block_link</span><span class="p">(</span><span class="n">temp_prev</span><span class="p">,</span><span class="n">temp_next</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// right adjacent</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">be</span> <span class="o">==</span> <span class="n">b</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">((</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">){</span>
</span><span class='line'>                <span class="kt">size_t</span> <span class="n">remainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">remainder</span> <span class="o">&gt;=</span> <span class="n">MIN_BLOCK_SIZE</span><span class="p">){</span>
</span><span class='line'>                    <span class="n">memory_block</span><span class="o">*</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">shift_block_ptr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">nb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">block_replace</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">nb</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">block</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                    <span class="n">block_unlink</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">block</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">freelist_end</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="n">be</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally we handle the case when there is no memory to merge and no to resize. We just allocate a new memory and copy data over into it. Afterwards we deallocate the previous memory block.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="kt">void</span><span class="o">*</span> <span class="n">np</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">np</span> <span class="o">!=</span> <span class="n">null</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// copy old data block into new one</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">?</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">:</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// free old data block</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// return newly allocated block</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">np</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Main work is done, remaining are just supplementary functions which are self explanatory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">calloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nmemb</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
</span><span class='line'>    <span class="n">size</span> <span class="o">=</span> <span class="n">nmemb</span><span class="o">*</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">void</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">print_block_info</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// shift pointer back into memory block pointer</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>    <span class="n">lock</span>
</span><span class='line'>    <span class="n">print_block</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="n">unlock</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">print_freelist</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">lock</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[heap size %d mb mmap_size %d mb, &quot;</span><span class="p">,(</span><span class="n">heap_size</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)),(</span><span class="n">mmap_size</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)));</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;freelist {&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memory_block</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">freelist_start</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">freelist_end</span><span class="p">){</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p[%u|%p|%p]&quot;</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// detect infinite loop if any</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">){</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; infinite loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">unlock</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to test/benchmark this whole thing I wrote a little application which is called <em>memsim</em> and is in <a href="https://github.com/troydm/mymalloc/">mymalloc</a> repo. It reads memory allocation simulation file without requesting any dynamic memory from filesystem and calls malloc, realloc, free and user provided custom stats function while counting timings and overall runtime without using any heap memory, internally allocating memory on stack using <em>alloca</em> function, so that it&rsquo;s workings don&rsquo;t affecting the testing process. In order to generate a complex memory simulation (which is just a simple text file) I wrote <em>genrandms</em> application that just does that. Now a little benchmarks to compare our malloc with glibc <em>malloc</em> on some intense scenario. <em>mymemsim</em> and <em>sysmemsim</em> are <em>memsim</em> executables linked against our malloc implementation and glibc malloc implementation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Single threaded scenario repeat 50 times   </span>
</span><span class='line'><span class="nv">$ </span>./mymemsim -t 1 -r 50 test.ms
</span><span class='line'>memory simulation took 3457ms
</span><span class='line'><span class="nv">$ </span>./sysmemsim -t 1 -r 50 test.ms
</span><span class='line'>memory simulation took 15157ms
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s try a multithreading benchmark</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Multi threaded 20 threads each repeat scenario 20 times</span>
</span><span class='line'><span class="nv">$ </span>./mymemsim -t 20 -r 20 test.ms
</span><span class='line'>memory simulation took 64268ms
</span><span class='line'><span class="nv">$ </span>./sysmemsim -t 20 -r 20 test.ms
</span><span class='line'>memory simulation took 117117ms
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately our malloc implementation is not as multithread friendly as it can be. We literally have one single global spinlock and we always lock it when we allocate memory. We can improve on that by splitting <em>freelist</em> into different partitions. This will sacrifice memory fragmentation fighting however will improve scalability over multiple processors as we can have different spinlocks for each partition and won&rsquo;t have to wait between them. The implementation is more complex and can be studied in <a href="https://github.com/troydm/mymalloc">mymalloc</a> repo <strong>mysmalloc.c</strong> file despite overall idea being simple. Let&rsquo;s benchmark it again.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Multi threaded 20 threads each repeat scenario 20 times</span>
</span><span class='line'><span class="nv">$ </span>./mymemsim -t 20 -r 20 test.ms
</span><span class='line'>memory simulation took 69510ms
</span><span class='line'><span class="nv">$ </span>./mysmemsim -t 20 -r 20 test.ms
</span><span class='line'>memory simulation took 43322ms
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we&rsquo;ve improved performance by partially sacrificing fragmentation, improving scalability, and partially increasing memory usage. Further improvements and experiments are possible as possibilities are countless however our time has run out so that&rsquo;s it for today folks! Have a nice memory hacking time!
<img src="http://i.imgur.com/qBrTRxO.png" alt="Smoking is bad for health" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Write you a Monad for no particular reason at all!]]></title>
    <link href="http://troydm.github.io/blog/2015/01/25/write-you-a-monad-for-no-particular-reason-at-all/"/>
    <updated>2015-01-25T19:01:12+04:00</updated>
    <id>http://troydm.github.io/blog/2015/01/25/write-you-a-monad-for-no-particular-reason-at-all</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing functional programming library in Java</em></p>

<p><a href="http://en.wikipedia.org/wiki/Functional_programming">Functional Programming</a> paradigm and languages that fully utilize it&rsquo;s benefits are slowly gaining popularity nowadays not only in academia but also in enterprise becoming de facto standard for future generations of programmers. Maybe in 10 years from now humanity will come up with a better idea of how to make bug-free quality software that does the job and takes less effort to produce, however currently we are living in a century of <em>Object Oriented</em> programming systems slowly morphing into <em>Functional Programming</em> systems. There are a lot of learning resources on internet about <a href="https://www.quora.com/What-are-some-good-resources-for-learning-about-functional-programming-Why">Function Programming</a> in general and Functional Languages such as <a href="https://www.haskell.org/">Haskell</a>, <a href="http://www.erlang.org/">Erlang</a>, <a href="http://www.scala-lang.org/">Scala</a>, <a href="http://clojure.org/">Clojure</a> and many other. You all probably heard about <a href="http://learnyouahaskell.com/">Learn you a Haskell for Great Good</a> book, a really bright, colorful and interesting book that got me into Haskell programming few years ago. Some of you may even tried reading it. I think most of people without prior functional programming experience that start reading it sooner or later hit a bottom of their mental capacity while trying to comprehend <em>Monads</em>. This article is intended for this people! Yes this post is all about <em>Functors</em> and <em>Monads</em> you heard it right! In order to explore the ideas of functional programming let&rsquo;s create a small functional programming library in <strong>Java</strong> that will have <em>Functors</em> and <em>Monads</em> and by doing so learn about functional programming from a really unusual perspective of using Object Oriented programming. Our target compiler will be <strong>Java 6</strong> (yes we won&rsquo;t be using new fancy <strong>Java 8</strong>) as most of the people that are reading this now are probably more familiar with it rather than newer version. For those of you who are too lazy to follow can check the whole thing at my <a href="https://github.com/troydm/fpj">fpj</a> repository, however I strongly encourage you to try reimplement it all by yourself from scratch. The information described in this post implies that you have prior experience or basic understand of <em>Monads</em> but want to better understand them internally. So let&rsquo;s get to work!</p>

<p><img src="http://i.imgur.com/xT0ABh8.gif" alt="Rikka loli" /></p>

<!-- more -->


<p>First of all let&rsquo;s start with key concept of functional programming, a <em>function</em>. A <em>function</em> is something that takes <strong>A</strong> and produces <strong>B</strong> by a process called application of <em>function</em>. Let&rsquo;s implement it in <strong>Java</strong> using generic interface. Basically any object that implements that interface can be considered a valid function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">B</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A predicate is a function that takes <strong>A</strong> and produces boolean value.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wait what if we don&rsquo;t need to produce any result or have any argument what we should do then? A Unit is an object that represents exactly this or simply nothing.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Unit</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Unit</span> <span class="n">unit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Unit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Unit</span> <span class="nf">unit</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">unit</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What if we need to take more than one object and produce more too? That&rsquo;s what a <em>Tuple</em> is for. You can even use <em>Tuple</em> to combine more than two objects by putting a <em>Tuple</em> inside another <em>Tuple</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">A</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">B</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">tuple</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;first argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;second argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Tuple</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">first</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getFirst</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">B</span> <span class="nf">second</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">B</span> <span class="nf">getSecond</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s discover a way of how to use functions. Let&rsquo;s define a helper class called <em>Functional</em> and put some static methods into it. The functions we are going to write are so simple and common that any functional programmer can&rsquo;t live without them. First of all what can we do with functions? Yes definitely we can combine a function with another function so basically if we have a function that takes <strong>A</strong> and produces <strong>B</strong>, and we have a function that takes <strong>B</strong> and produces <strong>C</strong> we can combine this two into a function that has a following type description <strong>A</strong> <em>&ndash;></em> <strong>C</strong> (following from here we&rsquo;ll be using a short notion of <strong>A</strong> <em>&ndash;></em> <strong>B</strong> to describe a function that takes <strong>A</strong> and produces <strong>B</strong>).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">compose</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">g</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">C</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What else can we do with functions? Yes, exactly we can map them over a <em>Collection</em> of objects and produce a <em>Collection</em> of results.
So if we have a function <strong>A</strong> <em>&ndash;></em> <strong>B</strong> and a <em>Collection</em> of <strong>A</strong> objects we can map it over that <em>Collection</em> to produce resulting <em>Collection</em> of <strong>B</strong> objects.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Functional</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">ac</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">ac</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bc</span><span class="o">){</span>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>            <span class="n">bc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">bc</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we don&rsquo;t need results we can just do foreach over this <em>Collection</em> same way, throwing away function result each time we apply the function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">foreach</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>            <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also fold a value over collection using a function. So basically if we have initial value of <strong>A</strong>, <em>Collection</em> of <strong>B</strong> and function that takes <strong>A</strong> <em>&ndash;></em> <strong>B</strong> <em>&ndash;></em> <strong>A</strong> we can fold it over by
applying the function to an initial value and first object in <em>Collection</em> and then repeating the process with the result of this application with the rest of the <em>Collection</em> objects.
In functional programming this is usually called left fold.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">A</span> <span class="n">foldLeft</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bc</span><span class="o">){</span>
</span><span class='line'>        <span class="n">A</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="n">B</span> <span class="n">b</span> <span class="o">:</span> <span class="n">bc</span><span class="o">){</span>
</span><span class='line'>            <span class="n">acc</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s explore another way of making a function that takes several arguments and produces a result.
We can use <em>Tuple</em> for this however sometimes it&rsquo;s easier to define it more simpler like this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This definition is interchangeable with definition of <em>Function&lt;Tuple&lt;A,B&gt;,C&gt;</em> so we can make a helper method in <em>Functional</em> class that can take a function that takes a <em>Tuple</em> and produce <em>Function2</em> if needed and vice versa.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">toFunction</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;,</span><span class="n">C</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">C</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">(),</span><span class="n">t</span><span class="o">.</span><span class="na">second</span><span class="o">());</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">toFunction2</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">C</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then define a helper to flip the arguments of this function if needed</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">flip</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">C</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">,</span> <span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can partially apply an argument to a <em>Function2</em> of type <strong>A</strong> <em>&ndash;></em> <strong>B</strong> <em>&ndash;></em> <strong>C</strong> transforming it into <em>Function</em> of type <strong>B</strong> <em>&ndash;></em> <strong>C</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">partialApply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">C</span> <span class="nf">apply</span><span class="o">(</span><span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also delay the application of an argument to a function by creating another function that takes <em>Unit</em> instead of the argument. This concept is usually called lazy function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">lazyApply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">B</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Unit</span> <span class="n">unit</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally we can do the same folding we did previously only starting from the last element of the <em>Collection</em> instead of the first. This is called folding from the right or simply right fold. We can make use of previously defined <em>foldLeft</em> method and <em>Java</em>&rsquo;s <em>ListIterator</em> and <em>flip</em> helper method we defined earlier to do that easily.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">B</span> <span class="n">foldRight</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">,</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">reversed</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">ac</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">reversed</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Functional</span><span class="o">.</span><span class="na">foldLeft</span><span class="o">(</span><span class="n">Functional</span><span class="o">.</span><span class="na">flip</span><span class="o">(</span><span class="n">f</span><span class="o">),</span> <span class="n">b</span><span class="o">,</span> <span class="n">reversed</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now all this is cool and interesting but wait didn&rsquo;t we said at the beginning that this post is about Functors and Monads. Sure we did so let&rsquo;s start exploring these concepts!
First of all what is a <em>Functor</em>? A <em>Functor</em>&lt;A&gt; is some object that contains <strong>A</strong> and you can apply a function of type definition <strong>A</strong> <em>&ndash;></em> <strong>B</strong> to. This transforms it into another <em>Functor</em>&lt;B&gt; that contains result of that application, <strong>B</strong> value. For example we can consider a <em>Collection</em>&lt;A&gt; to be a <em>Functor</em>&lt;A&gt; because we can apply a function of <strong>A</strong> <em>&ndash;></em> <strong>B</strong> over all objects of that <em>Collection</em> and have a <em>Collection</em>&lt;B&gt; of results of that application. Simple? Yeah well not really that simple as it may sound however you&rsquo;ll understand it eventually I hope.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Functor</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But what about <em>Monad</em>? Well the concept of <em>Monad</em> is really close to the concept of <em>Functor</em>. <em>Monad</em>&lt;A&gt; is some object that contains <em>A</em> that can be transformed into <em>Monad</em>&lt;B&gt; by application of function of type definition <em>A &ndash;> Monad&lt;B&gt;</em>. In functional programming this is called monadic bind. Also if we have <strong>B</strong> value we can transform it into <em>Monad&lt;B&gt;</em>. This is called <em>return</em> but in our framework we&rsquo;ll name it shortly <em>ret</em> because <em>return</em> is <strong>Java</strong> <em>keyword</em> which can&rsquo;t be used for a method name. But that&rsquo;s not all there is more! Any <em>Monad</em> is a <em>Functor</em> too our <em>Monad</em> interface will extend <em>Functor</em> interface!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have a base for our functional programming framework. Let&rsquo;s write some monads to better understand the concepts behind it. But before we do that let&rsquo;s define some base abstract class
that will have one another kind of monadic bind method that can be used on any <em>Monad&lt;A&gt;</em> binding it to a <em>Monad&lt;B&gt;</em> just by specifying the <em>Monad&lt;B&gt;</em> itself instead of function. Also we can use <em>Function&lt;A,B&gt;</em> for monadic bind too by combining it&rsquo;s result with <em>ret</em>, this method we will call <em>liftM</em>!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>         <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">liftM</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">ret</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>         <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s write our first <em>Monad</em>. It&rsquo;s called <em>Maybe&lt;A&gt;</em> and it can either contain <strong>A</strong> value or be empty! As you can see we need some methods in order to look inside this <em>Monad</em> and check if it contains a value or not! Also we&rsquo;ll need to implement <em>fmap</em> method for it to be a <em>Functor</em> and <em>bind</em> and <em>ret</em> methods for it to be a <em>Monad</em>! Implementing <em>fmap</em> is simple, we simply look into the <em>Monad</em> if it contains a value we apply provided function to this value, if not then we just return empty <em>Maybe&lt;A&gt;</em> monad. Same with the bind method but we don&rsquo;t need additional step of creating a <em>Maybe&lt;A&gt;</em> monad as the provided function returns it!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">A</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Maybe</span> <span class="n">nothing</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Maybe</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">just</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">nothing</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;)</span> <span class="n">nothing</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Maybe</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">value</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getValue</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isNothing</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasValue</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isNothing</span><span class="o">()){</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">nothing</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isNothing</span><span class="o">())</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">nothing</span><span class="o">();</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have <em>Maybe</em> monad we can implement another method in <em>Functional</em> class called <em>find</em>. Basically what find does is that it takes some <em>Predicate</em> function and a <em>Collection</em> of objects to check this predicate
and it returns the first element of that <em>Collection</em> for which the <em>Predicate</em> returns <em>true</em>. If for all elements the <em>Predicate</em> is false it returns empty <em>Maybe</em> monad.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">find</span><span class="o">(</span><span class="kd">final</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>            <span class="k">if</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">nothing</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="n">exists</span><span class="o">(</span><span class="kd">final</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Functional</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">f</span><span class="o">,</span><span class="n">ac</span><span class="o">).</span><span class="na">hasValue</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next is <em>Either&lt;A,B&gt;</em> monad. This monad contains either left <em>A</em> or right <em>B</em> value. This can be used to propagate exceptions or be used in any case where you need to either return one value or another but not both at the same time. Note this is <em>Monad&lt;B&gt;</em>. This code is almost identical to <em>Maybe&lt;A&gt;</em> but instead of
returning empty value we return the monad itself since in the case of left value it can be considered a <em>Either&lt;A,C&gt;</em> monad.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">A</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">B</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">a</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Either</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLeft</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRight</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">B</span> <span class="nf">right</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;is not right&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">B</span> <span class="nf">getRight</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;is not right&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">b</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">left</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;is not left&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getLeft</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;is not left&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isRight</span><span class="o">())</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">right</span><span class="o">());</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="nf">return</span> <span class="o">(</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;)</span><span class="k">this</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="n">C</span> <span class="n">c</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Either</span><span class="o">.</span><span class="na">right</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isRight</span><span class="o">())</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Either</span><span class="o">.</span><span class="na">right</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">right</span><span class="o">()));</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="nf">return</span> <span class="o">(</span><span class="n">Functor</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;)</span><span class="k">this</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next is a <em>Reader&lt;A&gt;</em> <em>Monad</em>. This <em>Monad</em> is usually used to propagate immutable piece of data such as configuration across your code. It&rsquo;s an interesting case to implement. We could implement it using a <em>Tuple&lt;E,A&gt;</em> however it&rsquo;s traditionally implemented as <em>Function&lt;E,A&gt;</em>. In order to get <em>E</em> value we implement <em>ask</em> method. For the rest of the methods we usually call <em>runReader()</em> and then apply <em>E</em> value to them. This way we propagate the <em>E</em> value across binded <em>Reader</em> monad&rsquo;s safely.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">reader</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Reader</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">runReader</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">ask</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">E</span><span class="o">&gt;((</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">E</span><span class="o">&gt;)</span><span class="n">Identity</span><span class="o">.</span><span class="na">identity</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span>
</span><span class='line'>                <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(){</span>
</span><span class='line'>                    <span class="kd">public</span> <span class="n">B</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                        <span class="k">return</span> <span class="o">((</span><span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">runReader</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">)))</span>
</span><span class='line'>                                    <span class="o">.</span><span class="na">runReader</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span>
</span><span class='line'>                <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(){</span>
</span><span class='line'>                   <span class="kd">public</span> <span class="n">B</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                       <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>                   <span class="o">}</span>
</span><span class='line'>                <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span>
</span><span class='line'>                <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(){</span>
</span><span class='line'>                   <span class="kd">public</span> <span class="n">B</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                       <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">runReader</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
</span><span class='line'>                   <span class="o">}</span>
</span><span class='line'>               <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before implementing next <em>Monad</em> let&rsquo;s explore another concept of Functional Programming called <em>Monoid</em>. Basically <em>Monoid</em> is some entity that can be empty or non-empty and can be appended to another <em>Monoid</em>. Appending empty <em>Monoid</em> to non-empty <em>Monoid</em> gives you the same non-empty <em>Monoid</em>. Simplest example of <em>Monoid</em> are natural numbers. In case of natural numbers we can consider zero as empty <em>Monoid</em> and any non-zero number to be non-empty <em>Monoid</em> and operation of appending two <em>Monoid</em>s to be addition of natural numbers. Let&rsquo;s write an interface of <em>Monoid</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mempty</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mappend</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we continue implementing monads let&rsquo;s implement one example of <em>Monoid</em>. First we&rsquo;ll define an <em>AbstractMonoid</em> class that will have some additional methods called <em>mconcat</em> for <em>mappend</em>-ing <em>List</em> or <em>Collection</em> of <em>Monoid</em>s starting from an empty <em>Monoid</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractMonoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mconcat</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">al</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Functional</span><span class="o">.</span><span class="na">foldLeft</span><span class="o">(</span><span class="k">new</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="na">mappend</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">},</span> <span class="k">this</span><span class="o">.</span><span class="na">mempty</span><span class="o">(),</span> <span class="n">al</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mconcat</span><span class="o">(</span><span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Functional</span><span class="o">.</span><span class="na">foldLeft</span><span class="o">(</span><span class="k">new</span> <span class="n">Function2</span><span class="o">&lt;</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="na">mappend</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">},</span> <span class="k">this</span><span class="o">.</span><span class="na">mempty</span><span class="o">(),</span> <span class="n">ac</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we are ready to implement <em>List</em> <em>Monoid</em> which is basically a linked list of nodes that are either empty or contain a value and reference to next list node.
This implementing is ugly due to lack of <a href="http://en.wikipedia.org/wiki/Tail_call">TCO</a> in <strong>Java</strong>, however it&rsquo;s not too complex and just repeats any linked list implementation in <strong>Java</strong> or any other
programming language.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">A</span> <span class="n">hd</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">tl</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span> <span class="n">empty</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">head</span><span class="o">,</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">tail</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">head</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;head has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">tail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;tail has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">head</span><span class="o">,</span><span class="n">tail</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">(</span><span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ac</span><span class="o">){</span>
</span><span class='line'>            <span class="k">if</span><span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span><span class='line'>                <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">a</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span><span class='line'>                <span class="n">l</span><span class="o">.</span><span class="na">tl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">a</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">tl</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;)</span><span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">l</span><span class="o">.</span><span class="na">tl</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">empty</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">empty</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">List</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">head</span><span class="o">,</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">tail</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">tl</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">value</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;head has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hd</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getValue</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;head has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hd</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">length</span><span class="o">(){</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">hasValue</span><span class="o">()){</span>
</span><span class='line'>            <span class="n">len</span><span class="o">++;</span>
</span><span class='line'>            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">tail</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">len</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">A</span> <span class="nf">head</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;head has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hd</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">tail</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;has no tail&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">tl</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmptyTail</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">tl</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasValue</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mempty</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">mappend</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monoid</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isEmpty</span><span class="o">())</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span><span class="o">(!</span><span class="n">r</span><span class="o">.</span><span class="na">isEmptyTail</span><span class="o">()){</span>
</span><span class='line'>            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">tl</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">r</span><span class="o">.</span><span class="na">tl</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;)</span><span class="n">a</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">isEmpty</span><span class="o">())</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">al</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">al</span><span class="o">.</span><span class="na">value</span><span class="o">()),(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">List</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span><span class="o">(!</span><span class="n">al</span><span class="o">.</span><span class="na">isEmptyTail</span><span class="o">()){</span>
</span><span class='line'>            <span class="n">al</span> <span class="o">=</span> <span class="n">al</span><span class="o">.</span><span class="na">tail</span><span class="o">();</span>
</span><span class='line'>            <span class="n">r2</span><span class="o">.</span><span class="na">tl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">al</span><span class="o">.</span><span class="na">value</span><span class="o">()),</span> <span class="n">r2</span><span class="o">.</span><span class="na">tl</span><span class="o">);</span>
</span><span class='line'>            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="na">tl</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have <em>Monoid</em> let&rsquo;s implement a <em>Writer&lt;W,A&gt;</em> monad. It&rsquo;s used when we need to collect some values as we go, for example log messages. Note that W needs to be a valid <em>Monoid</em>, without this
we can&rsquo;t collect values into one entity. Inside we use <em>Tuple&lt;A,W&gt;</em> to store values. We have <em>tell</em> method to <em>mappend</em> new <em>Monoid</em> values to <em>Writer</em> and by unwrapping the <em>Tuple&lt;A,W&gt;</em> we can
bind it to another <em>Writer&lt;W,B&gt;</em> monad.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Writer</span><span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">Monoid</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">Monoid</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">writer</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">t</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">Monoid</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">writer</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">W</span> <span class="n">w</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">w</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Writer</span><span class="o">(</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">runWriter</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">t</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;</span> <span class="n">tell</span><span class="o">(</span><span class="kd">final</span> <span class="n">W</span> <span class="n">w</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">Unit</span><span class="o">.</span><span class="na">unit</span><span class="o">(),</span>
</span><span class='line'>                                  <span class="o">(</span><span class="n">W</span><span class="o">)</span><span class="n">runWriter</span><span class="o">().</span><span class="na">second</span><span class="o">().</span><span class="na">mappend</span><span class="o">(</span><span class="n">w</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">runWriter</span><span class="o">().</span><span class="na">first</span><span class="o">());</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">runWriter</span><span class="o">().</span><span class="na">first</span><span class="o">(),</span>
</span><span class='line'>                               <span class="o">(</span><span class="n">W</span><span class="o">)</span><span class="n">runWriter</span><span class="o">().</span><span class="na">second</span><span class="o">().</span><span class="na">mappend</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">runWriter</span><span class="o">().</span><span class="na">second</span><span class="o">())));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">runWriter</span><span class="o">().</span><span class="na">second</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">runWriter</span><span class="o">().</span><span class="na">first</span><span class="o">()),</span>
</span><span class='line'>                               <span class="n">runWriter</span><span class="o">().</span><span class="na">second</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next let&rsquo;s implement another monad called <em>State&lt;S,A&gt;</em>. Basicly <em>State</em> <em>Monad</em> is needed when we need some mutable value across whole computation and in a sense it&rsquo;s like programming in any imperative language.
<em>State</em> monad inside is actually a <em>Function&lt;S,Tuple&lt;A,S&gt;&gt;</em>. Basically we can imagine a <em>State</em> monad as a <em>Function</em> that takes some state <em>S</em> and returns <em>Tuple</em> that contains <em>A</em> and possibly changed state <em>S</em>. In a sense it&rsquo;s implementation is like <em>Writer</em> and <em>Reader</em> monads combined. We have two methods <em>get</em> and <em>set</em> to get current state value and modify it during computation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">state</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">state</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">State</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">runState</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">get</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">s</span><span class="o">,</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;</span> <span class="n">put</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">ns</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">Unit</span><span class="o">.</span><span class="na">unit</span><span class="o">(),</span><span class="n">ns</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(((</span><span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span>
</span><span class='line'>                            <span class="n">runState</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">first</span><span class="o">()</span>
</span><span class='line'>                        <span class="o">)).</span><span class="na">runState</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">first</span><span class="o">(),</span> <span class="n">s</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">runState</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">first</span><span class="o">()),</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now what if we need <em>Reader</em> monad and at the same time we need some mutation that <em>State</em> monad provides. Yes we need something that will combine the power of both monads into one.
This is what <em>Monad Transformer</em> can do. First of all any <em>Monad Transformer</em> is also a <em>Monad</em>. We can <em>lift</em> any <em>Monad&lt;A&gt;</em> into <em>MonadTrans&lt;A&gt;</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">MonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">lift</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we&rsquo;ll start implementing <em>Monad Transformer</em>s let&rsquo;s write some abstract base class that every <em>Monad Transformer</em> will inherit.
It will have only one method called <em>lift</em> that will allow any <em>Monad</em> to be lifted into <em>Monad Transformer</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">MonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">MonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">lift</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span><span class="n">MonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;)</span><span class="n">m</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">ret</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First let&rsquo;s implement <em>MaybeT&lt;M,A&gt;</em> monad transformer. Note that <em>M</em> needs to be a valid <em>Monad</em> and so we use <em>extends</em> type definition.
Internally <em>MaybeT</em> is a <em>Monad&lt;Maybe&lt;A&gt;&gt;</em>. We check it&rsquo;s value by binding a function and inside we check if value is not empty we apply the provided function, if not we return wrapping it into
internal monad using <em>ret</em> method.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaybeT</span><span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">maybeT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">M</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;monad has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">m</span><span class="o">.</span><span class="na">ret</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">maybeT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;monad has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">m</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">MaybeT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="nf">runMaybeT</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runMaybeT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">if</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">isNothing</span><span class="o">())</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runMaybeT</span><span class="o">().</span><span class="na">ret</span><span class="o">((</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">Maybe</span><span class="o">.</span><span class="na">nothing</span><span class="o">());</span>
</span><span class='line'>                <span class="k">else</span><span class="o">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="o">((</span><span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">())).</span><span class="na">runMaybeT</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runMaybeT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">b</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MaybeT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runMaybeT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Maybe</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runMaybeT</span><span class="o">().</span><span class="na">ret</span><span class="o">((</span><span class="n">Maybe</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;)</span><span class="n">a</span><span class="o">.</span><span class="na">fmap</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next is <em>EitherT&lt;M,A,B&gt;</em> monad transformer. It&rsquo;s written almost the same as <em>MaybeT</em> but inside it&rsquo;s a <em>Monad&lt;Either&lt;A,B&gt;&gt;</em> but instead we operate with right and left values inside bind function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EitherT</span><span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">EitherT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">eitherT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">M</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;monad has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">EitherT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">m</span><span class="o">.</span><span class="na">ret</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">EitherT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">eitherT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;monad has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">EitherT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">m</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">EitherT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">runEitherT</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">EitherT</span><span class="o">(</span><span class="n">runEitherT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">if</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">isLeft</span><span class="o">())</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runEitherT</span><span class="o">().</span><span class="na">ret</span><span class="o">((</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;)</span><span class="n">Either</span><span class="o">.</span><span class="na">left</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">left</span><span class="o">()));</span>
</span><span class='line'>                <span class="k">else</span><span class="o">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="o">((</span><span class="n">EitherT</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;)</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">right</span><span class="o">())).</span><span class="na">runEitherT</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">C</span> <span class="n">c</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">EitherT</span><span class="o">(</span><span class="n">runEitherT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Either</span><span class="o">.</span><span class="na">right</span><span class="o">(</span><span class="n">c</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">EitherT</span><span class="o">(</span><span class="n">runEitherT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runEitherT</span><span class="o">().</span><span class="na">ret</span><span class="o">((</span><span class="n">Either</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">C</span><span class="o">&gt;)</span><span class="n">a</span><span class="o">.</span><span class="na">fmap</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s implement <em>ReaderT&lt;E,M,A&gt;</em> monad transformer. Internally it&rsquo;s implemented as <em>Function&lt;E,Monad&lt;A&gt;&gt;</em>. Basically it&rsquo;s implementation mimics that of <em>Reader</em> monad however
instead of <em>A</em> value we are dealing with <em>Monad&lt;A&gt;</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">readerT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;argument has no value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">ReaderT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">runReaderT</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">ask</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">E</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runReaderT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runReaderT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runReaderT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ReaderT</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">e</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runReaderT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;(){</span>
</span><span class='line'>                    <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">){</span>
</span><span class='line'>                        <span class="k">return</span> <span class="nf">runReaderT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">});</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next monad transformer is <em>WriterT&lt;W,M,A&gt;</em>. This one is implemented internally as <em>Monad&lt;Tuple&lt;A,W&gt;&gt;</em> and follows the same pattern as <em>MaybeT</em> and <em>EitherT</em> monad transformer implementations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WriterT</span><span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">Monoid</span><span class="o">,</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">Monoid</span><span class="o">,</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">writerT</span><span class="o">(</span><span class="kd">final</span> <span class="n">A</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="n">W</span> <span class="n">w</span><span class="o">,</span> <span class="kd">final</span> <span class="n">M</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;((</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;)</span><span class="n">m</span><span class="o">.</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">w</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">WriterT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">m</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">runWriterT</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">m</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;</span> <span class="n">tell</span><span class="o">(</span><span class="kd">final</span> <span class="n">W</span> <span class="n">w</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;(</span><span class="n">runWriterT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runWriterT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">Unit</span><span class="o">.</span><span class="na">unit</span><span class="o">(),(</span><span class="n">W</span><span class="o">)</span><span class="n">t</span><span class="o">.</span><span class="na">second</span><span class="o">().</span><span class="na">mappend</span><span class="o">(</span><span class="n">w</span><span class="o">)));</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runWriterT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">((</span><span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">())).</span><span class="na">runWriterT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span>
</span><span class='line'>                    <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                        <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t2</span><span class="o">){</span>
</span><span class='line'>                            <span class="k">return</span> <span class="nf">runWriterT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">first</span><span class="o">(),</span><span class="n">t</span><span class="o">.</span><span class="na">second</span><span class="o">()));</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                <span class="o">});</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runWriterT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runWriterT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">t</span><span class="o">.</span><span class="na">second</span><span class="o">()));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">WriterT</span><span class="o">&lt;</span><span class="n">W</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="n">runWriterT</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runWriterT</span><span class="o">().</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">()),</span><span class="n">t</span><span class="o">.</span><span class="na">second</span><span class="o">()));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last monad transformer we are implementing is <em>StateT&lt;S,M,A&gt;</em>. It&rsquo;s the most complex implementation among all monad transformers.
Internally it mimics <em>State</em> monad however it&rsquo;s implemented as <em>Function&lt;S,Monad&lt;Tuple&lt;A,S&gt;&gt;&gt;</em> so general implementation
follows that of <em>State</em> with the difference that function returns monad but not a value. You can study this source code line by line
to better understand all the inner workings however I strongly encourage you to try implement it yourself. In a matter of fact try writing all the monad transformers from scratch yourself
and you&rsquo;ll grok their beauty easily.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Monad</span><span class="o">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractMonadTrans</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">StateT</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;</span> <span class="n">runStateT</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">get</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">s</span><span class="o">,</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;</span> <span class="n">put</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">ns</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">Unit</span><span class="o">&gt;(</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">Unit</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">Unit</span><span class="o">.</span><span class="na">unit</span><span class="o">(),</span><span class="n">ns</span><span class="o">));</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span>
</span><span class='line'>                        <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">()).</span><span class="na">bind</span><span class="o">(</span>
</span><span class='line'>                                    <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                                        <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>                                            <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'>                                        <span class="o">}</span>
</span><span class='line'>                                <span class="o">});</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                    <span class="o">});</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ret</span><span class="o">(</span><span class="kd">final</span> <span class="n">B</span> <span class="n">b</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span><span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">fmap</span><span class="o">(</span><span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">StateT</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">M</span><span class="o">,</span><span class="n">B</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>            <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">S</span> <span class="n">s</span><span class="o">){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span>
</span><span class='line'>                    <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;,</span><span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;&gt;(){</span>
</span><span class='line'>                        <span class="kd">public</span> <span class="n">Monad</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&lt;</span><span class="n">B</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Tuple</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">){</span>
</span><span class='line'>                            <span class="k">return</span> <span class="nf">runStateT</span><span class="o">().</span><span class="na">apply</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">ret</span><span class="o">(</span>
</span><span class='line'>                                <span class="n">Tuple</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">()),</span><span class="n">s</span><span class="o">)</span>
</span><span class='line'>                            <span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                <span class="o">});</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all folks! We&rsquo;ve implemented a small functional library in <strong>Java</strong>, it&rsquo;s not complete and not as powerful as <a href="http://www.functionaljava.org/">Functional Java</a>, however doing so brings us a little bit closer to functional zen. Long road still lays ahead of us as we journey this path of functional programming, but we are stronger than we were! Good luck to you all adventurers and happy functional programming!</p>

<p><img src="http://i.imgur.com/9gKTf4u.jpg" alt="Rikka Kawaii" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rewriting Micro Compiler in OCaml using ocamllex and ocamlyacc]]></title>
    <link href="http://troydm.github.io/blog/2014/11/14/rewriting-micro-compiler-in-ocaml-using-ocamllex-and-ocamlyacc/"/>
    <updated>2014-11-14T22:58:29+04:00</updated>
    <id>http://troydm.github.io/blog/2014/11/14/rewriting-micro-compiler-in-ocaml-using-ocamllex-and-ocamlyacc</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Rewriting micro compiler in OCaml</em></p>

<p>In <a href="http://troydm.github.io/blog/2014/03/29/writing-micro-compiler-in-ocaml/">my previous post</a> I&rsquo;ve talked about writing micro compiler in OCaml under 300 lines of source code. There are number of ways to make our work easier and number of source code lines significantly smaller.</p>

<p><img src="http://i.imgur.com/2q3i5KA.gif" alt="Potato Loli" /></p>

<p>Let&rsquo;s rewrite our micro compiler using tools called <em>lexer</em> and <em>parser</em> generators. We&rsquo;ll be using tools called <strong>ocamllex</strong> and <strong>ocamlyacc</strong> which are distributed with <em>OCaml</em> compiler and are modeled after
famous <strong>lex</strong> and <strong>yacc</strong> tools for <em>Unix</em> operating systems. Those tools actually have better modern analogues called <strong>flex</strong> and <strong>bison</strong> which are described in detail in <a href="http://www.amazon.com/flex-bison-Text-Processing-Tools/dp/0596155972/">Flex &amp; Bison: Text Processing Tools</a> book.
Nowadays however if you are writing a professional compiler in <em>OCaml</em> I strongly suggest you consider using <a href="https://github.com/alainfrisch/sedlex">sedlex</a> and <a href="http://gallium.inria.fr/~fpottier/menhir/">menhir</a> instead of <strong>ocamllex</strong> and <strong>ocamlyacc</strong> as both tools are quite outdated and
lack some significant features that their modern analogues have such as unicode support for lexing, parameterized parser generation and built-in grammar interpreter. So what are lexer and parser generators?
To put it simply <strong>ocamllex</strong> and <strong>ocamlyacc</strong> take special <em>.mll</em> and <em>.mly</em> definition files of lexer and parser semantics mixed with <em>OCaml</em> source code and generate an <em>.ml</em> source code files that do the actual token generation and parsing for you.
Pretty neat indeed, and it&rsquo;s actually easier to use than it sounds so let&rsquo;s rewrite our micro compiler using those tools. We&rsquo;ll be using original source code of micro compiler as reference only as entire code base needs to be changed. You can see the end result of our rewrite in <a href="https://github.com/troydm/micro/tree/simple">micro</a> git repository branch called <em>simple</em>. For the actual description of the micro language see my previous post. So let&rsquo;s get started!</p>

<!--more-->


<p>First let&rsquo;s create our files for lexer and parser called <em>lexer.mll</em> and <em>parser.mly</em>. Now let&rsquo;s define our tokens in <em>parser.mly</em>. As you can see it&rsquo;s defined
using special syntax that is described in <a href="http://caml.inria.fr/pub/docs/manual-ocaml/lexyacc.html">ocamlyacc manual</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">BEGIN</span> <span class="nc">END</span> <span class="nc">EOF</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="nc">IDENTIFIER</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="nc">LITERAL</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">READ</span> <span class="nc">WRITE</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">ASSIGN</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">LEFTPAREN</span> <span class="nc">RIGHTPAREN</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">ADDOP</span> <span class="nc">SUBOP</span>
</span><span class='line'><span class="o">%</span><span class="n">token</span> <span class="nc">COMMA</span> <span class="nc">SEMICOLON</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define lexical semantics for those tokens in <em>lexer.mll</em> file. The tokens we defined in parser.mly will be generated into <em>parser.mli</em> interface
file so first of all let&rsquo;s include those from parser module by adding a header to <em>lexer.mll</em> file. The part between <em>{</em> and <em>}</em> is defined in <em>OCaml</em> syntax
and will be translated into the generated lexer.ml file without any changes. For the description of <em>ocamllex</em> definition file consult it&rsquo;s <a href="http://caml.inria.fr/pub/docs/manual-ocaml/lexyacc.html">manual</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">Parser</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next let&rsquo;s define some lexical semantics next for blank characters, digits and alpha numerical characters. As you can see those are defined using
regular expression syntax and can be referencing each other. This way we can define identifier lexical semantics by just referencing alpha and digit definitions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">blank</span> <span class="o">=</span> <span class="o">[</span><span class="sc">&#39; &#39;</span> <span class="sc">&#39;\r&#39;</span> <span class="sc">&#39;\t&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">let</span> <span class="n">digit</span> <span class="o">=</span> <span class="o">[</span><span class="sc">&#39;0&#39;</span><span class="o">-</span><span class="sc">&#39;9&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">let</span> <span class="n">digits</span> <span class="o">=</span> <span class="n">digit</span><span class="o">*</span>
</span><span class='line'><span class="k">let</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">[</span><span class="sc">&#39;a&#39;</span><span class="o">-</span><span class="sc">&#39;z&#39;</span> <span class="sc">&#39;A&#39;</span><span class="o">-</span><span class="sc">&#39;Z&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">let</span> <span class="n">iden</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">(</span><span class="n">alpha</span> <span class="o">|</span> <span class="n">digit</span> <span class="o">|</span> <span class="sc">&#39;_&#39;</span><span class="o">)*</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s define a rule that will give us the actual tokens. As you can see the part between <em>{</em> and <em>}</em> is in <em>OCaml</em> syntax and just gives us back the tokens we&rsquo;ve defined.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">rule</span> <span class="n">micro</span> <span class="o">=</span> <span class="n">parse</span>
</span><span class='line'>    <span class="o">|</span> <span class="s2">&quot;:=&quot;</span>     <span class="o">{</span> <span class="nc">ASSIGN</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;+&#39;</span>      <span class="o">{</span> <span class="nc">ADDOP</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;-&#39;</span>      <span class="o">{</span> <span class="nc">SUBOP</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;,&#39;</span>      <span class="o">{</span> <span class="nc">COMMA</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;;&#39;</span>      <span class="o">{</span> <span class="nc">SEMICOLON</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;(&#39;</span>      <span class="o">{</span> <span class="nc">LEFTPAREN</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;)&#39;</span>      <span class="o">{</span> <span class="nc">RIGHTPAREN</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">digits</span> <span class="k">as</span> <span class="n">d</span> <span class="o">{</span>
</span><span class='line'>        <span class="c">(* parse literal *)</span>
</span><span class='line'>        <span class="nc">LITERAL</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">d</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s add the line counting and syntax error reporting to our <em>lexer.mll</em> header.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* current token line number *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">exception</span> <span class="nc">Syntax_error</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">syntax_error</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Syntax_error</span> <span class="o">(</span><span class="n">msg</span> <span class="o">^</span> <span class="s2">&quot; on line &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">!</span><span class="n">line_num</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we&rsquo;ll add the rule for counting new lines and reporting syntax errors if lexer encounters unknown token. Also we need to generate <em>EOF</em> token when lexer will encounter the end of file. To skip blank characters, as those aren&rsquo;t need in our micro compiler, we&rsquo;ll just recursively call lexer&rsquo;s micro rule providing it with <em>lexbuf</em> which is described in manual.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">rule</span> <span class="n">micro</span> <span class="o">=</span> <span class="n">parse</span>
</span><span class='line'>    <span class="o">.....</span>
</span><span class='line'>    <span class="o">|</span> <span class="sc">&#39;\n&#39;</span>     <span class="o">{</span> <span class="n">incr</span> <span class="n">line_num</span><span class="o">;</span> <span class="n">micro</span> <span class="n">lexbuf</span> <span class="o">}</span> <span class="c">(* counting new line characters *)</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">blank</span>    <span class="o">{</span> <span class="n">micro</span> <span class="n">lexbuf</span> <span class="o">}</span> <span class="c">(* skipping blank characters *)</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span>        <span class="o">{</span> <span class="n">syntax_error</span> <span class="s2">&quot;couldn&#39;t identify the token&quot;</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">eof</span>      <span class="o">{</span> <span class="nc">EOF</span> <span class="o">}</span> <span class="c">(* no more tokens *)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Woah woaw wow, much forget, wait!!! Aren&rsquo;t we missing something?! Ah yes, identifiers, indeed! First of all let&rsquo;s define a table of known keywords in the header as we need to handle them differently.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* keyword -&gt; token translation table *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">keywords</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    <span class="s2">&quot;begin&quot;</span><span class="o">,</span> <span class="nc">BEGIN</span><span class="o">;</span> <span class="s2">&quot;end&quot;</span><span class="o">,</span> <span class="nc">END</span><span class="o">;</span> <span class="s2">&quot;read&quot;</span><span class="o">,</span> <span class="nc">READ</span><span class="o">;</span> <span class="s2">&quot;write&quot;</span><span class="o">,</span> <span class="nc">WRITE</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now let&rsquo;s handle the actual identifier tokens.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">rule</span> <span class="n">micro</span> <span class="o">=</span> <span class="n">parse</span>
</span><span class='line'>    <span class="o">.....</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">iden</span> <span class="k">as</span> <span class="n">i</span> <span class="o">{</span>
</span><span class='line'>        <span class="c">(* try keywords if not found then it&#39;s identifier *)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">i</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">l</span> <span class="n">keywords</span>
</span><span class='line'>        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">IDENTIFIER</span> <span class="n">i</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Congratulations we have a lexer ready, now it&rsquo;s a parsing time! Let&rsquo;s define a parser for our micro code. Parser definition syntax is pretty straightforward and reminds kinds of <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_Form">BNF</a> definition.
If you don&rsquo;t understand it just by looking at it or don&rsquo;t know what <em>BNF</em> is I suggest you take a look into description of definition syntax by consulting ocamlyacc manual.
As you can see our parser starts with a program definition which starts with <em>begin statement</em> followed by <em>statements</em> and followed by <em>end statement</em> definitions and ends with <em>EOF</em> token.
The part between <em>{</em> and <em>}</em> is <em>OCaml</em> source code that is executed after the parsing of the definition is done. When parser does it&rsquo;s job it raises <em>End_of_file</em> exception which we&rsquo;ll
be handling as end of parsing. So basically when parser sees <em>BEGIN</em> token it just executes <em>generate_begin</em> function which we&rsquo;ll define shortly. Same with <em>END</em> token only now we are executing
<em>generate_end</em> function instead. Statements definition is recursive and just references a <em>statement</em> followed by <em>semicolon</em> followed by more <em>statements</em> or none.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">%</span><span class="n">start</span> <span class="n">program</span>
</span><span class='line'><span class="o">%</span><span class="k">type</span> <span class="o">&lt;</span><span class="kt">unit</span><span class="o">&gt;</span> <span class="n">program</span>
</span><span class='line'>
</span><span class='line'><span class="o">%%</span>
</span><span class='line'>
</span><span class='line'><span class="n">program</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span>   <span class="n">begin_stmt</span> <span class="n">statements</span> <span class="n">end_stmt</span> <span class="nc">EOF</span> <span class="o">{</span> <span class="k">raise</span> <span class="nc">End_of_file</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">begin_stmt</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span>   <span class="nc">BEGIN</span> <span class="o">{</span> <span class="n">generate_begin</span> <span class="bp">()</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">end_stmt</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span>   <span class="nc">END</span> <span class="o">{</span> <span class="n">generate_end</span> <span class="bp">()</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">statements</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">statement</span> <span class="nc">SEMICOLON</span> <span class="n">statements</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s write some code to generate the assembly for the <em>begin</em> and <em>end</em> statements. We&rsquo;ll put all our code generation functions into a separate module called <em>codegen</em> so let&rsquo;s create
a new file called <em>codegen.ml</em> and add some code generation methods into it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* code generation *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">stdout</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">set_chan</span> <span class="n">new_chan</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">:=</span> <span class="n">new_chan</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">gen</span> <span class="n">v</span> <span class="o">=</span> <span class="n">output_string</span> <span class="o">!</span><span class="n">chan</span> <span class="n">v</span><span class="o">;</span> <span class="n">output_string</span> <span class="o">!</span><span class="n">chan</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_begin</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">gen</span>
</span><span class='line'><span class="s2">&quot;extern printf</span>
</span><span class='line'><span class="s2">extern scanf</span>
</span><span class='line'>
</span><span class='line'><span class="s2">section .data</span>
</span><span class='line'><span class="s2">    inf: db &#39;%d&#39;, 0</span>
</span><span class='line'><span class="s2">    ouf: db &#39;%d&#39;, 10, 0</span>
</span><span class='line'>
</span><span class='line'><span class="s2">section .text</span>
</span><span class='line'><span class="s2">    global main</span>
</span><span class='line'>
</span><span class='line'><span class="s2">main:</span>
</span><span class='line'><span class="s2">    sub   esp, 4096&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_end</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">gen</span>
</span><span class='line'><span class="s2">&quot;    add   esp, 4096</span>
</span><span class='line'><span class="s2">exit:</span>
</span><span class='line'><span class="s2">    mov  eax, 1 ; sys_exit</span>
</span><span class='line'><span class="s2">    mov  ebx, 0</span>
</span><span class='line'><span class="s2">    int  80h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for parsing expression we need some way to count the depth of the expression for temporary variables so we&rsquo;ll be just incrementing it as we go deeper and then reset it to 0 after
the statement is over. This approach is not optimized one as it would mean some extra stack usage for same depth AST nodes however for sake of simplicity we&rsquo;ll leave it as it is.
So now our <em>parser.mly</em> header should look like this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="o">%{</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nc">Codegen</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
</span><span class='line'><span class="k">let</span> <span class="n">depth_incr</span> <span class="n">f</span> <span class="o">=</span> <span class="n">incr</span> <span class="n">depth</span><span class="o">;</span> <span class="n">f</span> <span class="o">!</span><span class="n">depth</span>
</span><span class='line'><span class="k">let</span> <span class="n">depth_reset</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">:=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="o">%}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s define description of <em>statement</em> in parser</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">statement</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="nc">IDENTIFIER</span> <span class="nc">ASSIGN</span> <span class="n">expression</span> <span class="o">{</span> <span class="n">generate_assign</span> <span class="o">$</span><span class="mi">1</span> <span class="o">$</span><span class="mi">3</span><span class="o">;</span> <span class="n">depth_reset</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="nc">READ</span> <span class="nc">LEFTPAREN</span> <span class="n">identifier_list</span> <span class="nc">RIGHTPAREN</span> <span class="o">{</span> <span class="n">generate_reads</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="nc">WRITE</span> <span class="nc">LEFTPAREN</span> <span class="n">expression_list</span> <span class="nc">RIGHTPAREN</span> <span class="o">{</span> <span class="n">generate_writes</span> <span class="o">$</span><span class="mi">3</span><span class="o">;</span> <span class="n">depth_reset</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s start with simpler <em>read statement</em>. Now as you can see for <em>read statement</em> we are using identifiers only so we don&rsquo;t need to do anything with depth of expression so we aren&rsquo;t
calling depth_reset function. Now in order to get identifier list we&rsquo;ll be just parsing identifiers and collecting them into the list.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">identifier_list</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="nc">IDENTIFIER</span> <span class="o">{</span> <span class="o">[$</span><span class="mi">1</span><span class="o">]</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="nc">IDENTIFIER</span> <span class="nc">COMMA</span> <span class="n">identifier_list</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">::</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s generate some assembly for reading data into identifiers. First let&rsquo;s start with some operation helper functions. The read statement is just pretty straightforward and
just generates a scanf function call for every identifier.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">op</span> <span class="n">opcode</span> <span class="n">a</span> <span class="o">=</span> <span class="n">gen</span> <span class="o">(</span><span class="s2">&quot;    &quot;</span> <span class="o">^</span> <span class="n">opcode</span> <span class="o">^</span> <span class="s2">&quot;  &quot;</span> <span class="o">^</span> <span class="n">a</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">op2</span> <span class="n">opcode</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gen</span> <span class="o">(</span><span class="s2">&quot;    &quot;</span> <span class="o">^</span> <span class="n">opcode</span> <span class="o">^</span> <span class="s2">&quot;  &quot;</span> <span class="o">^</span> <span class="n">a</span> <span class="o">^</span> <span class="s2">&quot;, &quot;</span> <span class="o">^</span> <span class="n">b</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">push</span> <span class="n">a</span> <span class="o">=</span> <span class="n">op</span> <span class="s2">&quot;push&quot;</span> <span class="n">a</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_read</span> <span class="n">i</span> <span class="o">=</span> <span class="n">op2</span> <span class="s2">&quot;lea&quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="o">(</span><span class="n">var_addr</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>                      <span class="n">push</span> <span class="s2">&quot;eax&quot;</span><span class="o">;</span>
</span><span class='line'>                      <span class="n">push</span> <span class="s2">&quot;inf&quot;</span><span class="o">;</span>
</span><span class='line'>                      <span class="n">op</span> <span class="s2">&quot;call&quot;</span> <span class="s2">&quot;scanf&quot;</span><span class="o">;</span>
</span><span class='line'>                      <span class="n">op2</span> <span class="s2">&quot;add &quot;</span> <span class="s2">&quot;esp&quot;</span> <span class="s2">&quot;8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_reads</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">generate_read</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are using <em>var_addr</em> function which we didn&rsquo;t defined yet, this function will give us the actual offset address on the stack based on the name of identifier.
We also handle <strong>__temp</strong> identifiers separately as those are just temporary variables which are discarded every time the statement is over, their offset is specified in their name after
the <strong>__temp</strong> part, so for example <strong>__temp1</strong> is an temporary variable with offset 1. Let&rsquo;s write some code that handles all of this.  All the named variables that are defined are saved into
<em>vars</em> <em>Hashtbl</em> that contains <em>variable name &ndash;> stack offset</em> information.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">exception</span> <span class="nc">Codegen_error</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">codegen_error</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Codegen_error</span> <span class="n">msg</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">var_addr</span> <span class="n">v</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">v</span> <span class="mi">0</span> <span class="mi">6</span> <span class="o">=</span> <span class="s2">&quot;__temp&quot;</span>
</span><span class='line'>                 <span class="k">then</span> <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">v</span> <span class="mi">6</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">v</span><span class="o">)</span> <span class="o">-</span> <span class="mi">6</span><span class="o">)</span> <span class="k">in</span> <span class="s2">&quot;[esp+&quot;</span> <span class="o">^</span> <span class="n">i</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
</span><span class='line'>                 <span class="k">else</span>
</span><span class='line'>                 <span class="k">try</span> <span class="s2">&quot;[esp+&quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="o">!</span><span class="n">vars</span> <span class="n">v</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
</span><span class='line'>                 <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">codegen_error</span> <span class="o">(</span><span class="s2">&quot;identifier &quot;</span> <span class="o">^</span> <span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; not defined&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for the write statement instead of identifiers we could have expressions, so let&rsquo;s define those.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">expression_list</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="n">expression</span> <span class="o">{</span> <span class="o">[$</span><span class="mi">1</span><span class="o">]</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">expression</span> <span class="nc">COMMA</span> <span class="n">expression_list</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">::</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the code that generates write statements is almost the same as read but instead of calling scanf we&rsquo;ll be calling printf function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">generate_write</span> <span class="n">i</span> <span class="o">=</span> <span class="n">push</span> <span class="n">i</span><span class="o">;</span>
</span><span class='line'>                       <span class="n">push</span> <span class="s2">&quot;ouf&quot;</span><span class="o">;</span>
</span><span class='line'>                       <span class="n">op</span> <span class="s2">&quot;call&quot;</span> <span class="s2">&quot;printf&quot;</span><span class="o">;</span>
</span><span class='line'>                       <span class="n">op2</span> <span class="s2">&quot;add &quot;</span> <span class="s2">&quot;esp&quot;</span> <span class="s2">&quot;8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_writes</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">generate_write</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s now declare an expression</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">expression</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="nc">IDENTIFIER</span> <span class="o">{</span> <span class="n">var</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="nc">LITERAL</span> <span class="o">{</span> <span class="n">generate_literal</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">addop</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">subop</span> <span class="o">{</span> <span class="o">$</span><span class="mi">1</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For simple cases expression can be just a <em>variable</em> or a <em>literal</em> so let&rsquo;s write some code that generates assembly for those.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">var</span> <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;dword &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">var_addr</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_literal</span> <span class="o">=</span> <span class="n">string_of_int</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s now handle <em>addition</em> and <em>substraction</em> expressions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="n">addop</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="nc">LITERAL</span> <span class="nc">ADDOP</span> <span class="nc">LITERAL</span> <span class="o">{</span> <span class="n">generate_literal</span> <span class="o">($</span><span class="mi">1</span> <span class="o">+</span> <span class="o">$</span><span class="mi">3</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">expression</span> <span class="nc">ADDOP</span> <span class="n">expression</span> <span class="o">{</span> <span class="o">(</span><span class="n">depth_incr</span> <span class="n">generate_add</span><span class="o">)</span> <span class="o">$</span><span class="mi">1</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">subop</span><span class="o">:</span>
</span><span class='line'><span class="o">|</span> <span class="nc">LITERAL</span> <span class="nc">SUBOP</span> <span class="nc">LITERAL</span> <span class="o">{</span> <span class="n">generate_literal</span> <span class="o">($</span><span class="mi">1</span> <span class="o">-</span> <span class="o">$</span><span class="mi">3</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">|</span> <span class="n">expression</span> <span class="nc">SUBOP</span> <span class="n">expression</span> <span class="o">{</span> <span class="o">(</span><span class="n">depth_incr</span> <span class="n">generate_sub</span><span class="o">)</span> <span class="o">$</span><span class="mi">1</span> <span class="o">$</span><span class="mi">3</span> <span class="o">}</span>
</span><span class='line'><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see simple cases such as when we have literal from both sides are handled by our parser itself.
Now let&rsquo;s write some more code generation functions for expressions. We&rsquo;ll be using temporary variables so
we need to identify a bottom variable at the stack that will be on the top offset. And from there we&rsquo;ll use depth
of current expression in order to have a unique position for the temporary variable. This part can be written
slightly in a different way for example instead of counting depth we&rsquo;ll be counting the temporary variables and resetting them
each time a statement is over. Both approaches are almost the same so we&rsquo;ll just leave it like that.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">bottom_var</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">v</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="k">then</span> <span class="o">(</span><span class="n">v</span><span class="o">+</span><span class="mi">4</span><span class="o">)</span> <span class="k">else</span> <span class="n">c</span><span class="o">)</span> <span class="o">!</span><span class="n">vars</span> <span class="mi">0</span>
</span><span class='line'><span class="k">let</span> <span class="n">empty_var</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">bottom_var</span> <span class="bp">()</span><span class="o">)+(</span><span class="mi">4</span><span class="o">*(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'><span class="k">let</span> <span class="n">temp_var</span> <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;__temp&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">empty_var</span> <span class="n">i</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">is_var</span> <span class="n">v</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">re</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="s2">&quot;[esp+&quot;</span> <span class="k">in</span>
</span><span class='line'>    <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">re</span> <span class="n">v</span> <span class="mi">0</span><span class="o">);</span> <span class="bp">true</span>
</span><span class='line'>    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_copy</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="k">then</span> <span class="bp">()</span> <span class="k">else</span>
</span><span class='line'>                        <span class="k">if</span> <span class="n">is_var</span> <span class="n">b</span> <span class="k">then</span> <span class="k">begin</span> <span class="n">op2</span> <span class="s2">&quot;mov &quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="n">b</span><span class="o">;</span> <span class="n">op2</span> <span class="s2">&quot;mov &quot;</span> <span class="n">a</span> <span class="s2">&quot;eax&quot;</span> <span class="k">end</span>
</span><span class='line'>                        <span class="k">else</span> <span class="n">op2</span> <span class="s2">&quot;mov &quot;</span> <span class="n">a</span> <span class="n">b</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_add</span> <span class="n">d</span> <span class="n">id1</span> <span class="n">id2</span> <span class="o">=</span> <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">var</span> <span class="o">(</span><span class="n">temp_var</span> <span class="n">d</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>                             <span class="n">generate_copy</span> <span class="n">v</span> <span class="n">id1</span><span class="o">;</span>
</span><span class='line'>                             <span class="k">if</span> <span class="n">is_var</span> <span class="n">id2</span> <span class="k">then</span> <span class="k">begin</span> <span class="n">op2</span> <span class="s2">&quot;mov &quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="n">id2</span><span class="o">;</span> <span class="n">op2</span> <span class="s2">&quot;add &quot;</span> <span class="n">v</span> <span class="s2">&quot;eax&quot;</span> <span class="k">end</span>
</span><span class='line'>                             <span class="k">else</span> <span class="n">op2</span> <span class="s2">&quot;add &quot;</span> <span class="n">v</span> <span class="n">id2</span><span class="o">;</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_sub</span> <span class="n">d</span> <span class="n">id1</span> <span class="n">id2</span> <span class="o">=</span> <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">var</span> <span class="o">(</span><span class="n">temp_var</span> <span class="n">d</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>                             <span class="n">generate_copy</span> <span class="n">v</span> <span class="n">id1</span><span class="o">;</span>
</span><span class='line'>                             <span class="k">if</span> <span class="n">is_var</span> <span class="n">id2</span> <span class="k">then</span> <span class="k">begin</span> <span class="n">op2</span> <span class="s2">&quot;mov &quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="n">id2</span><span class="o">;</span> <span class="n">op2</span> <span class="s2">&quot;sub &quot;</span> <span class="n">v</span> <span class="s2">&quot;eax&quot;</span> <span class="k">end</span>
</span><span class='line'>                             <span class="k">else</span> <span class="n">op2</span> <span class="s2">&quot;sub &quot;</span> <span class="n">v</span> <span class="n">id2</span><span class="o">;</span> <span class="n">v</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the only thing left to do is generate some code for <em>assignment</em> expression and our parser is done.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">is_alloc_var</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="o">!</span><span class="n">vars</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">alloc_var</span> <span class="n">v</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_alloc_var</span> <span class="n">v</span> <span class="k">then</span> <span class="n">var</span> <span class="n">v</span>
</span><span class='line'>                  <span class="k">else</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="o">!</span><span class="n">vars</span> <span class="n">v</span> <span class="o">(</span><span class="n">empty_var</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span> <span class="n">var</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_assign</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="o">(</span><span class="n">alloc_var</span> <span class="n">a</span><span class="o">)</span> <span class="n">b</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now for the final part we need to write the actual compiling function. It will parse the micro source file specified as an argument and
will compile it using <em>nasm</em> and <em>gcc</em>. Let&rsquo;s create <em>micro.ml</em> file and write some final code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* compiling *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">compile</span> <span class="n">f</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">out_chan</span> <span class="o">=</span> <span class="n">open_out</span> <span class="o">(</span><span class="n">out</span> <span class="o">^</span> <span class="s2">&quot;.s&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="ow">and</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="nn">Lexing</span><span class="p">.</span><span class="n">from_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>            <span class="k">let</span> <span class="k">rec</span> <span class="n">parse</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>                <span class="nn">Parser</span><span class="p">.</span><span class="n">program</span> <span class="nn">Lexer</span><span class="p">.</span><span class="n">micro</span> <span class="n">lexbuf</span><span class="o">;</span> <span class="n">parse</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class='line'>            <span class="nn">Codegen</span><span class="p">.</span><span class="n">set_chan</span> <span class="n">out_chan</span><span class="o">;</span>
</span><span class='line'>            <span class="n">ignore</span><span class="o">(</span><span class="n">parse</span> <span class="bp">()</span><span class="o">);</span>
</span><span class='line'>        <span class="k">with</span>
</span><span class='line'>          <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">begin</span>
</span><span class='line'>                <span class="n">close_out</span> <span class="n">out_chan</span><span class="o">;</span>
</span><span class='line'>                <span class="n">ignore</span><span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;nasm -f elf32 &quot;</span> <span class="o">^</span> <span class="n">out</span> <span class="o">^</span> <span class="s2">&quot;.s&quot;</span><span class="o">));</span>
</span><span class='line'>                <span class="n">ignore</span><span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;gcc -m32 -o &quot;</span> <span class="o">^</span> <span class="n">out</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">out</span> <span class="o">^</span> <span class="s2">&quot;.o&quot;</span><span class="o">))</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>        <span class="o">|</span> <span class="nn">Lexer</span><span class="p">.</span><span class="nc">Syntax_error</span> <span class="n">s</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="n">print_string</span> <span class="n">s</span><span class="o">;</span>
</span><span class='line'>            <span class="n">exit</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">help</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="s2">&quot;micro &lt;file&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">help</span> <span class="bp">()</span>
</span><span class='line'>         <span class="k">else</span>
</span><span class='line'>             <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">get</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="k">in</span>
</span><span class='line'>             <span class="nn">Format</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;compiling %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">file</span><span class="o">;</span>
</span><span class='line'>             <span class="nn">Format</span><span class="p">.</span><span class="n">print_flush</span> <span class="bp">()</span><span class="o">;</span>
</span><span class='line'>             <span class="n">compile</span> <span class="n">file</span>
</span></code></pre></td></tr></table></div></figure>


<p>Phew, writing posts is exhausting but finally our micro compiler is ready! Let&rsquo;s test it. You need to have <em>nasm</em> and <em>gcc</em> installed on your <em>Linux</em> system in order to run it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./micro ./examples/hello.mc
</span><span class='line'>./examples/hello
</span></code></pre></td></tr></table></div></figure>


<p>And it works! Congratulations! We are done! So what we learned today? Building compiler is actually easier than it seems! Happy compiling everyone!</p>

<p><img src="http://i.imgur.com/cmm6AWx.jpg" alt="Sad Loli" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Writing Micro Compiler in OCaml]]></title>
    <link href="http://troydm.github.io/blog/2014/03/29/writing-micro-compiler-in-ocaml/"/>
    <updated>2014-03-29T19:12:25+04:00</updated>
    <id>http://troydm.github.io/blog/2014/03/29/writing-micro-compiler-in-ocaml</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing micro compiler in OCaml</em></p>

<p>At one point or another every single software developer in the world comes to a realization in his career when the time is ripe and it&rsquo;s time
to write your own super cool programming language.</p>

<p><img src="http://i.imgur.com/KSiXBCN.png" alt="Lemon Loli" /></p>

<p>However the subject of creating your own programming language with an compiler is quite a complex one and can&rsquo;t be tackled without some pre-research.
That&rsquo;s how I&rsquo;ve started reading <a href="http://www.amazon.com/Crafting-Compiler-Charles-N-Fischer/dp/0805321667/">Crafting Compiler in C</a>, an aged but
really comprehensive book about developing your own compiler for an <a href="http://en.wikipedia.org/wiki/Ada_%28programming_language%29">Ada</a>-like programming language.
Second chapter describes writing a really simple micro language targeting pseudo assembly-like output in order to explain the core concepts of developing your
own compiler and writing an <a href="https://en.wikipedia.org/wiki/LL_parser">LL(1)</a> parser.</p>

<p>Let&rsquo;s try rewriting this micro compiler in <a href="http://ocaml.org/">OCaml</a>, a language better suited for writing compilers that is becoming quite popular due to it&rsquo;s clean syntax and strict evaluation semantics combined
with functional and object-oriented programming styles. If you are not familiar with OCaml try reading <a href="https://realworldocaml.org/">Real World OCaml</a> first.
Instead of outputting pseudo assembly our micro compiler will output a real <a href="http://www.nasm.us/">nasm</a> source code which will be automatically compiled into a binary executable file.</p>

<!--more-->


<p>So let&rsquo;s start by describing simple micro language with an example source code</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>begin
</span><span class='line'>    a := 1;
</span><span class='line'>    b := a + 1;
</span><span class='line'>    b := b + 1;
</span><span class='line'>    write (a,b);
</span><span class='line'>    read(a,b);
</span><span class='line'>    write (a+10, b+10);
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>As you can see from example source code the program starts with <strong>begin</strong> keyword and ends with an <strong>end</strong> keyword. It has only integer variables which must be predefined by assignment operation before using in expressions, and it also has two simple functions <strong>read</strong> and <strong>write</strong>.</p>

<p><strong>read</strong> takes a list of variable names separated by comma and reads user input from <em>stdin</em> into those variables</p>

<p><strong>write</strong> takes a list of expressions and outputs them into <em>stdout</em></p>

<p>Now in order to create an executable from this source code first we need to parse it. Since LL(1) type parser is enough to parse this kind of language, we&rsquo;ll need only one character lookahead.
 Unfortunately OCaml doesn&rsquo;t have an unread operation like libc&rsquo;s <strong>ungetc</strong> so we&rsquo;ll need to define a simple stream reader which will have a <em>mutable char</em> and we will also count lines of source code read.
We&rsquo;ll also define two utility functions which we will use later which will check if a character is alphanumeric and if it&rsquo;s a digit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* stream *)</span>
</span><span class='line'><span class="k">type</span> <span class="n">stream</span> <span class="o">=</span> <span class="o">{</span> <span class="k">mutable</span> <span class="n">chr</span><span class="o">:</span> <span class="kt">char</span> <span class="n">option</span><span class="o">;</span> <span class="k">mutable</span> <span class="n">line_num</span><span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">chan</span><span class="o">:</span> <span class="n">in_channel</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">open_stream</span> <span class="n">file</span> <span class="o">=</span> <span class="o">{</span> <span class="n">chr</span><span class="o">=</span><span class="nc">None</span><span class="o">;</span> <span class="n">line_num</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="n">chan</span><span class="o">=</span><span class="n">open_in</span> <span class="n">file</span> <span class="o">}</span>
</span><span class='line'><span class="k">let</span> <span class="n">close_stream</span> <span class="n">stm</span> <span class="o">=</span> <span class="n">close_in</span> <span class="n">stm</span><span class="o">.</span><span class="n">chan</span>
</span><span class='line'><span class="k">let</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="o">=</span> <span class="k">match</span> <span class="n">stm</span><span class="o">.</span><span class="n">chr</span> <span class="k">with</span>
</span><span class='line'>                        <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">input_char</span> <span class="n">stm</span><span class="o">.</span><span class="n">chan</span> <span class="k">in</span>
</span><span class='line'>                                <span class="k">if</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span> <span class="k">then</span>
</span><span class='line'>                                    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">line_num</span> <span class="o">&lt;-</span> <span class="n">stm</span><span class="o">.</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span> <span class="n">c</span>
</span><span class='line'>                                <span class="k">else</span> <span class="n">c</span>
</span><span class='line'>                      <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">stm</span><span class="o">.</span><span class="n">chr</span> <span class="o">&lt;-</span> <span class="nc">None</span><span class="o">;</span> <span class="n">c</span>
</span><span class='line'><span class="k">let</span> <span class="n">unread_char</span> <span class="n">stm</span> <span class="n">c</span> <span class="o">=</span> <span class="n">stm</span><span class="o">.</span><span class="n">chr</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="c">(* character *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">is_digit</span> <span class="n">c</span> <span class="o">=</span> <span class="k">let</span> <span class="n">code</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="k">in</span>
</span><span class='line'>                 <span class="n">code</span> <span class="o">&gt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;0&#39;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;9&#39;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">is_alpha</span> <span class="n">c</span> <span class="o">=</span> <span class="k">let</span> <span class="n">code</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="k">in</span>
</span><span class='line'>                 <span class="o">(</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;A&#39;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;Z&#39;</span><span class="o">))</span> <span class="o">||</span>
</span><span class='line'>                 <span class="o">(</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;a&#39;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span><span class="o">(</span><span class="sc">&#39;z&#39;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for our parser we will be parsing source code one token at a time and we&rsquo;ll be recursively calling parsing methods and matching tokens as we go.
We&rsquo;ll define some additional utility functions which will be used during parsing including an <em>Syntax_error</em> exception which will be thrown if invalid
token is scanned.</p>

<p><strong>scan</strong> will scan the stream for next token, that&rsquo;s where our token recognition logic is in.</p>

<p><strong>skip_blank_chars</strong> function will skip any number of blank characters including new line characters</p>

<p><strong>next_token</strong> will return last scanned token or will scan stream for next token</p>

<p><strong>match_next</strong> will match last scanned token or will scan stream for next token, match it and return it</p>

<p><strong>match_token</strong> will match the last scanned token against the specified token in parameter or will scan stream for next token and match against it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* token *)</span>
</span><span class='line'><span class="k">type</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">Begin</span> <span class="o">|</span> <span class="nc">End</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">Identifier</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">Read</span> <span class="o">|</span> <span class="nc">Write</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">Literal</span> <span class="k">of</span> <span class="kt">int</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">Assign</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">LeftParen</span> <span class="o">|</span> <span class="nc">RightParen</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">AddOp</span> <span class="o">|</span> <span class="nc">SubOp</span>
</span><span class='line'>           <span class="o">|</span> <span class="nc">Comma</span> <span class="o">|</span> <span class="nc">Semicolon</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="n">scanner</span> <span class="o">=</span> <span class="o">{</span> <span class="k">mutable</span> <span class="n">last_token</span><span class="o">:</span> <span class="n">token</span> <span class="n">option</span><span class="o">;</span> <span class="n">stm</span><span class="o">:</span> <span class="n">stream</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">exception</span> <span class="nc">Syntax_error</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Syntax_error</span> <span class="o">(</span><span class="n">msg</span> <span class="o">^</span> <span class="s2">&quot; on line &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">s</span><span class="o">.</span><span class="n">stm</span><span class="o">.</span><span class="n">line_num</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">(* skip all blank and new line characters *)</span>
</span><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">skip_blank_chars</span> <span class="n">stm</span> <span class="o">=</span> <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="k">in</span>
</span><span class='line'>                               <span class="k">if</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span>
</span><span class='line'>                               <span class="k">then</span> <span class="n">skip_blank_chars</span> <span class="n">stm</span>
</span><span class='line'>                               <span class="k">else</span> <span class="n">unread_char</span> <span class="n">stm</span> <span class="n">c</span><span class="o">;</span> <span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="c">(* scan a stream and return next token *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">scan</span> <span class="n">s</span> <span class="o">=</span>   <span class="k">let</span> <span class="n">stm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stm</span> <span class="k">in</span> <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="k">in</span>
</span><span class='line'>               <span class="k">let</span> <span class="k">rec</span> <span class="n">scan_iden</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">let</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="k">in</span>
</span><span class='line'>                                       <span class="k">if</span> <span class="n">is_alpha</span> <span class="n">nc</span> <span class="o">||</span> <span class="n">is_digit</span> <span class="n">nc</span> <span class="o">||</span> <span class="n">nc</span><span class="o">=</span><span class="sc">&#39;_&#39;</span>
</span><span class='line'>                                       <span class="k">then</span> <span class="n">scan_iden</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">escaped</span> <span class="n">nc</span><span class="o">))</span>
</span><span class='line'>                                       <span class="k">else</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">unread_char</span> <span class="n">stm</span> <span class="n">nc</span> <span class="k">in</span>
</span><span class='line'>                                            <span class="k">let</span> <span class="n">lc</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">acc</span> <span class="k">in</span>
</span><span class='line'>                                            <span class="k">if</span> <span class="n">lc</span> <span class="o">=</span> <span class="s2">&quot;begin&quot;</span> <span class="k">then</span> <span class="nc">Begin</span>
</span><span class='line'>                                            <span class="k">else</span> <span class="k">if</span> <span class="n">lc</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span> <span class="k">then</span> <span class="nc">End</span>
</span><span class='line'>                                            <span class="k">else</span> <span class="k">if</span> <span class="n">lc</span> <span class="o">=</span> <span class="s2">&quot;read&quot;</span> <span class="k">then</span> <span class="nc">Read</span>
</span><span class='line'>                                            <span class="k">else</span> <span class="k">if</span> <span class="n">lc</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span> <span class="k">then</span> <span class="nc">Write</span>
</span><span class='line'>                                            <span class="k">else</span> <span class="nc">Identifier</span> <span class="n">acc</span>
</span><span class='line'>               <span class="k">in</span>
</span><span class='line'>               <span class="k">let</span> <span class="k">rec</span> <span class="n">scan_lit</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">let</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="k">in</span>
</span><span class='line'>                                      <span class="k">if</span> <span class="n">is_digit</span> <span class="n">nc</span>
</span><span class='line'>                                      <span class="k">then</span> <span class="n">scan_lit</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">escaped</span> <span class="n">nc</span><span class="o">))</span>
</span><span class='line'>                                      <span class="k">else</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">unread_char</span> <span class="n">stm</span> <span class="n">nc</span> <span class="k">in</span>
</span><span class='line'>                                           <span class="nc">Literal</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">acc</span><span class="o">)</span>
</span><span class='line'>               <span class="k">in</span>
</span><span class='line'>               <span class="k">if</span> <span class="n">is_alpha</span> <span class="n">c</span> <span class="k">then</span> <span class="n">scan_iden</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">escaped</span> <span class="n">c</span><span class="o">)</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">is_digit</span> <span class="n">c</span> <span class="k">then</span> <span class="n">scan_lit</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">escaped</span> <span class="n">c</span><span class="o">)</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;+&#39;</span> <span class="k">then</span> <span class="nc">AddOp</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;-&#39;</span> <span class="k">then</span> <span class="nc">SubOp</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;,&#39;</span> <span class="k">then</span> <span class="nc">Comma</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;;&#39;</span> <span class="k">then</span> <span class="nc">Semicolon</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;(&#39;</span> <span class="k">then</span> <span class="nc">LeftParen</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;)&#39;</span> <span class="k">then</span> <span class="nc">RightParen</span>
</span><span class='line'>               <span class="k">else</span> <span class="k">if</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;:&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">read_char</span> <span class="n">stm</span> <span class="o">=</span> <span class="sc">&#39;=&#39;</span> <span class="k">then</span> <span class="nc">Assign</span>
</span><span class='line'>               <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;couldn&#39;t identify the token&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">new_scanner</span> <span class="n">stm</span> <span class="o">=</span> <span class="o">{</span> <span class="n">last_token</span><span class="o">=</span><span class="nc">None</span><span class="o">;</span> <span class="n">stm</span><span class="o">=</span><span class="n">stm</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">match_next</span> <span class="n">s</span> <span class="o">=</span> <span class="k">match</span> <span class="n">s</span><span class="o">.</span><span class="n">last_token</span> <span class="k">with</span>
</span><span class='line'>                      <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">skip_blank_chars</span> <span class="n">s</span><span class="o">.</span><span class="n">stm</span> <span class="k">in</span> <span class="n">scan</span> <span class="n">s</span>
</span><span class='line'>                    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tn</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">last_token</span> <span class="o">&lt;-</span> <span class="nc">None</span><span class="o">;</span> <span class="n">tn</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">match_token</span> <span class="n">s</span> <span class="n">t</span> <span class="o">=</span> <span class="n">match_next</span> <span class="n">s</span> <span class="o">=</span> <span class="n">t</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">next_token</span> <span class="n">s</span> <span class="o">=</span> <span class="k">match</span> <span class="n">s</span><span class="o">.</span><span class="n">last_token</span> <span class="k">with</span>
</span><span class='line'>                        <span class="nc">None</span> <span class="o">-&gt;</span>  <span class="o">(</span><span class="n">skip_blank_chars</span> <span class="n">s</span><span class="o">.</span><span class="n">stm</span><span class="o">;</span>
</span><span class='line'>                                  <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">scan</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                                  <span class="n">s</span><span class="o">.</span><span class="n">last_token</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">t</span><span class="o">;</span> <span class="n">t</span><span class="o">)</span>
</span><span class='line'>                      <span class="o">|</span> <span class="nc">Some</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to generate an asm output we&rsquo;ll define an generator type which will contain the output channel
and variable locations <em>Hashtbl</em>. Each variable&rsquo;s location will be defined as an integer offset from <em>esp</em>
and since our micro language is simple we won&rsquo;t have to handle advanced aspects of variable scope and stack
handling.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* code generation *)</span>
</span><span class='line'><span class="k">type</span> <span class="n">generator</span> <span class="o">=</span> <span class="o">{</span> <span class="n">vars</span><span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">;</span> <span class="n">file</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">chan</span><span class="o">:</span> <span class="n">out_channel</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">new_generator</span> <span class="n">file</span> <span class="o">=</span> <span class="k">let</span> <span class="n">fs</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">file</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;.s&quot;</span> <span class="k">in</span>
</span><span class='line'>                         <span class="o">{</span> <span class="n">vars</span><span class="o">=</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">100</span><span class="o">;</span> <span class="n">file</span><span class="o">=</span><span class="n">fs</span><span class="o">;</span> <span class="n">chan</span><span class="o">=</span><span class="n">open_out</span> <span class="n">fs</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">close_generator</span> <span class="n">g</span> <span class="o">=</span> <span class="n">close_out</span> <span class="n">g</span><span class="o">.</span><span class="n">chan</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">gen</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="n">output_string</span> <span class="n">g</span><span class="o">.</span><span class="n">chan</span> <span class="n">v</span><span class="o">;</span> <span class="n">output_string</span> <span class="n">g</span><span class="o">.</span><span class="n">chan</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need to distinguish between ordinary variables and an temporary ones.
Our temporary variables will be defined automatically and will start from <em>__temp</em> following
variable location offset. This way we won&rsquo;t be storing temporary variables in <em>Hashtbl</em> and will be
computing their offset from their name. We&rsquo;ll also define some additional generator helper functions to output asm code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">bottom_var</span> <span class="o">_</span> <span class="n">g</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">v</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="k">then</span> <span class="o">(</span><span class="n">v</span><span class="o">+</span><span class="mi">4</span><span class="o">)</span> <span class="k">else</span> <span class="n">c</span><span class="o">)</span> <span class="n">g</span><span class="o">.</span><span class="n">vars</span> <span class="mi">0</span>
</span><span class='line'><span class="k">let</span> <span class="n">empty_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">bottom_var</span> <span class="n">s</span> <span class="n">g</span><span class="o">)+(</span><span class="mi">4</span><span class="o">*(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">var_addr</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">v</span> <span class="mi">0</span> <span class="mi">6</span> <span class="o">=</span> <span class="s2">&quot;__temp&quot;</span>
</span><span class='line'>                <span class="k">then</span> <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">v</span> <span class="mi">6</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">v</span><span class="o">)</span> <span class="o">-</span> <span class="mi">6</span><span class="o">)</span> <span class="k">in</span> <span class="s2">&quot;[esp+&quot;</span> <span class="o">^</span> <span class="n">i</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                <span class="k">try</span> <span class="s2">&quot;[esp+&quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">g</span><span class="o">.</span><span class="n">vars</span> <span class="n">v</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
</span><span class='line'>                <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="o">(</span><span class="s2">&quot;identifier &quot;</span> <span class="o">^</span> <span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; not defined&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;dword &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">var_addr</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span> <span class="o">=</span> <span class="nc">Identifier</span> <span class="o">(</span><span class="s2">&quot;__temp&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">empty_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">is_alloc_var</span> <span class="o">_</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">g</span><span class="o">.</span><span class="n">vars</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">alloc_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_alloc_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">then</span> <span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span>
</span><span class='line'>                      <span class="k">else</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">g</span><span class="o">.</span><span class="n">vars</span> <span class="n">v</span> <span class="o">(</span><span class="n">empty_var</span> <span class="n">s</span> <span class="n">g</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span> <span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="o">=</span> <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
</span><span class='line'>                         <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span>
</span><span class='line'>                       <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;identifier expected&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">op</span> <span class="n">g</span> <span class="n">opcode</span> <span class="n">a</span> <span class="o">=</span> <span class="n">gen</span> <span class="n">g</span> <span class="o">(</span><span class="s2">&quot;    &quot;</span> <span class="o">^</span> <span class="n">opcode</span> <span class="o">^</span> <span class="s2">&quot;  &quot;</span> <span class="o">^</span> <span class="n">a</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">op2</span> <span class="n">g</span> <span class="n">opcode</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gen</span> <span class="n">g</span> <span class="o">(</span><span class="s2">&quot;    &quot;</span> <span class="o">^</span> <span class="n">opcode</span> <span class="o">^</span> <span class="s2">&quot;  &quot;</span> <span class="o">^</span> <span class="n">a</span> <span class="o">^</span> <span class="s2">&quot;, &quot;</span> <span class="o">^</span> <span class="n">b</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">push</span> <span class="n">g</span> <span class="n">a</span> <span class="o">=</span> <span class="n">op</span> <span class="n">g</span> <span class="s2">&quot;push&quot;</span> <span class="n">a</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in order to compile a source code we need to create a new generator, open an stream on a source file, parse it,
compile the asm source code using <em>nasm</em> and link the generated <em>.o</em> file into an elf executable.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* compiling *)</span>
</span><span class='line'><span class="k">let</span> <span class="n">compile</span> <span class="n">file</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">new_generator</span> <span class="n">file</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">stm</span> <span class="o">=</span> <span class="n">open_stream</span> <span class="n">file</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">file</span> <span class="k">in</span>
</span><span class='line'>        <span class="n">parse</span> <span class="n">stm</span> <span class="n">g</span><span class="o">;</span>
</span><span class='line'>        <span class="n">close_stream</span> <span class="n">stm</span><span class="o">;</span>
</span><span class='line'>        <span class="n">close_generator</span> <span class="n">g</span><span class="o">;</span>
</span><span class='line'>        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;nasm -f elf &quot;</span> <span class="o">^</span> <span class="n">g</span><span class="o">.</span><span class="n">file</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;gcc -o &quot;</span> <span class="o">^</span> <span class="n">out</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">out</span> <span class="o">^</span> <span class="s2">&quot;.o&quot;</span><span class="o">)</span> <span class="k">in</span> <span class="bp">()</span>
</span><span class='line'>    <span class="k">with</span> <span class="nc">Syntax_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nn">Format</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;syntax error: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'>            <span class="nn">Format</span><span class="p">.</span><span class="n">print_flush</span><span class="bp">()</span>
</span><span class='line'>       <span class="o">|</span> <span class="nc">Sys_error</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="n">print_string</span> <span class="s2">&quot;no such file found</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">help</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="s2">&quot;micro &lt;file&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">help</span> <span class="bp">()</span>
</span><span class='line'>         <span class="k">else</span>
</span><span class='line'>             <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">get</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span>
</span><span class='line'>             <span class="k">in</span>
</span><span class='line'>             <span class="nn">Format</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;compiling %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">file</span><span class="o">;</span>
</span><span class='line'>             <span class="nn">Format</span><span class="p">.</span><span class="n">print_flush</span> <span class="bp">()</span><span class="o">;</span>
</span><span class='line'>             <span class="n">compile</span> <span class="n">file</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our parsing method will be combined with semantics checking and will output <em>asm</em> code using generator functions which we will define later.
Program begins from <em>begin</em> keyword, ends with <em>end</em> keyword and has 0 or more statements in between.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">parse</span> <span class="n">stm</span> <span class="n">g</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="n">new_scanner</span> <span class="n">stm</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>            <span class="n">program</span> <span class="n">s</span> <span class="n">g</span>
</span><span class='line'>        <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;program reached end of file before end keyword&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">program</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Begin</span> <span class="k">then</span>
</span><span class='line'>                    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_begin</span> <span class="n">s</span> <span class="n">g</span> <span class="k">in</span>
</span><span class='line'>                    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">statements</span> <span class="n">s</span> <span class="n">g</span> <span class="k">in</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">End</span> <span class="k">then</span>
</span><span class='line'>                    <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_end</span> <span class="n">s</span> <span class="n">g</span> <span class="k">in</span> <span class="bp">()</span>
</span><span class='line'>                    <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;program should end with end keyword&quot;</span>
</span><span class='line'>                <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;program should start with begin keyword&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">statements</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">if</span> <span class="n">statement</span> <span class="n">s</span> <span class="n">g</span> <span class="k">then</span> <span class="n">statements</span> <span class="n">s</span> <span class="n">g</span> <span class="k">else</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each statement is either an <em>read</em>, <em>write</em> or an assignment to a variable.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">statements</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">if</span> <span class="n">statement</span> <span class="n">s</span> <span class="n">g</span> <span class="k">then</span> <span class="n">statements</span> <span class="n">s</span> <span class="n">g</span> <span class="k">else</span> <span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">statement</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">next_token</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                  <span class="k">if</span> <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
</span><span class='line'>                      <span class="nc">Read</span> <span class="o">-&gt;</span> <span class="n">read</span> <span class="n">s</span> <span class="n">g</span>
</span><span class='line'>                    <span class="o">|</span> <span class="nc">Write</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="n">s</span> <span class="n">g</span>
</span><span class='line'>                    <span class="o">|</span> <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">assignment</span> <span class="n">s</span> <span class="n">g</span>
</span><span class='line'>                    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</span><span class='line'>                  <span class="k">then</span>
</span><span class='line'>                      <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Semicolon</span> <span class="k">then</span> <span class="bp">true</span>
</span><span class='line'>                      <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;statement must end with semicolon&quot;</span>
</span><span class='line'>                  <span class="k">else</span> <span class="bp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each assignment statement has an identifier token on it&rsquo;s left side followed by an assignment token and expression
on the right hand side.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">assignment</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="n">match_next</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                     <span class="k">match</span> <span class="n">id</span> <span class="k">with</span>
</span><span class='line'>                        <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Assign</span> <span class="k">then</span>
</span><span class='line'>                                               <span class="k">let</span> <span class="n">new_var</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_alloc_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">in</span>
</span><span class='line'>                                               <span class="k">let</span> <span class="n">id2</span> <span class="o">=</span> <span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="o">(</span><span class="mi">1</span><span class="o">+</span><span class="n">new_var</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>                                               <span class="k">match</span> <span class="n">id2</span> <span class="k">with</span>
</span><span class='line'>                                                   <span class="nc">Literal</span> <span class="n">l2</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_assign</span> <span class="n">s</span> <span class="n">g</span> <span class="n">id</span> <span class="n">id2</span> <span class="k">in</span> <span class="bp">true</span>
</span><span class='line'>                                                 <span class="o">|</span> <span class="nc">Identifier</span> <span class="n">i2</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_assign</span> <span class="n">s</span> <span class="n">g</span> <span class="n">id</span> <span class="n">id2</span> <span class="k">in</span> <span class="bp">true</span>
</span><span class='line'>                                                 <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;literal or identifier expected&quot;</span>
</span><span class='line'>                                         <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;assign symbol expected&quot;</span><span class="o">)</span>
</span><span class='line'>                      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;identifier expected&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each expression statement is primary optionally followed by an operation token and another primary.
Primary might also be an expression in curly brackets.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">primary</span> <span class="n">s</span> <span class="o">=</span> <span class="k">match</span> <span class="o">(</span><span class="n">next_token</span> <span class="n">s</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                            <span class="nc">LeftParen</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">LeftParen</span> <span class="k">in</span>
</span><span class='line'>                                          <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="o">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>                                          <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">RightParen</span> <span class="k">then</span> <span class="nc">Some</span> <span class="n">e</span>
</span><span class='line'>                                          <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;right paren expected in expression&quot;</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i</span><span class="o">)</span> <span class="k">in</span> <span class="nc">Some</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="nc">Literal</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="o">(</span><span class="nc">Literal</span> <span class="n">l</span><span class="o">)</span> <span class="k">in</span> <span class="nc">Some</span> <span class="o">(</span><span class="nc">Literal</span> <span class="n">l</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span>
</span><span class='line'>        <span class="k">in</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">primary</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">lp</span> <span class="k">with</span>
</span><span class='line'>            <span class="nc">Some</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">match</span> <span class="o">(</span><span class="n">next_token</span> <span class="n">s</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                             <span class="nc">AddOp</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">AddOp</span> <span class="k">in</span>
</span><span class='line'>                                      <span class="n">addop</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="o">(</span><span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="o">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>                           <span class="o">|</span> <span class="nc">SubOp</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">SubOp</span> <span class="k">in</span>
</span><span class='line'>                                      <span class="n">subop</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="o">(</span><span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="o">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>                           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">l</span><span class="o">)</span>
</span><span class='line'>          <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;literal or identifier expected&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our micro language supports only two operations on integers, addition and subtraction, but
it can be easily extended to support more.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">addop</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="n">r</span> <span class="o">=</span> <span class="k">match</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                            <span class="o">(</span><span class="nc">Literal</span> <span class="n">l1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Literal</span> <span class="o">(</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">generate_add</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="n">r</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">(</span><span class="nc">Literal</span> <span class="n">l1</span><span class="o">,</span> <span class="nc">Identifier</span> <span class="n">i2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">generate_add</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">r</span> <span class="n">l</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;expected literal or identifier for add operation&quot;</span>
</span><span class='line'><span class="k">let</span> <span class="n">subop</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="n">r</span> <span class="o">=</span> <span class="k">match</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                            <span class="o">(</span><span class="nc">Literal</span> <span class="n">l1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Literal</span> <span class="o">(</span><span class="n">l1</span><span class="o">-</span><span class="n">l2</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">generate_sub</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="n">r</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">(</span><span class="nc">Literal</span> <span class="n">l1</span><span class="o">,</span> <span class="nc">Identifier</span> <span class="n">i2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">generate_sub</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">l</span> <span class="n">r</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;expected literal or identifier for sub operation&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>write</em> statement is just comma separated list of expressions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">write</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">let</span> <span class="k">rec</span> <span class="n">expressions</span> <span class="n">c</span> <span class="o">=</span>
</span><span class='line'>                    <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">expression</span> <span class="n">s</span> <span class="n">g</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>                    <span class="k">if</span> <span class="k">match</span> <span class="n">e</span> <span class="k">with</span>
</span><span class='line'>                        <span class="nc">Identifier</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_write</span> <span class="n">s</span> <span class="n">g</span> <span class="n">e</span> <span class="k">in</span> <span class="bp">true</span>
</span><span class='line'>                      <span class="o">|</span> <span class="nc">Literal</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_write</span> <span class="n">s</span> <span class="n">g</span> <span class="n">e</span> <span class="k">in</span> <span class="bp">true</span>
</span><span class='line'>                      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</span><span class='line'>                    <span class="k">then</span> <span class="k">if</span> <span class="o">(</span><span class="n">next_token</span> <span class="n">s</span><span class="o">)</span> <span class="o">=</span> <span class="nc">Comma</span> <span class="k">then</span>
</span><span class='line'>                            <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Comma</span> <span class="k">in</span> <span class="n">expressions</span> <span class="o">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>                         <span class="k">else</span> <span class="o">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>                    <span class="k">else</span> <span class="n">c</span>
</span><span class='line'>                <span class="k">in</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Write</span> <span class="k">then</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">LeftParen</span> <span class="k">then</span>
</span><span class='line'>                        <span class="k">if</span> <span class="n">expressions</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">RightParen</span> <span class="k">then</span> <span class="bp">true</span>
</span><span class='line'>                            <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;right paren expected in write statement&quot;</span>
</span><span class='line'>                        <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;write statement expected atleast one expression&quot;</span>
</span><span class='line'>                    <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;left paren expected in write statement&quot;</span>
</span><span class='line'>                <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;write statement expected&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>read</em> statement is a comma separated list of identifiers</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">read</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Read</span> <span class="k">then</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">LeftParen</span> <span class="k">then</span>
</span><span class='line'>                    <span class="k">let</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">identifiers</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">then</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;read statement expects comma seperated identifier(s)&quot;</span>
</span><span class='line'>                    <span class="k">else</span> <span class="k">if</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">RightParen</span> <span class="k">then</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_reads</span> <span class="n">s</span> <span class="n">g</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">ids</span><span class="o">)</span> <span class="k">in</span> <span class="bp">true</span>
</span><span class='line'>                         <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;right paren expected in read statement&quot;</span>
</span><span class='line'>                <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;left paren expected in read statement&quot;</span>
</span><span class='line'>             <span class="k">else</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;read statement expected&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">identifiers</span> <span class="n">s</span> <span class="o">=</span> <span class="k">let</span> <span class="k">rec</span> <span class="n">idens</span> <span class="n">ids</span> <span class="o">=</span>
</span><span class='line'>                        <span class="k">match</span> <span class="o">(</span><span class="n">next_token</span> <span class="n">s</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                            <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_next</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                                            <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">next_token</span> <span class="n">s</span> <span class="k">in</span>
</span><span class='line'>                                            <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="nc">Comma</span> <span class="k">then</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">match_token</span> <span class="n">s</span> <span class="nc">Comma</span> <span class="k">in</span> <span class="n">idens</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i</span> <span class="o">::</span> <span class="n">ids</span><span class="o">)</span>
</span><span class='line'>                                            <span class="k">else</span> <span class="n">idens</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i</span> <span class="o">::</span> <span class="n">ids</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">ids</span>
</span><span class='line'>                    <span class="k">in</span> <span class="n">idens</span> <span class="bp">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now it&rsquo;s finally time to generate some <em>asm</em> code, let&rsquo;s start from <em>begin</em> and <em>end</em> of our program.
Our program will preallocate 1000 bytes on stack for variables, since all of our variables are static.
We&rsquo;ll also need to define external libc functions <strong>scanf</strong> and <strong>printf</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">generate_begin</span> <span class="o">_</span> <span class="n">g</span> <span class="o">=</span> <span class="n">gen</span> <span class="n">g</span>
</span><span class='line'><span class="s2">&quot;extern printf</span>
</span><span class='line'><span class="s2">extern scanf</span>
</span><span class='line'>
</span><span class='line'><span class="s2">section .data</span>
</span><span class='line'><span class="s2">    inf: db &#39;%d&#39;, 0</span>
</span><span class='line'><span class="s2">    ouf: db &#39;%d&#39;, 10, 0</span>
</span><span class='line'>
</span><span class='line'><span class="s2">section .text</span>
</span><span class='line'><span class="s2">    global main</span>
</span><span class='line'>
</span><span class='line'><span class="s2">main:</span>
</span><span class='line'><span class="s2">    sub   esp, 1000&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_end</span> <span class="o">_</span> <span class="n">g</span> <span class="o">=</span> <span class="n">gen</span> <span class="n">g</span>
</span><span class='line'><span class="s2">&quot;    add   esp, 1000</span>
</span><span class='line'><span class="s2">exit:</span>
</span><span class='line'><span class="s2">    mov  eax, 1 ; sys_exit</span>
</span><span class='line'><span class="s2">    mov  ebx, 0</span>
</span><span class='line'><span class="s2">    int  80h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>read</em> and <em>write</em> statements will use libc <strong>scanf</strong> and <strong>printf</strong> functions to read integer variables
from <em>stdin</em> and output them on <em>stdout</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">generate_read</span> <span class="n">s</span> <span class="n">g</span> <span class="n">id</span> <span class="o">=</span> <span class="k">match</span> <span class="n">id</span> <span class="k">with</span>
</span><span class='line'>                            <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;lea&quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="o">(</span><span class="n">var_addr</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>                                             <span class="n">push</span> <span class="n">g</span> <span class="s2">&quot;eax&quot;</span><span class="o">;</span>
</span><span class='line'>                                             <span class="n">push</span> <span class="n">g</span> <span class="s2">&quot;inf&quot;</span><span class="o">;</span>
</span><span class='line'>                                             <span class="n">op</span> <span class="n">g</span> <span class="s2">&quot;call&quot;</span> <span class="s2">&quot;scanf&quot;</span><span class="o">;</span>
</span><span class='line'>                                             <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;add &quot;</span> <span class="s2">&quot;esp&quot;</span> <span class="s2">&quot;8&quot;</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate read called with invalid argument&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">rec</span> <span class="n">generate_reads</span> <span class="n">s</span> <span class="n">g</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">generate_read</span> <span class="n">s</span> <span class="n">g</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_write</span> <span class="n">s</span> <span class="n">g</span> <span class="n">id</span> <span class="o">=</span> <span class="k">match</span> <span class="n">id</span> <span class="k">with</span>
</span><span class='line'>                            <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">push</span> <span class="n">g</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>                                             <span class="n">push</span> <span class="n">g</span> <span class="s2">&quot;ouf&quot;</span><span class="o">;</span>
</span><span class='line'>                                             <span class="n">op</span> <span class="n">g</span> <span class="s2">&quot;call&quot;</span> <span class="s2">&quot;printf&quot;</span><span class="o">;</span>
</span><span class='line'>                                             <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;add &quot;</span> <span class="s2">&quot;esp&quot;</span> <span class="s2">&quot;8&quot;</span><span class="o">)</span>
</span><span class='line'>                          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate write called with invalid argument&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assignment statement is just an allocation of a variable followed by a copying variable from one location
into another. Our copy function understands literal variables and translates their values directly into <em>asm</em> code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">generate_assign</span> <span class="n">s</span> <span class="n">g</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
</span><span class='line'>                                <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">alloc_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span> <span class="k">in</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">a</span> <span class="n">b</span>
</span><span class='line'>                              <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate assign called with invalid argument&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
</span><span class='line'>                                <span class="nc">Identifier</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
</span><span class='line'>                                                        <span class="nc">Identifier</span> <span class="n">i2</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;mov &quot;</span> <span class="s2">&quot;eax&quot;</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i2</span><span class="o">);</span>
</span><span class='line'>                                                                          <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;mov &quot;</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span><span class="o">)</span> <span class="s2">&quot;eax&quot;</span><span class="o">)</span>
</span><span class='line'>                                                      <span class="o">|</span> <span class="nc">Literal</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;mov &quot;</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">l</span><span class="o">)</span>
</span><span class='line'>                                                      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate copy called with invalid argument&quot;</span><span class="o">)</span>
</span><span class='line'>                              <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate copy called with invalid argument&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Addition and subtraction operations use temporary variables to add and subtract
values from two variables and return result</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">generate_add</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">id1</span> <span class="n">id2</span> <span class="o">=</span> <span class="k">match</span> <span class="o">(</span><span class="n">id1</span><span class="o">,</span> <span class="n">id2</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                                     <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Identifier</span> <span class="n">i2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="n">id1</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;add &quot;</span> <span class="n">vi</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i2</span><span class="o">)</span> <span class="k">in</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>                                   <span class="o">|</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="n">id1</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;add &quot;</span> <span class="n">vi</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">l2</span><span class="o">)</span> <span class="k">in</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>                                   <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate exp called with invalid argument&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generate_sub</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="n">id1</span> <span class="n">id2</span> <span class="o">=</span> <span class="k">match</span> <span class="o">(</span><span class="n">id1</span><span class="o">,</span> <span class="n">id2</span><span class="o">)</span> <span class="k">with</span>
</span><span class='line'>                                     <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Identifier</span> <span class="n">i2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="n">id1</span> <span class="k">in</span>
</span><span class='line'>                                                                        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;sub &quot;</span> <span class="n">vi</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i2</span><span class="o">)</span> <span class="k">in</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>                                   <span class="o">|</span> <span class="o">(</span><span class="nc">Identifier</span> <span class="n">i1</span><span class="o">,</span> <span class="nc">Literal</span> <span class="n">l2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="n">id1</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;sub &quot;</span> <span class="n">vi</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">l2</span><span class="o">)</span> <span class="k">in</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>                                   <span class="o">|</span> <span class="o">(</span><span class="nc">Literal</span> <span class="n">l1</span><span class="o">,</span> <span class="nc">Identifier</span> <span class="n">i2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">temp_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">d</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="n">vi</span> <span class="o">=</span> <span class="n">token_var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">generate_copy</span> <span class="n">s</span> <span class="n">g</span> <span class="n">v</span> <span class="n">id1</span> <span class="k">in</span>
</span><span class='line'>                                                                     <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">op2</span> <span class="n">g</span> <span class="s2">&quot;sub &quot;</span> <span class="n">vi</span> <span class="o">(</span><span class="n">var</span> <span class="n">s</span> <span class="n">g</span> <span class="n">i2</span><span class="o">)</span> <span class="k">in</span> <span class="n">v</span><span class="o">)</span>
</span><span class='line'>                                   <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">syntax_error</span> <span class="n">s</span> <span class="s2">&quot;generate exp called with invalid argument&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s all of it! We now have a trivial micro compiler that generates binary executable file.
Source code can be found in my github <a href="https://github.com/troydm/micro/">micro</a> repo. Writing an compiler
is quite complex and entertaining task but it&rsquo;s definitely worth the time spend on!</p>

<p><img src="http://i.imgur.com/ArEvld4.png" alt="Kawaii Loli" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making 30 years old Pascal code run again]]></title>
    <link href="http://troydm.github.io/blog/2014/01/26/making-30-years-old-pascal-code-run-again/"/>
    <updated>2014-01-26T22:48:00+04:00</updated>
    <id>http://troydm.github.io/blog/2014/01/26/making-30-years-old-pascal-code-run-again</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Fixing some really old Prolog implementation written in Pascal</em></p>

<p>Recently I&rsquo;ve been interested in <a href="https://en.wikipedia.org/wiki/Logic_programming">Logic Programming</a>, notably in learning <a href="https://en.wikipedia.org/wiki/Prolog">Prolog</a>
so I&rsquo;m in a process of reading two great books, <a href="http://www.amazon.com/Prolog-Programming-Artificial-Intelligence-Bratko/dp/0201403757/">Programming for Artificial Intelligence</a> and
<a href="http://www.amazon.com/The-Art-Prolog-Programming-Techniques/dp/0262192500/">The Art of Prolog</a>. If you want to get a quick feel of <em>Prolog</em> I recommend you take a look at
Bernardo Pires&rsquo;s <a href="https://bernardopires.com/2013/10/try-logic-programming-a-gentle-introduction-to-prolog/">Gentle Introduction to Prolog</a> and <a href="http://prologomenon.wordpress.com/">Prologomenon</a> blog.
To put it simply <em>Prolog</em> is all about logic, deduction and backtracking</p>

<p><img src="http://i.imgur.com/Mwlmvyk.jpg" alt="Sherlock Loli" /></p>

<p>While browsing <a href="http://reddit.com/r/prolog">/r/prolog</a> I&rsquo;ve stumbled upon <a href="https://sites.google.com/site/prologforprogrammers/">Prolog for Programmers</a> originally published in 1985, an old book indeed
and honestly sometimes hard to follow. I can&rsquo;t recommend it as a starter book about <em>Prolog</em> but it&rsquo;s still quite interesting to read. However it has a whole two chapters describing implementation of
<em>Prolog</em> interpreter which is quite a complex task and sparkled my interest in continuing reading this book. Authors provide source code of two version of Prolog interpreter,
the one they originally wrote in <em>Pascal</em> back in 1983 and it&rsquo;s port to <em>C</em> in 2013 which, as stated on their website, was done because they couldn&rsquo;t compile old <em>Pascal</em> code
with <a href="http://www.freepascal.org/">Free Pascal Compiler</a> and because&hellip; well <em>Pascal</em> is quite out of fashion nowadays. Couldn&rsquo;t compile?! Well, challenge accepted!</p>

<!-- more -->


<p>We&rsquo;ll start with <em>toy.p</em> (original source code) and <em>syskernel</em> (boot file written in toy&rsquo;s original prolog syntax) file. Let&rsquo;s create a <em>Makefile</em> and try compiling the software with <em>fpc</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>############
</span><span class='line'>FPC=/usr/bin/fpc
</span><span class='line'>FPCFLAGS=-O3 
</span><span class='line'>############
</span><span class='line'>all: toy
</span><span class='line'>
</span><span class='line'>toy: toy.p 
</span><span class='line'>        $(FPC) $(FPCFLAGS) $&lt;
</span><span class='line'>        
</span><span class='line'>############
</span><span class='line'>clean:
</span><span class='line'>        rm -f toy*.o
</span><span class='line'>                
</span><span class='line'>distclean: clean
</span><span class='line'>        rm -f toy</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try running <em>make</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3  toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(260,1) Error: Goto statements aren't allowed between different procedures
</span><span class='line'>toy.p(306,1) Error: Goto statements aren't allowed between different procedures
</span><span class='line'>toy.p(348,18) Error: Incompatible type for arg no. 2: Got "Array[1..35] Of Char", expected "LongInt"
</span><span class='line'>toy.p(351,20) Error: Incompatible type for arg no. 2: Got "Array[1..35] Of Char", expected "LongInt"
</span><span class='line'>toy.p(453,21) Fatal: Syntax error, "identifier" expected but "STRING" found
</span><span class='line'>Fatal: Compilation aborted</span></code></pre></td></tr></table></div></figure>


<p>First two errors are <em>goto</em> statement related, let&rsquo;s see the source code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">label</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">;</span>  <span class="cm">(* error halt &amp; almost-fatal error recovery only *)</span>
</span><span class='line'>
</span><span class='line'><span class="k">procedure</span> <span class="nf">halt</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* this might be implementation-dependent *)</span>
</span><span class='line'><span class="k">begin</span>   <span class="nb">writeln</span><span class="o">;</span>   <span class="nb">writeln</span> <span class="p">(</span> <span class="s">&#39; ******toyprolog aborted******&#39;</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">procedure</span> <span class="nf">errror</span> <span class="p">(</span> <span class="n">id</span> <span class="o">:</span> <span class="n">errid</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="nb">writeln</span><span class="o">;</span>
</span><span class='line'>        <span class="nb">write</span> <span class="p">(</span> <span class="s">&#39; ++++++error : &#39;</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>        <span class="o">....</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">id</span> <span class="k">in</span> <span class="p">[</span> <span class="n">ctovflw</span><span class="o">,</span> <span class="n">protovflw</span><span class="o">,</span> <span class="n">loadfile</span><span class="o">,</span> <span class="n">sysinit</span><span class="o">,</span> <span class="n">usereof</span> <span class="p">]</span> <span class="k">then</span> <span class="nb">halt</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">goto</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">begin</span> <span class="cm">(*********** toy prolog ************)</span>
</span><span class='line'>        <span class="n">initvars</span><span class="o">;</span>
</span><span class='line'>        <span class="n">loadsyskernel</span><span class="o">;</span>
</span><span class='line'><span class="mi">2</span><span class="o">:</span>      <span class="k">repeat</span>  <span class="n">readtogoal</span> <span class="p">(</span> <span class="n">goalstmnt</span><span class="o">,</span> <span class="n">ngoalvars</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>                <span class="n">resolve</span> <span class="p">(</span> <span class="n">goalstmnt</span><span class="o">,</span> <span class="n">ngoalvars</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">until</span> <span class="n">terminate</span><span class="o">;</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span>      <span class="nb">closefile</span> <span class="p">(</span> <span class="k">true</span> <span class="p">)</span><span class="o">;</span>   <span class="nb">closefile</span> <span class="p">(</span> <span class="k">false</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, apparently back in the 80&rsquo;s you could jump between procedures in <em>Pascal</em> using <em>goto</em> statements, some primitive try/catch mechanism.
Now that&rsquo;s a neat thing but unfortunetly no, you can&rsquo;t do that anymore. Let&rsquo;s change this code to use exceptions. One thing to note we can substitute
<em>goto 1</em> with <em>halt(1)</em> which will make our program exit on critical error. Also we&rsquo;ll need to add <em>-S2</em> flag to <em>FPCFLAGS</em> variable in <em>Makefile</em> since we&rsquo;ll
be using exceptions which is related to classes mechanism of <em>Pascal</em>. And just to be sure we don&rsquo;t override any system procedures we&rsquo;ll rename our <em>halt</em> to
<em>haltsys</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="n">use</span> <span class="n">sysutils</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span>
</span><span class='line'>        <span class="o">....</span>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="k">class</span><span class="p">(</span><span class="n">Exception</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">procedure</span> <span class="nf">haltsys</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* this might be implementation-dependent *)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>    <span class="nb">writeln</span><span class="o">;</span>   <span class="nb">writeln</span> <span class="p">(</span> <span class="s">&#39; ******toyprolog aborted******&#39;</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>    <span class="nb">halt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">procedure</span> <span class="nf">errror</span> <span class="p">(</span> <span class="n">id</span> <span class="o">:</span> <span class="n">errid</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="nb">writeln</span><span class="o">;</span>
</span><span class='line'>        <span class="nb">write</span> <span class="p">(</span> <span class="s">&#39; ++++++error : &#39;</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>        <span class="o">....</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">id</span> <span class="k">in</span> <span class="p">[</span> <span class="n">ctovflw</span><span class="o">,</span> <span class="n">protovflw</span><span class="o">,</span> <span class="n">loadfile</span><span class="o">,</span> <span class="n">sysinit</span><span class="o">,</span> <span class="n">usereof</span> <span class="p">]</span> <span class="k">then</span> <span class="n">haltsys</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">raise</span> <span class="n">error</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="s">&#39;error&#39;</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">(*********** toy prolog ************)</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>    <span class="n">initvars</span><span class="o">;</span>
</span><span class='line'>    <span class="n">loadsyskernel</span><span class="o">;</span>
</span><span class='line'>    <span class="k">repeat</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>            <span class="n">readtogoal</span> <span class="p">(</span> <span class="n">goalstmnt</span><span class="o">,</span> <span class="n">ngoalvars</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>            <span class="n">resolve</span> <span class="p">(</span> <span class="n">goalstmnt</span><span class="o">,</span> <span class="n">ngoalvars</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">except</span> <span class="k">on</span> <span class="n">error</span> <span class="k">do</span> <span class="k">end</span><span class="o">;</span>
</span><span class='line'>    <span class="k">until</span> <span class="n">terminate</span><span class="o">;</span>
</span><span class='line'>    <span class="nb">closefile</span> <span class="p">(</span> <span class="k">true</span> <span class="p">)</span><span class="o">;</span>   <span class="nb">closefile</span> <span class="p">(</span> <span class="k">false</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try running <em>make</em> again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(349,18) Error: Incompatible type for arg no. 2: Got "Array[1..35] Of Char", expected "LongInt"
</span><span class='line'>toy.p(352,20) Error: Incompatible type for arg no. 2: Got "Array[1..35] Of Char", expected "LongInt"
</span><span class='line'>toy.p(454,21) Fatal: Syntax error, "identifier" expected but "STRING" found</span></code></pre></td></tr></table></div></figure>


<p>Good, now <em>goto</em> related error is gone and next we have is something bizzare, let&rsquo;s see the source code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">openfile</span> <span class="p">(</span> <span class="kp">name</span> <span class="o">:</span> <span class="n">ctx</span><span class="o">;</span>  <span class="n">forinput</span> <span class="o">:</span> <span class="kt">boolean</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* open the file (si or so according to 2nd parameter)</span>
</span><span class='line'><span class="cm">   whose name is given by a string in character table.</span>
</span><span class='line'><span class="cm">   a file is opened rewound. if a previous file is open, it is closed.  *)</span>
</span><span class='line'><span class="k">const</span>  <span class="nb">ln</span> <span class="o">=</span> <span class="mi">35</span><span class="o">;</span> <span class="cm">(* for RSX-11 *)</span>
</span><span class='line'><span class="k">var</span>   <span class="n">nm</span> <span class="o">:</span> <span class="k">array</span> <span class="p">[</span> <span class="mi">1</span><span class="o">..</span><span class="n">ln</span> <span class="p">]</span> <span class="k">of</span> <span class="kt">char</span><span class="o">;</span>   <span class="n">k</span> <span class="o">:</span> <span class="mi">1</span><span class="o">..</span><span class="n">ln</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">k</span><span class="o">:=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="nb">ln</span> <span class="p">)</span> <span class="k">and</span> <span class="p">(</span> <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span> <span class="p">)</span> <span class="k">do</span> <span class="k">begin</span>
</span><span class='line'>      <span class="n">nm</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span><span class="o">;</span>   <span class="n">name</span><span class="o">:=</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>   <span class="n">k</span><span class="o">:=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span> <span class="k">then</span> <span class="n">errror</span> <span class="p">(</span> <span class="n">longfilename</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">k</span><span class="o">:=</span> <span class="n">k</span> <span class="k">to</span> <span class="nb">ln</span> <span class="k">do</span> <span class="n">nm</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">:=</span> <span class="s">&#39; &#39;</span><span class="o">;</span>
</span><span class='line'>  <span class="nb">closefile</span> <span class="p">(</span> <span class="n">forinput</span> <span class="p">)</span><span class="o">;</span>               <span class="cm">(* only 1 file per stream *)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">forinput</span> <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>      <span class="nb">reset</span> <span class="p">(</span> <span class="n">si</span><span class="o">,</span> <span class="n">nm</span> <span class="p">)</span><span class="o">;</span>    <span class="n">seeing</span><span class="o">:=</span> <span class="k">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>
</span><span class='line'>      <span class="nb">rewrite</span> <span class="p">(</span> <span class="n">so</span><span class="o">,</span> <span class="n">nm</span> <span class="p">)</span><span class="o">;</span>    <span class="n">telling</span><span class="o">:=</span> <span class="k">true</span><span class="o">;</span>
</span><span class='line'>      <span class="n">solinesize</span><span class="o">:=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="cm">(*openfile*)</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well apparently <em>reset</em> and <em>rewrite</em> procedures don&rsquo;t accept file name as second argument anymore,
instead we need to first <em>assign</em> file name and then open it for reading.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">openfile</span> <span class="p">(</span> <span class="kp">name</span> <span class="o">:</span> <span class="n">ctx</span><span class="o">;</span>  <span class="n">forinput</span> <span class="o">:</span> <span class="kt">boolean</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* open the file (si or so according to 2nd parameter)</span>
</span><span class='line'><span class="cm">   whose name is given by a string in character table.</span>
</span><span class='line'><span class="cm">   a file is opened rewound. if a previous file is open, it is closed.  *)</span>
</span><span class='line'><span class="k">const</span>  <span class="nb">ln</span> <span class="o">=</span> <span class="mi">35</span><span class="o">;</span> <span class="cm">(* for RSX-11 *)</span>
</span><span class='line'><span class="k">var</span>   <span class="n">nm</span> <span class="o">:</span> <span class="k">array</span> <span class="p">[</span> <span class="mi">1</span><span class="o">..</span><span class="n">ln</span> <span class="p">]</span> <span class="k">of</span> <span class="kt">char</span><span class="o">;</span>   <span class="n">k</span> <span class="o">:</span> <span class="mi">1</span><span class="o">..</span><span class="n">ln</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">k</span><span class="o">:=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="nb">ln</span> <span class="p">)</span> <span class="k">and</span> <span class="p">(</span> <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span> <span class="p">)</span> <span class="k">do</span> <span class="k">begin</span>
</span><span class='line'>      <span class="n">nm</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span><span class="o">;</span>   <span class="n">name</span><span class="o">:=</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>   <span class="n">k</span><span class="o">:=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ct</span> <span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span> <span class="k">then</span> <span class="n">errror</span> <span class="p">(</span> <span class="n">longfilename</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">k</span><span class="o">:=</span> <span class="n">k</span> <span class="k">to</span> <span class="nb">ln</span> <span class="k">do</span> <span class="n">nm</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">:=</span> <span class="s">&#39; &#39;</span><span class="o">;</span>
</span><span class='line'>  <span class="nb">closefile</span> <span class="p">(</span> <span class="n">forinput</span> <span class="p">)</span><span class="o">;</span>               <span class="cm">(* only 1 file per stream *)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">forinput</span> <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>            <span class="n">assign</span><span class="p">(</span><span class="n">si</span><span class="o">,</span> <span class="n">nm</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>            <span class="nb">reset</span> <span class="p">(</span> <span class="n">si</span> <span class="p">)</span><span class="o">;</span>    <span class="n">seeing</span><span class="o">:=</span> <span class="k">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>
</span><span class='line'>            <span class="n">assign</span><span class="p">(</span><span class="n">so</span><span class="o">,</span> <span class="n">nm</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>            <span class="nb">rewrite</span> <span class="p">(</span> <span class="n">so</span> <span class="p">)</span><span class="o">;</span>    <span class="n">telling</span><span class="o">:=</span> <span class="k">true</span><span class="o">;</span>
</span><span class='line'>            <span class="n">solinesize</span><span class="o">:=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="cm">(*openfile*)</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try running <em>make</em> again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(456,21) Fatal: Syntax error, "identifier" expected but "STRING" found</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see what we have here</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">function</span> <span class="nf">charlast</span> <span class="p">(</span> <span class="k">string</span> <span class="o">:</span> <span class="n">ctx</span> <span class="p">)</span>  <span class="o">:</span> <span class="n">ctx</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* locate the last character (except eos) of this string *)</span>
</span><span class='line'><span class="k">begin</span>   <span class="k">while</span>  <span class="n">ct</span> <span class="p">[</span> <span class="k">string</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span>  <span class="k">do</span> <span class="k">string</span><span class="o">:=</span> <span class="k">string</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="n">charlast</span><span class="o">:=</span> <span class="k">string</span> <span class="o">-</span> <span class="mi">1</span>     <span class="cm">(*correct because lowest string not empty*)</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can&rsquo;t use <em>string</em> as identifier since it&rsquo;s used as a type keyword nowadays so let&rsquo;s change that</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">function</span> <span class="nf">charlast</span> <span class="p">(</span> <span class="nb">str</span> <span class="o">:</span> <span class="n">ctx</span> <span class="p">)</span>  <span class="o">:</span> <span class="n">ctx</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* locate the last character (except eos) of this str *)</span>
</span><span class='line'><span class="k">begin</span>   <span class="k">while</span>  <span class="n">ct</span> <span class="p">[</span> <span class="nb">str</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="nb">chr</span> <span class="p">(</span> <span class="n">eos</span> <span class="p">)</span>  <span class="k">do</span> <span class="nb">str</span><span class="o">:=</span> <span class="nb">str</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="n">charlast</span><span class="o">:=</span> <span class="nb">str</span> <span class="o">-</span> <span class="mi">1</span>     <span class="cm">(*correct because lowest str not empty*)</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try running <em>make</em> again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(922,7) Fatal: Syntax error, "identifier" expected but "is" found</span></code></pre></td></tr></table></div></figure>


<p>Ahh, same identifier problem but now with <em>is</em> keyword, let&rsquo;s quickly change that too.
Next is same problem but now with <em>class</em> keyword, okey fixed that one too. And again <em>is</em> keyword related problems, fixed.</p>

<p>And now running <em>make</em> again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(1951,36) Error: Identifier not found "success"
</span><span class='line'>toy.p(1956,10) Error: Identifier not found "id"
</span><span class='line'>toy.p(1957,18) Error: Constant and CASE types do not match
</span><span class='line'>toy.p(1957,27) Error: Identifier not found "success"
</span><span class='line'>toy.p(1958,8) Error: Constant and CASE types do not match
</span><span class='line'>toy.p(1959,18) Error: Constant and CASE types do not match
</span><span class='line'>toy.p(1960,18) Error: Constant and CASE types do not match
</span><span class='line'>........</span></code></pre></td></tr></table></div></figure>


<p>ZOMFG, tons of errors :( no worries no worries let&rsquo;s see the code!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">sysroutcall</span> <span class="cm">(* ( id : sysroutid;  var success, stop : boolean ) *)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* perform a system routine call *)</span>
</span><span class='line'><span class="k">var</span>   <span class="n">k</span> <span class="o">:</span> <span class="n">nsysparam</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">syserror</span><span class="o">:=</span> <span class="k">false</span><span class="o">;</span>   <span class="n">success</span><span class="o">:=</span> <span class="k">true</span><span class="o">;</span>     <span class="cm">(* might change yet *)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">k</span><span class="o">:=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">getarity</span> <span class="p">(</span> <span class="n">ccall</span> <span class="p">)</span> <span class="k">do</span> <span class="k">begin</span>
</span><span class='line'>      <span class="n">spar</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">argument</span> <span class="p">(</span> <span class="n">ccall</span><span class="o">,</span> <span class="n">ancenv</span><span class="o">,</span> <span class="n">k</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">isint</span><span class="p">(</span> <span class="n">spar</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="p">)</span> <span class="k">then</span> <span class="n">sparv</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span><span class="o">:=</span> <span class="n">intval</span><span class="p">(</span> <span class="n">spar</span> <span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">id</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">idfail</span>          <span class="o">:</span> <span class="n">success</span><span class="o">:=</span> <span class="k">false</span><span class="o">;</span>      <span class="cm">(* keep this as first  *)</span>
</span><span class='line'>  <span class="n">idtag</span> <span class="o">,</span>
</span><span class='line'>  <span class="n">idcall</span>          <span class="o">:</span> <span class="o">;</span>             <span class="cm">(* never called ! (cf. control) *)</span>
</span><span class='line'>  <span class="n">idslash</span>         <span class="o">:</span> <span class="n">slash</span><span class="o">;</span>
</span><span class='line'>  <span class="n">idtagcut</span>        <span class="o">:</span> <span class="n">tagcut</span> <span class="p">(</span> <span class="n">success</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="n">idtagfail</span>       <span class="o">:</span> <span class="n">tagfail</span> <span class="p">(</span> <span class="n">success</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="n">idtagexit</span>       <span class="o">:</span> <span class="n">tagexit</span> <span class="p">(</span> <span class="n">success</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="n">idancestor</span>      <span class="o">:</span> <span class="n">ancestor</span> <span class="p">(</span> <span class="n">success</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>     <span class="o">.........</span>
</span><span class='line'>  <span class="k">end</span> <span class="cm">(*case*)</span>
</span><span class='line'><span class="k">end</span> <span class="cm">(*sysroutcall*)</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ehh&hellip; why is the procedure argument block commented? Wait we have another <em>sysroutcall</em>
defined in a file previously which is&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">sysroutcall</span> <span class="p">(</span> <span class="n">id</span> <span class="o">:</span> <span class="n">sysroutid</span><span class="o">;</span>  <span class="k">var</span> <span class="n">success</span><span class="o">,</span> <span class="n">stop</span> <span class="o">:</span> <span class="kt">boolean</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="kp">forward</span><span class="o">;</span> <span class="cm">(*----------------------------------------------------------*)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahh it&rsquo;s just a forward definition, well aparently nowadays if you are defining a forward
definition that doesn&rsquo;t mean you don&rsquo;t need to specify procedure arguments again.
Let&rsquo;s uncomment the arguments and try running <em>make</em> again.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(2132,33) Fatal: Syntax error, ":" expected but ";" found
</span><span class='line'>Fatal: Compilation aborted</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see the code</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">function</span> <span class="nf">rdterm</span> <span class="cm">(*  : integer *)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* read a term and return a prot for a non-var or a negated offset for a var.</span>
</span><span class='line'><span class="cm">   sequences processed recursively to allow proper ground prot treatment.   *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">sign</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">..</span><span class="mi">1</span><span class="o">;</span>   <span class="n">varoff</span> <span class="o">:</span> <span class="n">varnumb</span><span class="o">;</span>   <span class="n">prot</span> <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>   <span class="n">dot</span> <span class="o">:</span> <span class="n">protx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">skipbl</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Function result type is commented, probably a typo, let&rsquo;s uncomment it and run <em>make</em> again.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(2138,22) Warning: Function result variable does not seem to initialized
</span><span class='line'>toy.p(2280,26) Error: Incompatible type for arg no. 2: Got "Constant String", expected "LongInt"
</span><span class='line'>toy.p(2314,9) Error: Label used but not defined "2"
</span><span class='line'>toy.p(2314,9) Fatal: Syntax error, ";" expected but "REPEAT" found
</span><span class='line'>Fatal: Compilation aborted</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s a weird error. Let&rsquo;s examine the code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">function</span> <span class="nf">rdterm</span>   <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* read a term and return a prot for a non-var or a negated offset for a var.</span>
</span><span class='line'><span class="cm">   sequences processed recursively to allow proper ground prot treatment.   *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">sign</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">..</span><span class="mi">1</span><span class="o">;</span>   <span class="n">varoff</span> <span class="o">:</span> <span class="n">varnumb</span><span class="o">;</span>   <span class="n">prot</span> <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>   <span class="n">dot</span> <span class="o">:</span> <span class="n">protx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">skipbl</span><span class="o">;</span>
</span><span class='line'>        <span class="nb">writeln</span><span class="p">(</span><span class="s">&#39;rdterm &#39;</span><span class="o">,</span><span class="n">cch</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span> <span class="k">then</span> <span class="k">begin</span>         <span class="cm">(* eg.  a . (b . c) . d *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="n">rdterm</span><span class="o">;</span>   <span class="n">skipbl</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cch</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;)&#39;</span> <span class="k">then</span> <span class="n">synterr</span><span class="o">;</span>   <span class="n">rd</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span> <span class="k">then</span> <span class="k">begin</span>                 <span class="cm">(* a dummy variable *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="n">dumvarx</span>            <span class="cm">(* treated as non-var here *)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="k">then</span> <span class="k">begin</span>                 <span class="cm">(* a variable *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">varoff</span><span class="o">:=</span> <span class="n">rddigits</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="o">-</span> <span class="n">varoff</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">varoff</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">nclvars</span> <span class="k">then</span> <span class="n">nclvars</span><span class="o">:=</span> <span class="n">varoff</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span> <span class="p">)</span> <span class="k">or</span> <span class="p">(</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="p">)</span> <span class="k">or</span> <span class="p">(</span> <span class="n">cc</span> <span class="p">[</span><span class="n">cch</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdigit</span> <span class="p">)</span> <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="k">then</span> <span class="nb">sign</span><span class="o">:=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">sign</span><span class="o">:=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cc</span> <span class="p">[</span> <span class="n">cch</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="n">cdigit</span> <span class="k">then</span> <span class="n">rd</span><span class="o">;</span>
</span><span class='line'>      <span class="cm">(* number itself processed as positive :  this</span>
</span><span class='line'><span class="cm">        causes loss of smallest integer in two&#39;s complement *)</span>
</span><span class='line'>      <span class="n">prot</span><span class="o">:=</span> <span class="n">newintprot</span> <span class="p">(</span> <span class="nb">sign</span> <span class="o">*</span> <span class="n">rddigits</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>
</span><span class='line'>            <span class="n">prot</span><span class="o">:=</span> <span class="n">rdnonvarint</span><span class="o">;</span>
</span><span class='line'>            <span class="n">skipbl</span>
</span><span class='line'>        <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;.&#39;</span> <span class="k">then</span> <span class="n">rdterm</span><span class="o">:=</span> <span class="n">prot</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>                      <span class="cm">(* a sequence, as it turns out *)</span>
</span><span class='line'>      <span class="n">dot</span><span class="o">:=</span> <span class="n">initprot</span> <span class="p">(</span> <span class="n">std</span> <span class="p">[</span><span class="n">atmdot</span><span class="p">]</span> <span class="p">)</span><span class="o">;</span>   <span class="n">mkarg</span> <span class="p">(</span> <span class="n">dot</span><span class="o">,</span> <span class="n">car</span><span class="o">,</span> <span class="n">prot</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">skipcombl</span><span class="o">;</span>
</span><span class='line'>      <span class="n">mkarg</span> <span class="p">(</span> <span class="n">dot</span><span class="o">,</span> <span class="n">cdr</span><span class="o">,</span> <span class="n">rdterm</span> <span class="p">)</span><span class="o">;</span>   <span class="n">rdterm</span><span class="o">:=</span> <span class="n">wrapprot</span> <span class="p">(</span> <span class="n">dot</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="cm">(*rdterm*)</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Seems like <em>fpc</em> can&rsquo;t distinguesh between a recursive function call and a function result value,
so let&rsquo;s add some brackets for function calls.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">function</span> <span class="nf">rdterm</span>   <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* read a term and return a prot for a non-var or a negated offset for a var.</span>
</span><span class='line'><span class="cm">   sequences processed recursively to allow proper ground prot treatment.   *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">sign</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">..</span><span class="mi">1</span><span class="o">;</span>   <span class="n">varoff</span> <span class="o">:</span> <span class="n">varnumb</span><span class="o">;</span>   <span class="n">prot</span> <span class="o">:</span> <span class="kt">integer</span><span class="o">;</span>   <span class="n">dot</span> <span class="o">:</span> <span class="n">protx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="n">skipbl</span><span class="o">;</span>
</span><span class='line'>        <span class="nb">writeln</span><span class="p">(</span><span class="s">&#39;rdterm &#39;</span><span class="o">,</span><span class="n">cch</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span> <span class="k">then</span> <span class="k">begin</span>         <span class="cm">(* eg.  a . (b . c) . d *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="n">rdterm</span><span class="p">()</span><span class="o">;</span>   <span class="n">skipbl</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cch</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;)&#39;</span> <span class="k">then</span> <span class="n">synterr</span><span class="o">;</span>   <span class="n">rd</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span> <span class="k">then</span> <span class="k">begin</span>                 <span class="cm">(* a dummy variable *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="n">dumvarx</span>            <span class="cm">(* treated as non-var here *)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="k">then</span> <span class="k">begin</span>                 <span class="cm">(* a variable *)</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">varoff</span><span class="o">:=</span> <span class="n">rddigits</span><span class="o">;</span>   <span class="n">prot</span><span class="o">:=</span> <span class="o">-</span> <span class="n">varoff</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">varoff</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">nclvars</span> <span class="k">then</span> <span class="n">nclvars</span><span class="o">:=</span> <span class="n">varoff</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span> <span class="p">)</span> <span class="k">or</span> <span class="p">(</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="p">)</span> <span class="k">or</span> <span class="p">(</span> <span class="n">cc</span> <span class="p">[</span><span class="n">cch</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdigit</span> <span class="p">)</span> <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cch</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="k">then</span> <span class="nb">sign</span><span class="o">:=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">sign</span><span class="o">:=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">cc</span> <span class="p">[</span> <span class="n">cch</span> <span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="n">cdigit</span> <span class="k">then</span> <span class="n">rd</span><span class="o">;</span>
</span><span class='line'>      <span class="cm">(* number itself processed as positive :  this</span>
</span><span class='line'><span class="cm">        causes loss of smallest integer in two&#39;s complement *)</span>
</span><span class='line'>      <span class="n">prot</span><span class="o">:=</span> <span class="n">newintprot</span> <span class="p">(</span> <span class="nb">sign</span> <span class="o">*</span> <span class="n">rddigits</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>
</span><span class='line'>            <span class="n">prot</span><span class="o">:=</span> <span class="n">rdnonvarint</span><span class="o">;</span>
</span><span class='line'>            <span class="n">skipbl</span>
</span><span class='line'>        <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cch</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;.&#39;</span> <span class="k">then</span> <span class="n">rdterm</span><span class="o">:=</span> <span class="n">prot</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">begin</span>                      <span class="cm">(* a sequence, as it turns out *)</span>
</span><span class='line'>      <span class="n">dot</span><span class="o">:=</span> <span class="n">initprot</span> <span class="p">(</span> <span class="n">std</span> <span class="p">[</span><span class="n">atmdot</span><span class="p">]</span> <span class="p">)</span><span class="o">;</span>   <span class="n">mkarg</span> <span class="p">(</span> <span class="n">dot</span><span class="o">,</span> <span class="n">car</span><span class="o">,</span> <span class="n">prot</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'>      <span class="n">rd</span><span class="o">;</span>   <span class="n">skipcombl</span><span class="o">;</span>
</span><span class='line'>      <span class="n">mkarg</span> <span class="p">(</span> <span class="n">dot</span><span class="o">,</span> <span class="n">cdr</span><span class="o">,</span> <span class="n">rdterm</span><span class="p">()</span> <span class="p">)</span><span class="o">;</span>   <span class="n">rdterm</span><span class="o">:=</span> <span class="n">wrapprot</span> <span class="p">(</span> <span class="n">dot</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="cm">(*rdterm*)</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>toy.p(2280,26) Error: Incompatible type for arg no. 2: Got "Constant String", expected "LongInt"
</span><span class='line'>toy.p(2322) Fatal: There were 1 errors compiling module, stopping
</span><span class='line'>Fatal: Compilation aborted</span></code></pre></td></tr></table></div></figure>


<p>Ahh we are getting closer to the end, same <em>reset</em> related error, let&rsquo;s fix it by adding <em>assign</em>
and run <em>make</em> again.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/fpc -O3 -S2 toy.p
</span><span class='line'>Free Pascal Compiler version 2.4.0-2ubuntu1.10.04 [2011/06/17] for i386
</span><span class='line'>Copyright (c) 1993-2009 by Florian Klaempfl
</span><span class='line'>Target OS: Linux for i386
</span><span class='line'>Compiling toy.p
</span><span class='line'>Linking toy
</span><span class='line'>/usr/bin/ld: warning: link.res contains output sections; did you forget -T?
</span><span class='line'>2322 lines compiled, 0.3 sec</span></code></pre></td></tr></table></div></figure>


<p>And we did it! Congratulations, it compiles. Let&rsquo;s try running <em>toy</em> executable!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash$ ./toy
</span><span class='line'>Toy-Prolog listening:
</span><span class='line'>?- X=1.
</span><span class='line'>X = 1
</span><span class='line'>;
</span><span class='line'>no
</span><span class='line'>?- display('Hello World!'), nl.
</span><span class='line'>Segmentation fault</span></code></pre></td></tr></table></div></figure>


<p>Well it runs, but function call crashes the toy prolog interpreter.
Let&rsquo;s investigate this issue using <em>gdb</em> debugger.
We&rsquo;ll need to compile code with <em>-g</em> flag to do actual debugging so just add
it to your <em>FPCFLAGS</em> variable in <em>Makefile</em></p>

<p>Now let&rsquo;s start debugging</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash$ gdb ./toy
</span><span class='line'>GNU gdb (GDB) 7.1-ubuntu
</span><span class='line'>Copyright (C) 2010 Free Software Foundation, Inc.
</span><span class='line'>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html>
</span><span class='line'>(gdb) run
</span><span class='line'>Starting program: /home/troydm/projects/toytest/toy 
</span><span class='line'>Toy-Prolog listening:
</span><span class='line'>?- a.     
</span><span class='line'>
</span><span class='line'>Program received signal SIGSEGV, Segmentation fault.
</span><span class='line'>0x0804a831 in PURGETRAIL (LOW=37294) at toy.p:1224
</span><span class='line'>1224                    if (tt [high] &lt; frozenvars) or (tt [high] > frozenheap)</span></code></pre></td></tr></table></div></figure>


<p>It seems <em>purgetail</em> procedure is at fault.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">purgetrail</span> <span class="p">(</span> <span class="nb">low</span> <span class="o">:</span> <span class="n">ttx</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* remove unnecessary trail entries at and above low , either after</span>
</span><span class='line'><span class="cm">   a successful unifyordont call or after popping backtrack-points in</span>
</span><span class='line'><span class="cm">   a non-backtracking context ( unfreeze ). this is necessary, as</span>
</span><span class='line'><span class="cm">   unfrozen vars might be moved or destroyed - it also saves trail space. *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">high</span> <span class="o">:</span> <span class="n">ttx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="k">for</span> <span class="nb">high</span><span class="o">:=</span> <span class="nb">low</span> <span class="k">to</span> <span class="n">ttop</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">frozenvars</span><span class="p">)</span> <span class="k">or</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frozenheap</span><span class="p">)</span>
</span><span class='line'>                                                                <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>                    <span class="n">tt</span> <span class="p">[</span> <span class="nb">low</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">tt</span> <span class="p">[</span> <span class="nb">high</span> <span class="p">]</span><span class="o">;</span>   <span class="nb">low</span><span class="o">:=</span> <span class="nb">low</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>            <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="n">ttop</span><span class="o">:=</span> <span class="nb">low</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmm, it&rsquo;s starts from <em>low</em> and goes till <em>ttop-1</em> to remove unused trail entries from array.
Let&rsquo;s add some <em>writeln</em> output of <em>low</em> and <em>ttop</em> values to see what makes it really crash.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">purgetrail</span> <span class="p">(</span> <span class="nb">low</span> <span class="o">:</span> <span class="n">ttx</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* remove unnecessary trail entries at and above low , either after</span>
</span><span class='line'><span class="cm">   a successful unifyordont call or after popping backtrack-points in</span>
</span><span class='line'><span class="cm">   a non-backtracking context ( unfreeze ). this is necessary, as</span>
</span><span class='line'><span class="cm">   unfrozen vars might be moved or destroyed - it also saves trail space. *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">high</span> <span class="o">:</span> <span class="n">ttx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>        <span class="nb">writeln</span><span class="p">(</span><span class="s">&#39;low = &#39;</span><span class="o">,</span><span class="nb">low</span><span class="o">,</span><span class="s">&#39; ttop = &#39;</span><span class="o">,</span> <span class="n">ttop</span><span class="p">)</span><span class="o">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="nb">high</span><span class="o">:=</span> <span class="nb">low</span> <span class="k">to</span> <span class="n">ttop</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">frozenvars</span><span class="p">)</span> <span class="k">or</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frozenheap</span><span class="p">)</span>
</span><span class='line'>                                                                    <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>                        <span class="n">tt</span> <span class="p">[</span> <span class="nb">low</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">tt</span> <span class="p">[</span> <span class="nb">high</span> <span class="p">]</span><span class="o">;</span>   <span class="nb">low</span><span class="o">:=</span> <span class="nb">low</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">end</span><span class="o">;</span>
</span><span class='line'>        <span class="n">ttop</span><span class="o">:=</span> <span class="nb">low</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run <em>toy</em> again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash$ ./toy
</span><span class='line'>Toy-Prolog listening:
</span><span class='line'>?- a.
</span><span class='line'>low = 1 ttop = 3
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 3
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 4
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 1
</span><span class='line'>low = 0 ttop = 0
</span><span class='line'>Segmentation fault</span></code></pre></td></tr></table></div></figure>


<p>It crashes when both values are 0&rsquo;s. Hmm it seems we don&rsquo;t need to iterate anything unless low &lt; ttop,
Since the trail array is empty, so let&rsquo;s add this fix into <em>purgetrail</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='pascal'><span class='line'><span class="k">procedure</span> <span class="nf">purgetrail</span> <span class="p">(</span> <span class="nb">low</span> <span class="o">:</span> <span class="n">ttx</span> <span class="p">)</span><span class="o">;</span>
</span><span class='line'><span class="cm">(* remove unnecessary trail entries at and above low , either after</span>
</span><span class='line'><span class="cm">   a successful unifyordont call or after popping backtrack-points in</span>
</span><span class='line'><span class="cm">   a non-backtracking context ( unfreeze ). this is necessary, as</span>
</span><span class='line'><span class="cm">   unfrozen vars might be moved or destroyed - it also saves trail space. *)</span>
</span><span class='line'><span class="k">var</span>   <span class="nb">high</span> <span class="o">:</span> <span class="n">ttx</span><span class="o">;</span>
</span><span class='line'><span class="k">begin</span>   <span class="k">if</span> <span class="nb">low</span> <span class="o">&lt;</span> <span class="n">ttop</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">for</span> <span class="nb">high</span><span class="o">:=</span> <span class="nb">low</span> <span class="k">to</span> <span class="n">ttop</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">frozenvars</span><span class="p">)</span> <span class="k">or</span> <span class="p">(</span><span class="n">tt</span> <span class="p">[</span><span class="nb">high</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frozenheap</span><span class="p">)</span>
</span><span class='line'>                                  <span class="k">then</span> <span class="k">begin</span>
</span><span class='line'>          <span class="n">tt</span> <span class="p">[</span> <span class="nb">low</span> <span class="p">]</span> <span class="o">:=</span>  <span class="n">tt</span> <span class="p">[</span> <span class="nb">high</span> <span class="p">]</span><span class="o">;</span>   <span class="nb">low</span><span class="o">:=</span> <span class="nb">low</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span><span class="o">;</span>
</span><span class='line'>  <span class="n">ttop</span><span class="o">:=</span> <span class="nb">low</span>
</span><span class='line'><span class="k">end</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run <em>make</em> and then run <em>toy</em> interpreter again</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash$ ./toy
</span><span class='line'>Toy-Prolog listening:
</span><span class='line'>?- display('Hello World!'), nl.
</span><span class='line'>Hello World!
</span><span class='line'>yes</span></code></pre></td></tr></table></div></figure>


<p>And we did it! It works :) It might have some other bugs since it&rsquo;s an old software but I haven&rsquo;t encountered any more yet.
I&rsquo;ve also ported <em>btoy.p</em> the same way stumbling upon same kind of errors and same <em>purgetrail</em> bug.</p>

<p><img src="http://i.imgur.com/NX5NdN5.png" alt="Hyouka" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Processing &amp; Broadcasting Financial Data in Scheme]]></title>
    <link href="http://troydm.github.io/blog/2013/09/04/processing-and-broadcasting-financial-data-in-scheme/"/>
    <updated>2013-09-04T21:44:00+04:00</updated>
    <id>http://troydm.github.io/blog/2013/09/04/processing-and-broadcasting-financial-data-in-scheme</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing data collecter, processor and broadcaster in Scheme</em></p>

<p>Any software developer who worked in financial industry will tell you that there are
few key requirements to programming applications for real time market. Applications should be as fast as possible and
they should be as easily modifiable as possible. First requirement is essential since getting and processing information
takes time and sending processed information takes even additional precious time, and in financial world time equals money.
Second requirement is determined by constantly changing business rules imposed on data processing.</p>

<p><img src="http://i.imgur.com/OErpvNu.png" alt="(eq? 'money 'power)" /></p>

<!-- more -->


<p>Correctly choosing programming language for such applications is key to success. Since first requirement already suggests using languages
that produce native binary executables we might start thinking to use popular languages such as <strong>C</strong>, <strong>C++</strong>. However developing networked applications
in <strong>C</strong> or <strong>C++</strong> takes more time than in languages such as <strong>Java</strong> or <strong>C#</strong>, and applications developed aren&rsquo;t as easy modifiable as it may seem, so these languages
don&rsquo;t comply with our second requirement. What alternatives do we have? Since it&rsquo;s financial world and we want our applications to be absolutely correct, we might
want to choose functional programming language and benefit of their advantages. So we have a choice between popular functional programming languages
<strong>Haskell</strong>, <strong>OCaml</strong> and <strong>Scheme</strong>. <strong>OCaml</strong> is well known to
be used by a big financial company <a href="http://janestreet.com/">Janestreet</a> and is a really good choice, it has <strong>ML</strong> like syntax which is really easy to get used to.
<strong>Haskell</strong> is extremely popular however it&rsquo;s laziness implies some overcomplicated
programming and some performance penalties we don&rsquo;t want to have. <strong>Scheme</strong> is very simple language with <strong>Lisp</strong>-like syntax that is very easy to start programming with and it&rsquo;s programs
are very easily modifiable. <strong>Scheme</strong> has many implementations that have it&rsquo;s own libraries and it&rsquo;s own pros and cons. <strong>Scheme</strong>&rsquo;s only downside is that it&rsquo;s not statically typed so it doesn&rsquo;t catches some obvious
compile-time errors, but as long as our application works fine everything is ok! Further on let&rsquo;s consider that we&rsquo;ve chosen <strong>Scheme</strong> as our language. Other languages have it&rsquo;s own benefits but for our
needs it&rsquo;s the most suited choice, since we want to start developing as fast as possible. Since we want to produce native binary executables we&rsquo;ll limit our choice
on <a href="http://www.call-cc.org/">Chicken Scheme</a> which produces very efficient binary applications and is very popular.</p>

<p>So let&rsquo;s consider our hypothetical but very common situation where we want to quickly develop an application that gets a stream of some data (let&rsquo;s imagine it&rsquo;s a real time financial market data)
that we can get by connecting to some arbitrary tcp host:port. The data that we&rsquo;ll get will be parsed, processed and will be broadcasted to all clients that will connect to our small application
using tcp protocol. So we need to develop some small tcp client and broadcasting server black box.</p>

<p><img src="http://i.imgur.com/T4gMsTT.png" alt="black box" /></p>

<p><a href="http://www.call-cc.org/">Chicken Scheme</a> has a system called <a href="http://wiki.call-cc.org/chicken-projects/egg-index-4.html">Eggs</a> which is a common way to distribute community extensions.
We&rsquo;ll be using two extensions to ease our task of developing our application. One is called <a href="http://wiki.call-cc.org/eggref/4/synch">synch</a> which is a set of some useful functions to
work with concurrent code in <a href="http://www.call-cc.org/">Chicken Scheme</a>. The other one we&rsquo;ll be using is called <a href="http://wiki.call-cc.org/eggref/4/mailbox-threads">mailbox-threads</a> which
is a convenient <strong>Erlang</strong>-like message passing framework. So let&rsquo;s install those extension by typing following in our console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chicken-install synch
</span><span class='line'>chicken-install mailbox-threads
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s start writing our application. Create a file called <em>myapp.scm</em>. First thing we need to do is load our extensions.
Also we&rsquo;ll be using some functions from <a href="http://srfi.schemers.org/srfi-18/srfi-18.html">srfi-18</a> and <a href="http://srfi.schemers.org/srfi-1/srfi-1.html">srfi-1</a>
for multi threading and some convenient list data manipulations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="nf">require-extension</span> <span class="nv">tcp</span> <span class="nv">posix</span> <span class="nv">synch</span> <span class="nv">mailbox-threads</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require-extension</span> <span class="p">(</span><span class="nf">only</span> <span class="nv">srfi-18</span> <span class="nv">make-mutex</span> <span class="nv">make-thread</span> <span class="nv">thread-start!</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">require-extension</span> <span class="p">(</span><span class="nf">only</span> <span class="nv">srfi-1</span> <span class="nv">delete</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we need a way to get our data and process it. We&rsquo;ll be using functions <em>tcp-connect</em> and <em>read-line</em> to connect to our host and read data line by line.
Also we&rsquo;ll define some arbitrary processing function that will not do any processing and just broadcast data. I don&rsquo;t want to talk about processing in this post but rather focus
on getting data and distributing it, so in the end we&rsquo;ll have just a simple tcp duplicator example in <strong>Scheme</strong>. But you can do any kind of data processing by modifying
<em>process-data</em> function.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">connect-to-host</span> <span class="s">&quot;host&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">connect-to-port</span> <span class="mi">1234</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">start-data-feeder</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">handle-exceptions</span> <span class="nv">ex</span>
</span><span class='line'>            <span class="p">(</span><span class="k">begin </span><span class="p">(</span><span class="nf">print</span> <span class="s">&quot;error occurred while connecting, trying to reconnect&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">sleep</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">in</span> <span class="p">(</span><span class="nf">tcp-connect</span> <span class="nv">connect-to-host</span> <span class="nv">connect-to-port</span><span class="p">)))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">get-data</span> <span class="nv">in</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">start-data-feeder</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">get-data</span> <span class="nv">in</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">process-data</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">in</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">get-data</span> <span class="nv">in</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">process-data</span> <span class="nv">data</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">broadcast</span> <span class="nv">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we have our data gathering and processing ready, now we need to start a tcp server and broadcast data to all clients.
We&rsquo;ll be using <em>mailboxes</em> list that will contain each client&rsquo;s mailbox and we&rsquo;ll have a separate mutex to make sure operations
on <em>mailboxes</em> list are thread-safe.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">mtx</span> <span class="p">(</span><span class="nf">make-mutex</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">mailboxes</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">broadcast</span> <span class="nv">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">synch</span> <span class="nv">mtx</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">mailbox</span><span class="p">)</span> <span class="p">(</span><span class="nf">thread-send</span> <span class="nv">mailbox</span> <span class="nv">data</span><span class="p">))</span> <span class="nv">mailboxes</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s write our tcp broadcasting server. Each connected client will have a his mailbox added to <em>mailboxes</em> list.
When client will disconnect, his mailbox will be deleted from <em>mailboxes</em> list. We&rsquo;ll use <em>tcp-listen</em> and <em>tcp-accept</em> functions to
listen on port and accept connections on listener. Each client will be processed by separate thread.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">broadcast-on-port</span> <span class="mi">4321</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">start-broadcasting</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">accept-client</span> <span class="p">(</span><span class="nf">tcp-listen</span> <span class="nv">broadcast-on-port</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">accept-client</span> <span class="nv">listener</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">let-values</span> <span class="p">([(</span><span class="nf">in</span> <span class="nv">out</span><span class="p">)</span> <span class="p">(</span><span class="nf">tcp-accept</span> <span class="nv">listener</span><span class="p">)])</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">thread-start!</span> <span class="p">(</span><span class="nf">make-thread</span>
</span><span class='line'>            <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">handle-exceptions</span> <span class="nv">ex</span>
</span><span class='line'>                        <span class="p">(</span><span class="nf">synch</span> <span class="nv">mtx</span> <span class="p">(</span><span class="k">set! </span><span class="nv">mailboxes</span> <span class="p">(</span><span class="nf">delete</span> <span class="p">(</span><span class="nf">current-thread</span><span class="p">)</span> <span class="nv">mailboxes</span><span class="p">)))</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">synch</span> <span class="nv">mtx</span> <span class="p">(</span><span class="k">set! </span><span class="nv">mailboxes</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">current-thread</span><span class="p">)</span> <span class="nv">mailboxes</span><span class="p">)))</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">process-client</span> <span class="nv">in</span> <span class="nv">out</span><span class="p">))</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">close-output-port </span><span class="nv">out</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">close-input-port </span><span class="nv">in</span><span class="p">)))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">accept-client</span> <span class="nv">listener</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">process-client</span> <span class="nv">in</span> <span class="nv">out</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">write-line</span> <span class="p">(</span><span class="nf">thread-receive</span><span class="p">)</span> <span class="nv">out</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">process-client</span> <span class="nv">in</span> <span class="nv">out</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now only thing left is to start our broadcasting server in separate thread and start feeding it data</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="nf">thread-start!</span> <span class="p">(</span><span class="nf">make-thread</span> <span class="nv">start-broadcasting</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">start-data-feeder</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty neat and simple, isn&rsquo;t it :)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Writing IRC Bot using Perl 5 and POCO::IRC]]></title>
    <link href="http://troydm.github.io/blog/2013/07/22/writting-irc-bot-using-perl-5-and-poco-irc/"/>
    <updated>2013-07-22T21:29:00+04:00</updated>
    <id>http://troydm.github.io/blog/2013/07/22/writting-irc-bot-using-perl-5-and-poco-irc</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Writing IRC bot in Perl</em></p>

<p>Some people use <a href="https://en.wikipedia.org/wiki/Internet_Relay_Chat">IRC</a> to chat, some don&rsquo;t.
It was invented a really long time ago and isn&rsquo;t going away anytime soon despite some new generation alternatives popping up like <a href="http://www.jabber.org/">Jabber</a>.</p>

<p>Personally I always have my IRC client running (I&rsquo;m using <a href="http://weechat.org/">weechat</a> + <a href="http://tmux.sourceforge.net/">tmux</a>) and chat with lots of interesting people
who inspire me to try new technologies and learn something different every day. One person, who&rsquo;s nickname I won&rsquo;t name, was always telling me about how awesome <a href="http://perl.org/" title="Perl">Perl</a>
as a programming language is and how great it&rsquo;s potential is thanks to <a href="http://cpan.org" title="CPAN">CPAN</a> that has almost 124k modules for any life situation.
I always thought he was exaggerating and literally acting like a <a href="http://perl.org/" title="Perl">Perl</a> fanboy. <a href="http://perl.org/" title="Perl">Perl</a> was the first programming language I&rsquo;ve learned back in the late 90&rsquo;s
and remembering how frustrating my experience with it was and how cryptic it really was for me do something with it when I was unexperienced and lacked lots of qualities that make up a
any decent software engineer I was skeptic about using it again.
Well, time passed, time always passes, and I haven&rsquo;t written anything more than quick 50 line server scripts in <a href="http://perl.org/" title="Perl">Perl</a> for almost 13 years.
I&rsquo;ve almost forgotten everything about <a href="http://perl.org/" title="Perl">Perl</a>. Since lately I was having this crazy idea about writing IRC bot that could store and execute shell scripts on server
so I could automate my servers through IRC, I thought why not write it in <a href="http://perl.org/" title="Perl">Perl</a>. I&rsquo;ve remembered that person who was always bragging about <a href="http://perl.org/" title="Perl">Perl</a>&rsquo;s greatness wrote an IRC bot in <a href="http://perl.org/" title="Perl">Perl</a>
using <a href="https://metacpan.org/module/POE::Component::IRC" title="POCO::IRC">POE::Component::IRC</a> so I&rsquo;ve decided to try and use the same framework for my bot. It&rsquo;s based on really popular <a href="https://metacpan.org/module/POE" title="POE">POE</a> event loop framework which is very easy to learn and use.
<strong>Matt Cashner</strong> wrote a really good introduction article called <a href="http://www.perl.com/pub/2004/07/02/poeintro.html">Application Design with POE</a></p>

<!-- more -->


<p>The whole code for my bot is just 500 lines and is available from this repository <a href="https://github.com/troydm/shellbot">shellbot</a>.
I&rsquo;m going to walk through a key concepts that are essential for writing an IRC bot in <a href="https://metacpan.org/module/POE::Component::IRC" title="POCO::IRC">POCO::IRC</a> using my bot&rsquo;s source code as a reference.</p>

<p><img src="http://i.imgur.com/kiqhDBH.jpg" alt="Chobits" /></p>

<p>Before we&rsquo;ll start our <a href="http://perl.org/" title="Perl">Perl</a> IRC bot we need some way to store configuration for it. Since <a href="http://cpan.org" title="CPAN">CPAN</a> has lots of modules that deal with configuration the choice wasn&rsquo;t an easy one but
I&rsquo;ve decided to use <a href="https://metacpan.org/module/YAML">YAML</a> which is module for loading <a href="http://yaml.org" title="YAML">YAML</a> data into <a href="http://perl.org/" title="Perl">Perl</a> that can work the other way too. <a href="http://yaml.org" title="YAML">YAML</a> is a simple markup language
that is perfect for storing configuration and it&rsquo;s really quick to learn. For loading YAML configuration I&rsquo;ve used <strong>LoadFile</strong> function and to store <a href="http://perl.org/" title="Perl">Perl</a> data back into file I&rsquo;ve used <strong>DumpFile</strong> function.
Just two simple functions that do all the complex work work for me. Since I wanted to store commands in the same file I just used <a href="http://perl.org/" title="Perl">Perl</a>&rsquo;s list construct to specify that I&rsquo;m loading two separate <a href="http://yaml.org" title="YAML">YAML</a> documents.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># Loading configuration </span>
</span><span class='line'><span class="k">my</span> <span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$commands</span><span class="p">)</span> <span class="o">=</span> <span class="n">LoadFile</span><span class="p">(</span><span class="nv">$config_file</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Storing configuration</span>
</span><span class='line'><span class="n">DumpFile</span><span class="p">(</span><span class="nv">$config_file</span><span class="p">,</span> <span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$commands</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next step is to create POE Session and start event loop. Note that since my module is named Shellbot I need to specify it otherwise event loop won&rsquo;t be able to call functions.
Each of this functions are called by <a href="https://metacpan.org/module/POE" title="POE">POE</a> when specified events occur and all the bot logic is handled by those functions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nn">POE::</span><span class="n">Session</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>    <span class="n">package_states</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span><span class='line'>        <span class="n">Shellbot</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="sx">qw(_start _default irc_join irc_msg irc_bot_addressed irc_connected </span>
</span><span class='line'><span class="sx">                         got_job_stdout got_job_stderr got_job_close got_child_signal)</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nn">POE::</span><span class="n">Kernel</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>First event that is executed after the POE event loop starts is <strong>_start</strong> event so we need to initialize bot
state in that event. Also since <a href="https://metacpan.org/module/POE::Component::IRC" title="POCO::IRC">POCO::IRC</a> comes with some essential plugins and is modular by itself we can take advantage of this.
Instead of manually making bot reconnect when it looses connection with server I&rsquo;ve used <a href="https://metacpan.org/module/POE::Component::IRC::Plugin::Connector">Connector</a> plugin.
If we want our bot to automatically join some channel we can use <a href="https://metacpan.org/module/POE::Component::IRC::Plugin::AutoJoin">AutoJoin</a> plugin.
And to easily handle when someone addresses bot I&rsquo;ve used <a href="https://metacpan.org/module/POE::Component::IRC::Plugin::BotAddressed">BotAddressed</a> plugin.
Since I wanted my bot to handle commands I could have used <a href="https://metacpan.org/module/POE::Component::IRC::Plugin::BotCommand">BotCommand</a> plugin however I wanted my bot
to have two modes of commands so I&rsquo;ve decided to write bot command handling functions manually.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$irc</span> <span class="o">=</span> <span class="nn">POE::Component::IRC::</span><span class="n">State</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">(</span><span class="nv">%opts</span><span class="p">);</span>
</span><span class='line'><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">irc</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$irc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Connector plugin</span>
</span><span class='line'><span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">connector</span><span class="p">}</span> <span class="o">=</span> <span class="nn">POE::Component::IRC::Plugin::</span><span class="n">Connector</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
</span><span class='line'><span class="nv">$irc</span><span class="o">-&gt;</span><span class="n">plugin_add</span><span class="p">(</span> <span class="s">&#39;Connector&#39;</span> <span class="o">=&gt;</span> <span class="nv">$heap</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">connector</span><span class="p">}</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Autojoin plugin</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;channels&#39;</span><span class="p">})</span> <span class="o">&amp;&amp;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;channels&#39;</span><span class="p">}</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>    <span class="nv">$irc</span><span class="o">-&gt;</span><span class="n">plugin_add</span><span class="p">(</span><span class="s">&#39;AutoJoin&#39;</span><span class="p">,</span> <span class="nn">POE::Component::IRC::Plugin::</span><span class="n">AutoJoin</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
</span><span class='line'>       <span class="n">Channels</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;channels&#39;</span><span class="p">}</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># BotAddressed plugin</span>
</span><span class='line'><span class="nv">$irc</span><span class="o">-&gt;</span><span class="n">plugin_add</span><span class="p">(</span> <span class="s">&#39;BotAddressed&#39;</span><span class="p">,</span> <span class="nn">POE::Component::IRC::Plugin::</span><span class="n">BotAddressed</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">()</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$irc</span><span class="o">-&gt;</span><span class="n">yield</span><span class="p">(</span><span class="n">register</span> <span class="o">=&gt;</span> <span class="sx">qw(join msg connected)</span><span class="p">);</span>
</span><span class='line'><span class="nv">$irc</span><span class="o">-&gt;</span><span class="n">yield</span><span class="p">(</span><span class="s">&#39;connect&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since bot can be addressed both using a private message and refering him on a channel i&rsquo;ve decided to handle
both <strong>irc_msg</strong> and <strong>irc_bot_addressed</strong> events uniformly in <strong>msg_received</strong> function</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">sub </span><span class="nf">irc_msg</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$irc</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SENDER</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_heap</span><span class="p">();</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">@nick</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">split</span> <span class="sr">/!/</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">ARG2</span><span class="p">];</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$heap</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">];</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$kernel</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">KERNEL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">msg_received</span> <span class="nv">$irc</span><span class="p">,</span> <span class="nv">$heap</span><span class="p">,</span> <span class="nv">$kernel</span><span class="p">,</span> <span class="nv">$nick</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$nick</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">irc_bot_addressed</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$irc</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">SENDER</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_heap</span><span class="p">();</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">@nick</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">split</span> <span class="sr">/!/</span><span class="p">,</span> <span class="nv">$_</span><span class="p">[</span><span class="n">ARG0</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">ARG1</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">ARG2</span><span class="p">];</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$heap</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">HEAP</span><span class="p">];</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$kernel</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="n">KERNEL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">msg_received</span> <span class="nv">$irc</span><span class="p">,</span> <span class="nv">$heap</span><span class="p">,</span> <span class="nv">$kernel</span><span class="p">,</span> <span class="nv">$nick</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$nick</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$channel</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before bot accepts a command we need some way to check if person who is issuing a command is authorized to do so. I&rsquo;m doing a simple check of full IRC name
that can be specified in configuration list option <strong>authorizations</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">sub </span><span class="nf">is_authorized</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">grep</span> <span class="p">{</span> <span class="nv">$_</span> <span class="ow">eq</span> <span class="nv">$name</span> <span class="p">}</span> <span class="nv">@</span><span class="p">{</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;authorizations&#39;</span><span class="p">}</span> <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All that is left is to match commands in <strong>msg_recieved</strong> using <a href="http://perl.org/" title="Perl">Perl</a>&rsquo;s <a href="http://perldoc.perl.org/perlre.html">regex</a>. This part is just a long series of bot command logic
and <strong>if</strong> <strong>elsif</strong> <strong>else</strong> statements so I won&rsquo;t reference them here. Also the key function is <strong>run_job</strong> which executes pre-stored shell script. It creates a temporary file that
is executed using a shell</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$program</span> <span class="o">=</span> <span class="s">&quot;/bin/bash&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">exists</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;shell&#39;</span><span class="p">})){</span>
</span><span class='line'>    <span class="nv">$program</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;shell&#39;</span><span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create a temporary script</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$script</span> <span class="o">=</span> <span class="nn">File::</span><span class="n">Temp</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
</span><span class='line'><span class="k">my</span> <span class="nv">$scriptname</span> <span class="o">=</span> <span class="nv">$script</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
</span><span class='line'><span class="nb">chmod</span> <span class="mo">0700</span><span class="p">,</span> <span class="nv">$script</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">ref</span> <span class="nv">$cmd</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span><span class="p">){</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$line</span> <span class="p">(</span><span class="nv">@</span><span class="p">{</span> <span class="nv">$cmd</span> <span class="p">}){</span>
</span><span class='line'>        <span class="k">print</span> <span class="nv">$script</span> <span class="s">&quot;$line\n&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="nv">$script</span> <span class="nv">$cmd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$program</span> <span class="o">.=</span> <span class="s">&quot; $scriptname $args&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Shell execution is handled by <a href="https://metacpan.org/module/POE::Component::IRC" title="POCO::IRC">POE</a> using <a href="https://metacpan.org/module/POE::Wheel::Run">POE::Wheel::Run</a>
and output from shell is received on <strong>got_job_stdout</strong> and <strong>got_job_stderr</strong> functions</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$job</span> <span class="o">=</span> <span class="nn">POE::Wheel::</span><span class="n">Run</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Program</span>      <span class="o">=&gt;</span> <span class="nv">$program</span><span class="p">,</span>
</span><span class='line'>    <span class="n">StdioFilter</span>  <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Line</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">StderrFilter</span> <span class="o">=&gt;</span> <span class="nn">POE::Filter::</span><span class="n">Line</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">StdoutEvent</span>  <span class="o">=&gt;</span> <span class="s">&quot;got_job_stdout&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">StderrEvent</span>  <span class="o">=&gt;</span> <span class="s">&quot;got_job_stderr&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">CloseEvent</span>   <span class="o">=&gt;</span> <span class="s">&quot;got_job_close&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all there is to it. To install and trying it out just look through a <a href="https://github.com/troydm/shellbot/blob/master/README.md">readme</a></p>

<p>Offcourse making a temporary shell script and executing it is generally unsafe. Also there is security concern
that bot can be somehow hacked and commanded by unauthorized nick but I&rsquo;m not sure how can this be done without changing vhost.
That is why I called this bot a potentially unsafe. If anyone can find any security holes please do pull request or just email me patch.</p>

<p>To make this bot little more secure we need to make him connect to IRC using SSL. For this I&rsquo;ll walk through a general steps for configuring
<a href="https://www.freenode.net/certfp/">CertFP</a> and generating self signed certificate for <a href="https://www.freenode.net/">Freenode</a> as an example.
First step is to register your bot&rsquo;s nick with <a href="https://blog.freenode.net/2007/03/nickserv-is-your-friend/">NickServ</a>.
Choose a nickname for your bot and start it up. Ask your bot to register with NickServ by private messaging him on IRC.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/msg botnick msg NickServ REGISTER nickservpass email@address.com</span></code></pre></td></tr></table></div></figure>


<p>Shortly you&rsquo;ll receive an email verification that will include verification code, privately message your bot again to verify your registration</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/msg botnick msg NickServ VERIFY REGISTER botnick verificationcode</span></code></pre></td></tr></table></div></figure>


<p>Now your bot&rsquo;s nick is registered with NickServ so edit your configuration file and uncomment nickserv line to specify your nickservpass that will
be used each time your bot will connect to server for authorization of your nick</p>

<p>Now we&rsquo;ll generate a self signed certificate for SSL, i&rsquo;ve used <a href="https://www.freenode.net/certfp/makecert.shtml">this</a> manual for reference.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>umask 077
</span><span class='line'>openssl req -newkey rsa:2048 -days 730 -x509 -keyout botnick.key -out botnick.crt</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll be asked some questions and after that openssl will generate two files, your bot&rsquo;s certificate and key.
For CertFP to work we need a fingerprint of your key and certificate</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat botnick.crt botnick.key > botnick.pem
</span><span class='line'>openssl x509 -sha1 -noout -fingerprint -in botnick.pem | sed -e 's/^.*=//;s/://g;y/ABCDEF/abcdef/'</span></code></pre></td></tr></table></div></figure>


<p>After this you&rsquo;ll get a fingerprint that you need to add to NickServ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/msg botnick msg NickServ CERT ADD fingerprint</span></code></pre></td></tr></table></div></figure>


<p>Now all that is left is to specify in configuration that we are connecting using SSL certificate and key.
Just uncomment <strong>sslcrt</strong> and <strong>sslkey</strong> options and specify full path to your bot&rsquo;s certificate and key.
Also don&rsquo;t forget to change the port since we need to specify an SSL port instead of usual one, just specify
<strong>6697</strong>, <strong>7000</strong> or <strong>7070</strong> and restart your bot to enjoy fully secured connection to irc server.
Also i&rsquo;ve used <a href="https://metacpan.org/module/DETI/Proc-Daemon-0.14/lib/Proc/Daemon.pod">Proc::Daemon</a> for running this bot
as daemon so you can uncomment <strong>daemon</strong> and <strong>log</strong> options to run it as daemon process.</p>

<p>So what did i learned from writing this small irc bot in <a href="http://perl.org/" title="Perl">Perl</a>?
Now the first most common mistake i was always making when coding in <a href="http://perl.org/" title="Perl">Perl</a> was the difference between list and array, so
I recommend this article by <strong>Mike Friedman</strong> <a href="http://friedo.com/blog/2013/07/arrays-vs-lists-in-perl">Arrays vs. Lists in Perl</a>
that helped me a lot. Also dereferncing was the second most common mistake i had, until i&rsquo;ve read this article
<a href="http://perlmeme.org/howtos/using_perl/dereferencing.html">Dereferencing in Perl</a>. But the biggest thing i&rsquo;ve learned was that <a href="http://perl.org/" title="Perl">Perl</a>
as a scripting language is really easy to use and powerfull despite some people claiming it&rsquo;s dead, it&rsquo;s still alive and it&rsquo;s doing
just <a href="http://www.nntp.perl.org/group/perl.perl5.porters/2013/07/msg204905.html">fine</a>!
Just look how many modules are released on <a href="http://cpan.org" title="CPAN">CPAN</a> everyday! And it&rsquo;s really really fun to code in, so everyone should try learning and using it!!!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hosting your own remote private torrent tracker]]></title>
    <link href="http://troydm.github.io/blog/2013/04/24/hosting-your-own-remote-private-torrent-tracker/"/>
    <updated>2013-04-24T22:05:00+04:00</updated>
    <id>http://troydm.github.io/blog/2013/04/24/hosting-your-own-remote-private-torrent-tracker</id>
    <content type="html"><![CDATA[<p>TL;DR <em>Modifying BitTorrent Tracker written in C++</em></p>

<p>Ever wanted to share a really big file (more than 4 GB) with someone without a hassle of uploading it to some file upload server?</p>

<p><a href="http://bittorrent.org/">BitTorrent</a> to rescue, also there are alternatives like hosting your own ftp/sftp file server but I won&rsquo;t consider them here!
So you probably already have a dedicated home file server running on Linux/BSD/Solaris that also has a torrent client installed on it that you access through web interface?</p>

<p>Oh you don&rsquo;t? Snap it&rsquo;s it&rsquo;s so useful that nowadays almost everyone has some kind of NAS that he/she is using for file storage and torrents.
So if you don&rsquo;t have one then you are behind of times</p>

<p>So what do we need to share some file over torrent? Yes indeed we need a torrent tracker</p>

<!-- more -->


<p><a href="http://thepiratebay.se"><img src="https://thepiratebay.se/static/img/tpb.jpg" alt="The Pirate Bay" /></a></p>

<p>You probably heard of the famous pirate bay arrr!&hellip; haven&rsquo;t you?
Well pirate bay has a torrent tracker and you don&rsquo;t. So you either have a choice and become a pirate bay resident and upload your torrent on their site
or you can host your own little pirate bay just for you and your friends only</p>

<p>Most torrent clients include torrent tracker functionality out of the box but let&rsquo;s consider our little case were we a have headless home server with torrent client
that has only web interface and no torrent tracker
So what do we do? We run our own standalone torrent tracker!</p>

<p>So that&rsquo;s how I&rsquo;ve ended on <a href="http://en.wikipedia.org/wiki/Comparison_of_BitTorrent_tracker_software">this page</a></p>

<p>My first choice was <a href="https://erdgeist.org/arts/software/opentracker/">opentracker</a> which is a very popular tracker that even pirate bay uses on their servers.
First thing I did I&rsquo;ve compiled and configured it in few mins and had it running on my <strong>6969</strong> port.
So the next thing I&rsquo;ve created a torrent with my torrent tracker announce url specified as **<a href="http://192.168.0.x:6969/announce**">http://192.168.0.x:6969/announce**</a> using <a href="http://mktorrent.sourceforge.net/">mktorrent</a>
and added it to my torrent client which started seeding it right away. The next step I&rsquo;ve created the same torrent file with announce url changed to my external ip and sent it to my friend!
My friend started his torrent client and added the torrent. He could see that it had one seeder but still couldn&rsquo;t download the file. Simple troubleshooting revealed that my torrent tracker
was listing my seeder peer with a local network ip address that my friend&rsquo;s torrent client couldn&rsquo;t connect to&hellip;</p>

<p><img src="http://i.imgur.com/TCYjoCe.jpg" alt="Crying Loli" /></p>

<p>I knew now what I needed from torrent tracker. My port was the same but my ip address should be external instead of internal.
I needed local ip substituted with remote ip for all external network peers. The peer port would remain the same since i have the same port forwarded.</p>

<p>Unfortunately I couldn&rsquo;t find any functionality in <a href="https://erdgeist.org/arts/software/opentracker/">opentracker</a> that would do that :(</p>

<p>So next thing I did I&rsquo;ve downloaded <a href="https://code.google.com/p/udpt/">udpt</a> and had it compiled.
It uses <a href="http://www.bittorrent.org/beps/bep_0015.html">udp tracker protocol</a> which is much more
network efficient. <a href="https://code.google.com/p/udpt/">udpt</a> is much more smaller than <a href="https://erdgeist.org/arts/software/opentracker/">opentracker</a>
in both source code and functionality and thus was ideal to experiment with.</p>

<p>Adding the needed functionality didn&rsquo;t solved my problem because udpt had some other bugs that I had to track down but in a few hours i had everything up and working!
In the end I had a fully working private torrent tracker that was doing what I was hoping for.
I&rsquo;ve even added code to run it as linux daemon thanks to <a href="http://www.netzmafia.de/skripten/unix/linux-daemon-howto.html">this little howto</a></p>

<p>My experimental fork is at <a href="https://github.com/troydm/udpt">this repository</a></p>

<p><img src="http://i.imgur.com/M6W7RfM.png" alt="Pirate Loli" /></p>

<p>Happy torrenting pirates!</p>
]]></content>
  </entry>
  
</feed>
